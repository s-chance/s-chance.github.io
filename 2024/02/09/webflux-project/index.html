<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="keywords" content="linuxer developer learner"><meta name="author" content="Entropy"><link rel="stylesheet" href="/css/katex.min.css" integrity="sha384-mXD7x5S50Ko38scHSnD4egvoExgMPbrseZorkbE49evAfv9nNcbrXJ8LLNsDgh9d" crossorigin="anonymous"><script defer src="/css/katex.min.js" integrity="sha384-j/ZricySXBnNMJy9meJCtyXTKMhIJ42heyr7oAdxTDBy/CYA9hzpMo+YTNV5C+1X" crossorigin="anonymous"></script><script defer src="/css/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous" onload="renderMathInElement(document.body)"></script><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="canonical" href="https://www.entropy-tree.top/2024/02/09/webflux-project/"><meta name="robots" content="index,follow"><meta name="googlebot" content="index,follow"><meta name="revisit-after" content="1 days"><meta name="description" content="记录首次基于 Spring Webflux 响应式框架的后端项目开发过程中涉及到的一些东西。"><meta property="og:type" content="article"><meta property="og:title" content="webflux-project"><meta property="og:url" content="https://www.entropy-tree.top/2024/02/09/webflux-project/index.html"><meta property="og:site_name" content="树下集熵"><meta property="og:description" content="记录首次基于 Spring Webflux 响应式框架的后端项目开发过程中涉及到的一些东西。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://www.entropy-tree.top/2024/02/09/webflux-project/274001.png"><meta property="article:published_time" content="2024-02-09T08:25:56.000Z"><meta property="article:modified_time" content="2024-02-09T08:25:56.082Z"><meta property="article:author" content="Entropy"><meta property="article:tag" content="Spring Webflux"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://www.entropy-tree.top/2024/02/09/webflux-project/274001.png"><link rel="icon" type="image/png" href="/images/avatar.webp" sizes="192x192"><link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.webp"><meta name="theme-color" content="#A31F34"><link rel="shortcut icon" href="/images/avatar.webp"><title>webflux-project - 树下集熵</title><link rel="stylesheet" href="/fonts/Chillax/chillax.css"><script data-swup-reload-script defer data-domain="entropy-tree.top" src="https://analytics.entropy-tree.top/js/script.js"></script><style>:root{--preloader-background-color:#fff;--preloader-text-color:#000}@media (prefers-color-scheme:dark){:root{--preloader-background-color:#202124;--preloader-text-color:#fff}}@media (prefers-color-scheme:light){:root{--preloader-background-color:#fff;--preloader-text-color:#000}}@media (max-width:600px){.ml13{font-size:2.6rem!important}}.preloader{display:flex;flex-direction:column;gap:1rem;align-items:center;justify-content:center;position:fixed;padding:12px;top:0;right:0;bottom:0;left:0;width:100vw;height:100vh;background-color:var(--preloader-background-color);z-index:1100;transition:opacity .2s ease-in-out}.ml13{font-size:3.2rem;color:var(--preloader-text-color);letter-spacing:-1px;font-weight:500;font-family:Chillax-Variable,sans-serif;text-align:center}.ml13 .word{display:inline-flex;flex-wrap:wrap;white-space:nowrap}.ml13 .letter{display:inline-block;line-height:1em}</style><div class="preloader"><script src="/js/libs/anime.min.js"></script><h1 class="ml13">树下集熵</h1><script>var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });


        anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [100,0],
                translateZ: 0,
                opacity: [0,1],
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i
            }).add({
            targets: '.ml13 .letter',
            translateY: [0,-100],
            opacity: [1,0],
            easing: "easeInExpo",
            duration: 1200,
            delay: (el, i) => 100 + 30 * i
        });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            hidePreloaderAfterTimeout(1000); // Hide after 1000 milliseconds once the window has loaded
        });

        // Backup failsafe: Hide preloader after a maximum of 5000 milliseconds, regardless of the window load event
        hidePreloaderAfterTimeout(5000);

        function hidePreloaderAfterTimeout(delay) {
            setTimeout(function () {
                var preloader = document.querySelector('.preloader');
                preloader.style.opacity = '0';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 200);
            }, delay);
        }</script></div><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/assets/build/styles.css"><link rel="stylesheet" href="/fonts/fonts.css"><link rel="stylesheet" href="/fonts/Satoshi/satoshi.css"><script id="hexo-configurations">window.config={hostname:"www.entropy-tree.top",root:"/",language:"zh-CN",path:"search.xml"},window.theme={articles:{style:{font_size:"16px",line_height:1.5,image_border_radius:"14px",image_alignment:"center",image_caption:!1,link_icon:!0,title_alignment:"left",headings_top_spacing:{h1:"5rem",h2:"4rem",h3:"2.8rem",h4:"2.5rem",h5:"2.2rem",h6:"2rem"}},word_count:{enable:!0,count:!0,min2read:!0},author_label:{enable:!0,auto:!1,list:[]},code_block:{copy:!0,style:"mac",font:{enable:!1,family:null,url:null}},toc:{enable:!0,max_depth:3,number:!1,expand:!0,init_open:!0},copyright:{enable:!0,default:"cc_by_nc_sa"},lazyload:!0,recommendation:{enable:!0,title:"推荐阅读",limit:3,mobile_limit:2,placeholder:"/images/wallhaven-wqery6-light.webp",skip_dirs:[]}},colors:{primary:"#A31F34",secondary:null,default_mode:"light"},global:{fonts:{chinese:{enable:!1,family:null,url:null},english:{enable:!1,family:null,url:null}},content_max_width:"1000px",sidebar_width:"210px",hover:{shadow:!0,scale:!1},scroll_progress:{bar:!0,percentage:!1},website_counter:{url:"https://cn.vercount.one/js",enable:!0,site_pv:!0,site_uv:!0,post_pv:!0},single_page:!0,preloader:!0,open_graph:!0,google_analytics:{enable:!1,id:null}},home_banner:{enable:!0,style:"fixed",image:{light:"/images/wallhaven-wqery6-light.webp",dark:"/images/wallhaven-wqery6-dark.webp"},title:"树下集熵",subtitle:{text:["the truth of life"],hitokoto:{enable:!0,api:"https://v1.hitokoto.cn"},typing_speed:100,backing_speed:80,starting_delay:500,backing_delay:1500,loop:!0,smart_backspace:!0},text_color:{light:"#fff",dark:"#d1d1b6"},text_style:{title_size:"2.8rem",subtitle_size:"1.5rem",line_height:1.2},custom_font:{enable:!1,family:null,url:null},social_links:{enable:!0,style:"default",links:{github:"https://github.com/s-chance",instagram:null,zhihu:null,twitter:"https://twitter.com/entropy_tree",email:"mailto:entropy.tree@outlook.com","stack-overflow":"https://stackoverflow.com/users/19329372/entropy"},qrs:{weixin:null}}},plugins:{feed:{enable:!0},aplayer:{enable:!0,type:"fixed",audios:[{name:"Night Cursing",artist:"牛尾憲輔 (agraph)",url:"/NightCursing.m4a",cover:"/NightCursing.jpg"},{name:"Nightbreak",artist:"void",url:"/Nightbreak.m4a",cover:"/Nightbreak.jpg"},{name:"Counter Attack-Mankind (Sasha Version) (Cover)",artist:"Samuel Kim",url:"/Counter Attack-Mankind (Sasha Version) (Cover).m4a",cover:"/Counter Attack-Mankind (Sasha Version) (Cover).jpg"},{name:"Starry",artist:"花鋏キョウ",url:"/Starry.m4a",cover:"/Starry.jpg"}]},mermaid:{enable:!1,version:"9.3.0"}},version:"2.6.1",navbar:{auto_hide:!0,color:{left:"#f78736",right:"#367df7",transparency:35},width:{home:"1200px",pages:"1000px"},links:{Home:{path:"/",icon:"fa-regular fa-house"},Archives:{path:"/archives/",icon:"fa-regular fa-archive"},About:{icon:"fa-regular fa-user",submenus:{Me:"/about/",Github:"https://github.com/s-chance",RSS:"atom.xml"}},Friends:{path:"/links/",icon:"fa-solid fa-link"}},search:{enable:!0,preload:!0}},page_templates:{friends_column:2,tags_style:"blur"},home:{sidebar:{enable:!0,position:"left",first_item:"menu",announcement:null,show_on_mobile:!0,links:{Archives:{path:"/archives/",icon:"fa-regular fa-archive"},Tags:{path:"/tags/",icon:"fa-regular fa-tags"},Categories:{path:"/categories/",icon:"fa-regular fa-folder"}}},article_date_format:"auto",categories:{enable:!0,limit:3},tags:{enable:!0,limit:3}},footerStart:"2022/8/17 11:45:14"},window.lang_ago={second:"%s 秒前",minute:"%s 分钟前",hour:"%s 小时前",day:"%s 天前",week:"%s 周前",month:"%s 个月前",year:"%s 年前"},window.data={masonry:!1}</script><link rel="stylesheet" href="/fontawesome/fontawesome.min.css"><link rel="stylesheet" href="/fontawesome/brands.min.css"><link rel="stylesheet" href="/fontawesome/solid.min.css"><link rel="stylesheet" href="/fontawesome/regular.min.css"><link rel="stylesheet" href="/fontawesome/sharp-solid.min.css"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="树下集熵" type="application/atom+xml">
</head><body><div class="progress-bar-container"><span class="scroll-progress-bar"></span> <span class="pjax-progress-bar"></span></div><main class="page-container" id="swup"><div class="main-content-container"><div class="main-content-header"><header class="navbar-container px-6 md:px-12"><div class="navbar-content"><div class="left"><a class="logo-title" href="/">树下集熵</a></div><div class="right"><div class="desktop"><ul class="navbar-list"><li class="navbar-item"><a href="/"><i class="fa-regular fa-house fa-fw"></i> 首页</a></li><li class="navbar-item"><a href="/archives/"><i class="fa-regular fa-archive fa-fw"></i> 归档</a></li><li class="navbar-item"><a class="has-dropdown" href="#" onclick="&#34;return" false;&#34;><i class="fa-regular fa-user fa-fw"></i> 关于 <i class="fa-solid fa-chevron-down fa-fw"></i></a><ul class="sub-menu"><li><a href="/about/">ME</a></li><li><a target="_blank" rel="noopener" href="https://github.com/s-chance">GITHUB</a></li><li><a href="/atom.xml">RSS</a></li></ul></li><li class="navbar-item"><a href="/links/"><i class="fa-solid fa-link fa-fw"></i> 友情链接</a></li><li class="navbar-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></li></ul></div><div class="mobile"><div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i></div><div class="icon-item navbar-bar"><div class="navbar-bar-middle"></div></div></div></div></div><div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between"><ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start"><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/"><span>首页 </span><i class="fa-regular fa-house fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/archives/"><span>归档 </span><i class="fa-regular fa-archive fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full"><div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" navbar-data-toggle="submenu-About"><span>关于 </span><i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i></div><div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About"><div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl"><a class="text-third-text-color text-xl" href="/about/">ME</a></div><div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl"><a class="text-third-text-color text-xl" target="_blank" rel="noopener" href="https://github.com/s-chance">GITHUB</a></div><div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl"><a class="text-third-text-color text-xl" href="/atom.xml">RSS</a></div></div></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full" href="/links/"><span>友情链接 </span><i class="fa-solid fa-link fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active" href="/tags/"><span>Tags</span> <i class="fa-regular fa-tags fa-sm fa-fw"></i></a></li><li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full"><a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active" href="/categories/"><span>Categories</span> <i class="fa-regular fa-folder fa-sm fa-fw"></i></a></li></ul><div class="statistics flex justify-around my-2.5"><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">62</div><div class="label text-third-text-color text-sm">标签</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">10</div><div class="label text-third-text-color text-sm">分类</div></a><a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives"><div class="number text-2xl sm:text-xl text-second-text-color font-semibold">51</div><div class="label text-third-text-color text-sm">文章</div></a></div></div><div class="window-mask"></div></header></div><div class="main-content-body"><div class="main-content"><div class="post-page-container flex relative justify-between box-border w-full h-full"><div class="article-content-container"><div class="article-title relative w-full"><div class="w-full flex items-center pt-6 justify-start"><h1 class="article-title-regular text-second-text-color text-4xl md:text-6xl font-bold px-2 sm:px-6 md:px-8 py-3">webflux-project</h1></div></div><div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8"><div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]"><img src="/images/avatar.webp"></div><div class="info flex flex-col justify-between"><div class="author flex items-center"><span class="name text-default-text-color text-lg font-semibold">Entropy</span> <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv4</span></div><div class="meta-info"><div class="article-meta-info"><span class="article-date article-meta-item"><i class="fa-regular fa-pen-fancy"></i>&nbsp; <span class="desktop">2024-02-09 16:25:56</span> <span class="mobile">2024-02-09 16:25:56</span> <span class="hover-info">创建</span> </span><span class="article-date article-meta-item"><i class="fa-regular fa-wrench"></i>&nbsp; <span class="desktop">2024-02-09 16:25:56</span> <span class="mobile">2024-02-09 16:25:56</span> <span class="hover-info">更新</span> </span><span class="article-tags article-meta-item"><i class="fa-regular fa-tags"></i>&nbsp;<ul><li><a href="/tags/Spring-Webflux/">Spring Webflux</a>&nbsp;</li></ul></span><span class="article-wordcount article-meta-item"><i class="fa-regular fa-typewriter"></i>&nbsp;<span>28.2k 字</span> </span><span class="article-min2read article-meta-item"><i class="fa-regular fa-clock"></i>&nbsp;<span>114 分钟</span> </span><span class="article-pv article-meta-item"><i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span></span></div></div></div></div><div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8"><p>记录首次基于 Spring Webflux 响应式框架的后端项目开发过程中涉及到的一些东西。<span id="more"></span></p><p>webflux 框架是一个异步非阻塞的响应式框架，旨在提高吞吐量和并发量。webflux 框架的使用过程中涉及到很多函数式编程与响应式编程。下面是一些学习使用过程中的整理。</p><h3 id="对象模型-po-bo-dto-vo-do"><a class="markdownIt-Anchor" href="#对象模型-po-bo-dto-vo-do"></a> 对象模型 PO BO DTO VO (DO)</h3><h4 id="基本概念"><a class="markdownIt-Anchor" href="#基本概念"></a> 基本概念</h4><ul><li><strong>PO (Persistent Object) 持久对象</strong>：直接映射到数据库表的一个对象。通常与数据库表结构一一对应，用于ORM（对象关系映射）框架。</li><li><strong>BO (Business Object) 业务对象</strong>：包含业务逻辑的对象，一般位于业务层。BO通常从DAO（数据访问对象）获取数据，进行业务逻辑处理，并返回结果给前端。</li><li><strong>DTO (Data Transfer Object) 数据传输对象</strong>：用于服务层和外部的通信，或是不同服务间的数据传输。DTO主要用于远程调用时减少单个方法调用的参数数量，或是封装方法调用的返回结果。</li><li><strong>VO (Value Object) 值对象</strong>：主要用于表示展示层和客户端的数据对象。VO通常是根据界面的需求来创建的，包含界面显示所需要的数据。</li><li><strong>DO (Domain Object) 领域对象</strong>：在领域驱动设计（DDD）中，领域对象包含了业务逻辑，它代表了业务领域内的一个实体或概念，这时候等同于<strong>BO</strong>。在另外的开发规范中，DO (Data Object) 作为数据对象，对象属性与数据库字段形成映射关系，这时候等同于<strong>PO</strong>。</li></ul><h4 id="数据来源"><a class="markdownIt-Anchor" href="#数据来源"></a> 数据来源</h4><p><strong>VO</strong></p><ul><li><strong>数据来源</strong>：通常直接对应于前端视图展示的数据需求，可能来自于单个PO的转换，或者是多个PO、DTO的组合与转换的结果。</li><li><strong>简单场景案例</strong>：在一个CRUD应用中，创建用户的表单提交结果可能直接映射为一个<code>UserVO</code>，该VO包含用户的姓名、邮箱等信息，然后直接转换为PO进行数据库操作。</li></ul><p><strong>DTO</strong></p><ul><li><strong>数据来源</strong>：DTO通常用于服务层之间的数据传输，它的数据可能来源于数据库的多表查询结果，或者是BO的转换和封装。</li><li><strong>简单场景案例</strong>：在微服务架构中，<code>OrderService</code>调用<code>UserService</code>获取用户信息时，<code>UserService</code>可能会返回一个<code>UserDTO</code>，包含用户的基本信息，这个DTO可能是直接从数据库查询得到的，也可能是一个或多个PO转换而来。</li></ul><p><strong>BO</strong></p><ul><li><strong>数据来源</strong>：BO主要在业务逻辑层使用，它的数据来源可能是数据库查询得到的PO，或者是经过业务逻辑处理的DTO。</li><li><strong>简单场景案例</strong>：在处理订单支付逻辑时，<code>PaymentBO</code>可能包含订单详情、用户信息等多个方面的数据，这些数据可能通过查询数据库得到的PO转换而来，然后<code>PaymentBO</code>会封装支付处理的具体逻辑。</li></ul><p><strong>PO</strong></p><ul><li><strong>数据来源</strong>：PO就是直接对应数据库中的每一张数据表。</li><li><strong>简单场景案例</strong>：在数据库中存在<code>user</code>、<code>order</code>、<code>record</code>等数据表，根据每一张表的字段定义对应的PO。</li></ul><blockquote><h2 id="复杂场景案例"><a class="markdownIt-Anchor" href="#复杂场景案例"></a> 复杂场景案例</h2><p>一个典型的复杂场景案例，展示了一个电商系统中订单处理的流程，涉及用户下单、订单处理、支付、以及最终的订单状态更新和通知用户。</p><h3 id="场景描述"><a class="markdownIt-Anchor" href="#场景描述"></a> 场景描述</h3><p>假设有一个电商平台，用户可以浏览商品、添加商品到购物车、下单和支付。系统需要处理订单创建、库存检查、支付处理、订单状态更新和通知用户等一系列操作。</p><h3 id="涉及的模型和层次"><a class="markdownIt-Anchor" href="#涉及的模型和层次"></a> 涉及的模型和层次</h3><ul><li><strong>PO（持久对象）</strong>：<code>Order</code>、<code>OrderItem</code>、<code>Product</code>、<code>User</code>等，直接映射数据库中的订单表、订单项表、产品表和用户表。</li><li><strong>DTO（数据传输对象）</strong>：<code>OrderCreationDTO</code>、<code>PaymentInfoDTO</code>等，用于在服务层之间传递订单创建和支付信息。</li><li><strong>BO（业务对象）</strong>：<code>OrderBO</code>，封装订单处理的业务逻辑，如验证库存、计算价格等。</li><li><strong>VO（值对象）</strong>：<code>OrderSummaryVO</code>、<code>PaymentResultVO</code>等，用于向用户展示订单摘要信息和支付结果。</li></ul><h3 id="数据流转"><a class="markdownIt-Anchor" href="#数据流转"></a> 数据流转</h3><ol><li><strong>用户下单</strong>：<ul><li>用户在前端页面提交订单，前端发送包含订单详情（如商品ID、数量等）的<code>OrderCreationDTO</code>到后端。</li><li>Controller层接收<code>OrderCreationDTO</code>，调用Service层处理订单。</li></ul></li><li><strong>订单处理</strong>：<ul><li>Service层将<code>OrderCreationDTO</code>转换或直接使用来创建<code>OrderBO</code>。</li><li><code>OrderBO</code>负责业务逻辑处理，如验证库存、计算总价等，并使用PO操作数据库创建订单和订单项。</li><li>如果涉及到跨服务调用（如库存服务），可能会使用其他的<code>DTO</code>进行数据传输。</li></ul></li><li><strong>支付处理</strong>：<ul><li>用户选择支付方式并提交支付信息，后端接收支付信息（如<code>PaymentInfoDTO</code>）并处理支付。</li><li>支付服务可能是一个独立的服务，Service层将支付信息封装在<code>DTO</code>中调用支付服务。</li><li>支付完成后，更新订单状态，并将结果封装在<code>PaymentResultVO</code>中返回给前端。</li></ul></li><li><strong>订单完成和通知</strong>：<ul><li>订单支付成功后，Service层更新订单状态（使用PO操作数据库）。</li><li>系统通知用户订单已完成，可能通过发送<code>OrderSummaryVO</code>到前端展示订单摘要，或发送邮件/短信通知（内容可能基于<code>VO</code>生成）。</li></ul></li></ol></blockquote><h4 id="在-springboot-三层架构中的使用"><a class="markdownIt-Anchor" href="#在-springboot-三层架构中的使用"></a> 在 SpringBoot 三层架构中的使用</h4><h5 id="controller层"><a class="markdownIt-Anchor" href="#controller层"></a> Controller层</h5><ul><li><strong>VO（值对象）</strong>：主要用于Controller层与前端的数据交互。VO专门针对视图（View）的需求设计，封装了用户界面展示所需的数据。Controller层可能会接收前端传来的VO，也可能将数据封装成VO返回给前端。</li></ul><h5 id="service层"><a class="markdownIt-Anchor" href="#service层"></a> Service层</h5><ul><li><strong>DTO（数据传输对象）</strong>：Service层广泛使用DTO来传输跨层次、跨服务的数据。DTO用于封装从Controller传到Service层的数据，或者从Service层传到其他服务的数据。</li><li><strong>BO（业务对象）</strong>：BO包含业务逻辑和业务状态信息，Service层使用BO来执行具体的业务操作。BO可以看作是Service层的核心，封装了业务规则和算法。</li></ul><h5 id="dao或repository层"><a class="markdownIt-Anchor" href="#dao或repository层"></a> DAO（或Repository）层</h5><ul><li><strong>PO（持久对象）</strong>：DAO层使用PO与数据库表直接映射。ORM（对象关系映射）框架如Hibernate、JPA等通常操作PO，将数据库行记录映射成PO，或将PO持久化到数据库中。PO仅仅反映了数据库的结构，而没有复杂的业务逻辑。</li></ul><h5 id="数据流转-2"><a class="markdownIt-Anchor" href="#数据流转-2"></a> 数据流转</h5><ol><li><strong>前端到后端</strong>：前端发送请求，Controller层接收封装成VO的数据 -&gt; Service层将VO转换成DTO或直接使用DTO接收数据，进行业务处理，可能会涉及到BO -&gt; DAO层使用PO与数据库交互。</li><li><strong>后端到前端</strong>：DAO层查询数据库，将结果封装成PO -&gt; Service层处理业务逻辑，可能会转换PO为BO或DTO进行业务逻辑的处理 -&gt; Controller层将DTO或BO转换为VO，返回给前端。</li></ol><style>.oeztdtizdblc{zoom:80%}</style><img lazyload src="/images/loading.svg" data-src="/2024/02/09/webflux-project/274001.png" class="oeztdtizdblc" alt="图片"><h3 id="外键关联约束下-po-的映射行为"><a class="markdownIt-Anchor" href="#外键关联约束下-po-的映射行为"></a> 外键关联约束下 PO 的映射行为</h3><h4 id="1-基本类型"><a class="markdownIt-Anchor" href="#1-基本类型"></a> 1. 基本类型</h4><ul><li><strong>定义</strong>：使用基本数据类型或其包装类直接在PO中表示外键字段。</li><li><strong>适用场景</strong>：当你只需要知道关联表的ID，而不需要访问关联表其他字段的详细信息时。</li><li><strong>建议</strong>：这种方式简单且高效，适用于关联关系较为简单的场景。</li></ul><h4 id="2-变量级组合"><a class="markdownIt-Anchor" href="#2-变量级组合"></a> 2. 变量级组合</h4><ul><li><strong>定义</strong>：在PO中通过对象变量的形式包含关联表的PO，以此来表示外键关系。</li><li><strong>适用场景</strong>：需要访问或操作关联表的详细信息时，如展示用户信息时同时需要展示用户的订单信息。</li><li><strong>建议</strong>：采用变量级组合可以增强模型的表达力，适用于需要在业务逻辑中处理关联数据的场景。使用ORM框架时，这种关系可以通过注解（如JPA的<code>@ManyToOne</code>、<code>@OneToMany</code>等）来实现。</li></ul><h4 id="3-类级组合bo"><a class="markdownIt-Anchor" href="#3-类级组合bo"></a> 3. 类级组合(BO)</h4><ul><li><strong>定义</strong>：通过创建新的类来封装多个表的组合数据，这些类不直接对应单一的数据库表，而是根据业务需求组合多个PO的数据(BO的来源之一)。</li><li><strong>适用场景</strong>：跨表查询结果的封装，或需要根据业务逻辑组合多个表数据的场景。</li><li><strong>建议</strong>：类级组合适用于复杂的业务逻辑处理，以及需要将多个表的数据作为一个整体进行处理的情况。这种方法可以提高代码的可读性和维护性，但需要注意避免过度使用，以免引入不必要的复杂性。</li></ul><h4 id="4-数据传输对象dto"><a class="markdownIt-Anchor" href="#4-数据传输对象dto"></a> 4. 数据传输对象(DTO)</h4><ul><li><strong>定义</strong>：特别地，可以创建DTO来封装从数据库查询得到的数据，特别是多表查询的结果，DTO不直接映射到数据库的表结构，而是根据展示或传输的需要定制。</li><li><strong>适用场景</strong>：在跨服务传输数据，或者在层与层之间传输经过处理的数据时。</li><li><strong>建议</strong>：当PO与视图或服务间的数据需求不一一对应时，使用DTO可以提供更大的灵活性和清晰的分层。</li></ul><h3 id="各种-er-关系下的对象模型设计"><a class="markdownIt-Anchor" href="#各种-er-关系下的对象模型设计"></a> 各种 ER 关系下的对象模型设计</h3><blockquote><p>使用变量级别的组合描述实体关系，简要地说明一个参考的对象模型设计方案。</p></blockquote><p>一个简单的图书管理系统，其中包括<code>Author</code>（作者）、<code>Book</code>（书籍）、<code>Review</code>（书评）和<code>BookDetail</code>（书籍详情）四个实体。</p><h4 id="实体关系"><a class="markdownIt-Anchor" href="#实体关系"></a> 实体关系</h4><ul><li><strong>多对多关系</strong>：一本书可以由多个作者共同编写，一个作者也可以写多本书（<code>Book</code> &lt;-&gt; <code>Author</code>）。</li><li><strong>一对多关系</strong>：一本书可以有多条书评，但每条书评只针对一本书（<code>Book</code> -&gt; <code>Review</code>）。</li><li><strong>一对一关系</strong>：为了方便展示一对一的关系，可以引入一个新的实体：书籍详情（BookDetail），假设每本书都有一个与之对应的详细信息页（<code>Book</code> -&gt; <code>BookDetail</code>）。</li></ul><h4 id="po-的设计"><a class="markdownIt-Anchor" href="#po-的设计"></a> PO 的设计</h4><p>对应数据表中的各个字段，分析实体关系进行设计。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Author</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Book&gt; books; <span class="comment">// 与Book的多对多关系</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Book</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Author&gt; authors; <span class="comment">// 与Author的多对多关系</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Review&gt; reviews; <span class="comment">// 与Review的一对多关系</span></span><br><span class="line">    <span class="keyword">private</span> BookDetail bookDetail; <span class="comment">// 与BookDetail的一对一关系</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Review</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> Book book; <span class="comment">// 指向Book的外键，表示这条书评属于哪本书</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDetail</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String isbn;</span><br><span class="line">    <span class="keyword">private</span> String publisher;</span><br><span class="line">    <span class="keyword">private</span> Book book; <span class="comment">// 指向Book的引用，一对一关系</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="dto-的设计"><a class="markdownIt-Anchor" href="#dto-的设计"></a> DTO 的设计</h4><p>封装多表查询的数据结构，用于服务层和展示层的数据传输。（根据多表查询的结果、前端的请求数据结构等设计，这里是多表查询<code>Book</code>和<code>BookDetail</code>的示例，用来展示书籍列表，其中包括书名、作者名字列表和ISBN号。)</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookListDTO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; authorsNames; <span class="comment">// 书的所有作者的名字</span></span><br><span class="line">    <span class="keyword">private</span> String isbn; <span class="comment">// 书籍详情中的ISBN号</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="vo的设计"><a class="markdownIt-Anchor" href="#vo的设计"></a> VO的设计</h4><p>VO用于表示层，封装最终用户界面所需的数据。（根据前端展示要求设计，例如展示书籍的详细信息，包括书名、ISBN号、出版社、作者列表和书评列表，可以是由若干个 PO、DTO 单独或者组合转换而来。）</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookDetailVO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String isbn;</span><br><span class="line">    <span class="keyword">private</span> String publisher;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; authors;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; reviews; <span class="comment">// 用户对书籍的评论</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造器、Getter和Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="bo的设计"><a class="markdownIt-Anchor" href="#bo的设计"></a> BO的设计</h4><p>BO封装业务逻辑，基于PO进行操作，可能会涉及多个PO之间的逻辑关系。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BookManagementBO</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Book book;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Author&gt; authors;</span><br><span class="line">    <span class="keyword">private</span> BookDetail bookDetail;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Review&gt; reviews;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BookManagementBO</span><span class="params">(Book book)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.book = book;</span><br><span class="line">        <span class="comment">// 假设这里填充了authors、bookDetail、reviews等信息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">publishBook</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 实现发布书籍的业务逻辑，可能包括保存书籍信息、保存作者信息等</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addReview</span><span class="params">(Review review)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加书评到书籍</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 更多业务逻辑方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>BO 的设计有些特殊，它主要负责处理业务逻辑，并可以直接访问DAO（数据访问对象）层。但是它的业务逻辑操作的类型又不同于在服务层的业务逻辑操作：</p><h5 id="服务层service-layer"><a class="markdownIt-Anchor" href="#服务层service-layer"></a> 服务层（Service Layer）</h5><p>服务层主要负责协调应用程序中不同部分的业务逻辑。它为表示层提供了一组可用的操作（API），这些操作代表了应用程序可以执行的业务操作。服务层的职责包括：</p><ul><li><strong>事务管理</strong>：确保业务操作的事务性，处理应用程序中的事务边界。</li><li><strong>应用逻辑</strong>：实现应用级别的业务逻辑，如用户权限验证、工作流控制等。</li><li><strong>协调数据访问</strong>：调用下层的数据访问对象（DAO）来访问和修改数据。</li><li><strong>聚合业务操作</strong>：组合和协调多个BO的操作，以执行复杂的业务逻辑。</li></ul><h5 id="业务对象bo"><a class="markdownIt-Anchor" href="#业务对象bo"></a> 业务对象（BO）</h5><p>业务对象通常更接近于特定的业务领域模型，封装了与之相关的数据以及对数据进行操作的业务逻辑。BO的职责包括：</p><ul><li><strong>封装业务规则</strong>：实现特定业务领域的规则和逻辑。</li><li><strong>状态管理</strong>：管理和维护业务对象的状态。</li><li><strong>数据验证</strong>：确保业务数据的完整性和有效性。</li><li><strong>数据转换</strong>：在业务模型和数据模型之间转换数据。</li></ul><h5 id="如何划分"><a class="markdownIt-Anchor" href="#如何划分"></a> 如何划分</h5><ul><li><strong>粒度和复杂性</strong>：如果业务操作涉及多个实体之间的复杂交互或需要执行跨实体的事务管理，通常这些操作应该放在服务层完成。服务层可以调用一个或多个BO来实现这些复杂的业务逻辑。</li><li><strong>领域逻辑</strong>：如果操作主要涉及单一实体内部的业务规则或逻辑，这些操作可以封装在相应的BO中。BO可以提供细粒度的业务方法，服务层可以利用这些方法来完成更高级别的业务操作。</li><li><strong>数据访问</strong>：尽管BO可以直接调用DAO来进行数据操作，但更常见的做法是在服务层中调用DAO，然后通过服务层来协调数据访问和业务逻辑。这样做有助于保持业务逻辑层的一致性和事务的完整性。</li></ul><h5 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h5><ul><li><strong>在服务层中操作</strong>：当业务逻辑需要跨多个领域模型或需要应用级别的逻辑处理时。例如针对上面的 DTO 的数据结构查询结果。</li><li><strong>在BO中操作</strong>：当业务逻辑主要针对单一领域模型且比较独立时。例如针对书籍的发布涉及到保存和查询两个连续操作，添加书评需要对书评的内容进行敏感词过滤等。</li></ul><h3 id="基础环境"><a class="markdownIt-Anchor" href="#基础环境"></a> 基础环境</h3><h4 id="项目依赖环境"><a class="markdownIt-Anchor" href="#项目依赖环境"></a> 项目依赖环境</h4><p>下面的 pom.xml 是项目涉及到的全部依赖</p><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.entropy<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>webflux-demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>gradems<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>17<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb-reactive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-r2dbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis-reactive<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.12.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.12.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jjwt-jackson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.12.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-webflux<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-docker-compose<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.postgresql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>r2dbc-postgresql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.projectreactor<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>reactor-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">excludes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">exclude</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">exclude</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">excludes</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure></div><h4 id="数据库环境搭建"><a class="markdownIt-Anchor" href="#数据库环境搭建"></a> 数据库环境搭建</h4><p>使用以下 docker-compose.yaml 配置文件即可快速搭建 postgresql、mongodb、redis 三个数据库</p><div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">postgres:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gradms-postgres</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;postgres:latest&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_DB=gradems&#x27;</span>		<span class="comment"># postgresql 数据库名称</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_PASSWORD=gradems&#x27;</span>	<span class="comment"># postgresql 数据库密码</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;POSTGRES_USER=admin&#x27;</span>		<span class="comment"># postgresql 数据库用户名</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;5432:5432&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;postgres_data:/var/lib/postgresql/data&#x27;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gradms-redis</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;redis:latest&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;6379:6379&#x27;</span></span><br><span class="line">  <span class="attr">mongodb:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gradms-mongodb</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&#x27;mongo:latest&#x27;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;27017:27017&#x27;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&#x27;mongodb_data:/data/db&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">postgres_data:</span></span><br><span class="line">  <span class="attr">mongodb_data:</span></span><br></pre></td></tr></table></figure></div><p>运行命令<code>docker-compose up -d</code>启动。</p><p>至此，基本的项目依赖环境和数据库环境准备完成。</p><h3 id="webflux-控制层"><a class="markdownIt-Anchor" href="#webflux-控制层"></a> Webflux 控制层</h3><p>Webflux 的控制层有两种不同的编写风格，一种是传统控制器风格，一种是函数式端点风格。</p><h4 id="传统控制器风格"><a class="markdownIt-Anchor" href="#传统控制器风格"></a> 传统控制器风格</h4><p>只需要在传统的控制器上将返回值设置为<code>Mono</code>或<code>Flux</code>两个特殊的类型即可。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.just(<span class="string">&quot;Hello, World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>在 Spring Webflux 中，<code>Mono</code>和<code>Flux</code>是响应式编程中的两种基本类型，它们来自于 Reactor 库：</p><ul><li><strong>Mono</strong>：代表单个值或空值的异步序列。它用于处理最多一个数据项的场景。例如，一个查询单个对象的数据库操作可以返回<code>Mono</code>。</li><li><strong>Flux</strong>：代表多个值的异步序列。它用于处理0到N个数据项的场景。例如，一个查询多个对象的数据库操作可以返回<code>Flux</code>。</li></ul><blockquote><p>控制层返回值的改动也会影响到服务层，数据访问层的代码。</p></blockquote><h4 id="函数式端点风格"><a class="markdownIt-Anchor" href="#函数式端点风格"></a> 函数式端点风格</h4><p>首先创建一个处理器类(handler)，需要返回固定的<code>Mono&lt;ServerResponse&gt;</code>类型。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">hello</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().body(Mono.just(<span class="string">&quot;Hello, WebFlux!&quot;</span>), String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>然后是创建路由配置类，用于定义路由节点。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RouterConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">route</span><span class="params">(MyHandler handler)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">            .route(RequestPredicates.GET(<span class="string">&quot;/hello&quot;</span>), handler::hello);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>此时传统的控制器被分成了处理器和路由配置两部分。</p><h4 id="统一响应结构"><a class="markdownIt-Anchor" href="#统一响应结构"></a> 统一响应结构</h4><p>在前后端分离项目，前后端之间的数据交互通常遵循统一的固定格式。</p><p>一个典型的固定格式包含以下几个关键部分：</p><ol><li><strong>状态码（Code）</strong>：表示请求处理的结果（如成功、错误的详细信息）。这通常是一个整数值，例如200表示成功，400表示客户端错误，500表示服务器错误。</li><li><strong>消息（Message）</strong>：提供关于请求处理结果的简短描述，尤其是在发生错误时。这有助于前端开发人员理解发生了什么问题，甚至可能向用户显示这些消息。</li><li><strong>数据（Data）</strong>：实际的响应数据，可以是任何结构，如对象、数组或简单值。这是请求的主要内容，包含了前端需要的所有数据。</li></ol><p>下面通过自定义 API 响应类来设置响应体格式</p><p>创建一个 API 响应类</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApiResponse</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line">    <span class="keyword">private</span> T data; <span class="comment">// 使用泛型代替Object提高类型安全</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ApiResponse</span><span class="params">(Integer code, String message, T data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略getters和setters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>在处理器中使用自定义的 API 响应类封装数据</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">hello</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        Mono&lt;ApiResponse&gt; resp = Mono.just(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="number">200</span>, <span class="string">&quot;OK&quot;</span>, <span class="string">&quot;Hello, WebFlux!&quot;</span>););</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().body(resp, ApiResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">hello</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">        Mono&lt;ApiResponse&gt; resp = Mono.fromSupplier(() -&gt; <span class="keyword">new</span> <span class="title class_">ApiResponse</span>(<span class="number">200</span>, <span class="string">&quot;OK&quot;</span>, <span class="string">&quot;Hello, WebFlux!&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().body(resp, ApiResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这里<code>Mono.just</code>和<code>Mono.fromSupplier</code>的区别是：</p><p><code>just</code>是立即创建并包装一个已经存在的值。当你需要包装一个已知的非异步值或非阻塞操作的结果时适合使用<code>just</code>。</p><p><code>fromSupplier</code>允许你在响应式流中延迟执行并动态地生成单个值。当你的操作是异步的或者你想要延迟执行某个操作直到订阅发生时适合使用<code>fromSupplier</code>。</p><blockquote><p>相关资料推荐：<a class="link" target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/334809573">一文搞懂什么是RESTful API <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p></blockquote><h4 id="crud-操作"><a class="markdownIt-Anchor" href="#crud-操作"></a> CRUD 操作</h4><p>Webflux 中进行 CRUD 操作的代码也和传统的 web 框架不太一样，这里大概介绍一下 Webflux 控制层中增删改查操作涉及的常用方法。</p><h5 id="路径参数与请求体的提取"><a class="markdownIt-Anchor" href="#路径参数与请求体的提取"></a> 路径参数与请求体的提取</h5><p>路径参数是 RESTful 风格中的概念，将 URL 中指定的值直接提取出来，不同于传统的查询参数，路径参数只包括了值本身，而“键”是在路由配置中定义的。</p><p>增删改和条件查询(单个结果)通常都需要一个路径参数指定全局唯一资源</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加(POST)</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">createItem</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    Mono&lt;Item&gt; itemMono = request.bodyToMono(Item.class);</span><br><span class="line">    <span class="keyword">return</span> itemMono.flatMap(item -&gt; service.createItem(item))</span><br><span class="line">                   .flatMap(item -&gt; ServerResponse.ok().bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">200</span>, <span class="string">&quot;Item Created Successfully&quot;</span>, item)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 删除(DELETE)</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">deleteItem</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> service.deleteItem(id)</span><br><span class="line">                  .flatMap(item -&gt; ServerResponse.ok().bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">200</span>, <span class="string">&quot;Item Deleted Successfully&quot;</span>, item)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 更新(PUT)</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">updateItem</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> request.pathVariable(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">    Mono&lt;Item&gt; itemMono = request.bodyToMono(Item.class);</span><br><span class="line">    <span class="keyword">return</span> itemMono.flatMap(item -&gt; service.updateItem(id, item))</span><br><span class="line">                   .flatMap(item -&gt; ServerResponse.ok().bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">200</span>, <span class="string">&quot;Item Updated Successfully&quot;</span>, item)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这里的<code>bodyToMono</code>方法用于将请求体转换为相应类型的<code>Mono</code>，主要是针对增加和更新操作，而<code>pathVariable</code>方法用于提取路径变量，主要是针对查询和删除操作。如果使用传统的查询参数可以使用<code>ServerRequest.queryParam</code>的方法获取。</p><h5 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h5><p>在 WebFlux 的函数式端点风格中，<code>ServerRequest</code>提供了多种方法来获取 HTTP 请求中的不同类型的数据：</p><ol><li><strong>获取响应体数据</strong>： 使用<code>request.bodyToMono(Class&lt;T&gt;)</code>来获取请求体中的数据，适用于 POST 和 PUT 请求。</li><li><strong>获取路径参数</strong>： 使用<code>request.pathVariable(&quot;name&quot;)</code>来获取 URL 路径中的变量，适用于任何类型的 HTTP 请求。</li><li><strong>获取查询参数</strong>： 使用<code>request.queryParam(&quot;name&quot;)</code>来获取 URL 查询参数，适用于 GET 请求。</li></ol><blockquote><h2 id="关于-flatmap"><a class="markdownIt-Anchor" href="#关于-flatmap"></a> 关于 flatMap</h2><p><code>flatMap</code>是响应式编程中的一个重要操作符，它用于处理流（如<code>Mono</code>或<code>Flux</code>中的元素），并将每个元素转换成另一个流，最后将这些流“扁平化”为一个流。在Reactor库中，这个操作符常用于处理异步操作的结果，尤其是当这些操作本身返回<code>Mono</code>或<code>Flux</code>时。</p><h3 id="具体是什么"><a class="markdownIt-Anchor" href="#具体是什么"></a> 具体是什么？</h3><p><code>flatMap</code>操作符接收一个函数作为参数。这个函数对源流中的每个元素进行操作，返回一个新的<code>Publisher</code>（<code>Mono</code>或<code>Flux</code>）。然后，<code>flatMap</code>将这些返回的<code>Publisher</code>合并成一个单一的<code>Publisher</code>。这使得<code>flatMap</code>非常适合处理嵌套的异步操作。</p><h3 id="应该在哪里使用它"><a class="markdownIt-Anchor" href="#应该在哪里使用它"></a> 应该在哪里使用它？</h3><ol><li><strong>链式异步调用</strong>：当你需要执行一系列的异步操作，并且后一个操作依赖于前一个操作的结果时。例如，从数据库查询一个对象，然后根据该对象的信息去查询另一个服务。</li><li><strong>转换和合并流</strong>：当你需要将流中的元素转换为另一种类型的流，并且希望最终结果是一个单一流时。</li><li><strong>处理嵌套的<code>Mono</code>或<code>Flux</code></strong>：当操作返回嵌套的<code>Mono&lt;Mono&lt;T&gt;&gt;</code>或<code>Flux&lt;Flux&lt;T&gt;&gt;</code>时，使用<code>flatMap</code>可以将其“扁平化”为<code>Mono&lt;T&gt;</code>或<code>Flux&lt;T&gt;</code>。</li></ol><h3 id="什么情况下使用它"><a class="markdownIt-Anchor" href="#什么情况下使用它"></a> 什么情况下使用它？</h3><ul><li>当你想要异步地转换数据，并且每个转换本身返回一个<code>Mono</code>或<code>Flux</code>时。</li><li>当你需要处理一个操作的结果，这个操作异步地返回另一个可观察的流时。</li><li>当你希望并发执行异步操作，并且需要合并它们的结果时。<code>flatMap</code>允许并发执行，但如果需要控制并发度，你可能需要使用其变体如<code>flatMapSequential</code>（保持原始序列顺序）或<code>flatMap</code>带有并发限制的重载方法。</li></ul></blockquote><h3 id="webflux-数据访问层"><a class="markdownIt-Anchor" href="#webflux-数据访问层"></a> Webflux 数据访问层</h3><h4 id="整合r2dbc"><a class="markdownIt-Anchor" href="#整合r2dbc"></a> 整合R2DBC</h4><h5 id="连接配置"><a class="markdownIt-Anchor" href="#连接配置"></a> 连接配置</h5><p>配置 application.yaml 文件，重点关注 url、username、password 这里的配置。</p><ul><li><strong>url</strong>：使用 r2dbc 协议连接 postgresql 数据库，默认本地端口 5432，数据库名称为 gradems。</li><li><strong>username</strong>：数据库用户名。在前面的 docker-compose.yaml 配置文件中已经指定。</li><li><strong>password</strong>：数据库密码。在前面的 docker-compose.yaml 配置文件中已经指定。</li></ul><div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">r2dbc:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">r2dbc:postgresql://localhost:5432/gradems</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">gradems</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">initial-size:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">max-size:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure></div><h5 id="代码实现方式"><a class="markdownIt-Anchor" href="#代码实现方式"></a> 代码实现方式</h5><p>在使用 WebFlux 框架时，结合 R2DBC 进行反应式数据库操作，主要有以下几种实现方式：</p><ol><li><strong>Repository方式</strong>：利用Spring Data R2DBC提供的Repository支持，可以通过定义接口来自动实现反应式CRUD操作。这种方式极大简化了数据访问层的代码，开发者只需定义接口并选择性地添加查询方法，Spring Data R2DBC会自动实现这些接口。</li><li><strong>DatabaseClient API</strong>：Spring Data R2DBC提供了一个高级的<code>DatabaseClient</code> API，适用于更灵活的数据库访问和查询构建。它支持声明式的查询操作，允许开发者以链式调用的方式构建查询并处理结果。这种方式提供了比Repository更灵活的数据访问能力，适合于复杂查询和自定义操作。</li><li><strong>R2DBC EntityTemplate</strong>：<code>R2dbcEntityTemplate</code>提供了一个基于模板的方法来执行数据库操作，包括插入、更新、查询和删除等CRUD操作。它为操作单一实体或批量实体提供了便捷的API，并且可以与R2DBC的反应式特性很好地结合使用。</li><li><strong>自定义R2DBC使用</strong>：除了上述封装好的高级API外，开发者还可以直接使用R2DBC的底层API来执行数据库操作。这种方式需要开发者手动管理数据库连接和查询执行，提供了最大的灵活性和控制力，适用于需要高度定制化数据库操作的场景。</li><li><strong>R2DBC QueryDSL</strong>：对于需要构建类型安全的复杂查询的应用，可以考虑使用QueryDSL与R2DBC结合的方式。这种方法允许开发者以DSL（Domain-Specific Language）的方式构建查询，提高了代码的可读性和维护性。</li></ol><p>这里主要介绍最常用的 Repository 方式和 DatabaseClient API 方式，基本满足大部分应用场景。</p><p>首先创建以下实体类<code>Person</code></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Table(&quot;people&quot;)</span> <span class="comment">// 如果数据表名和类名匹配，则该注解可省略，否则需要指定映射数据表名</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column(&quot;name&quot;)</span> <span class="comment">// 与@Table类似的映射作用，如果名称相同可以省略</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Getters and setters...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><code>@Id</code>注解告诉Spring Data R2DBC框架哪个属性用作数据库表中的主键列。Spring Data R2DBC 依赖于该注解来识别实体的唯一标识符（ID），从而执行诸如查找、更新或删除特定实体的操作。如果缺少<code>@Id</code>注解，Spring Data R2DBC 可能无法正确执行这些操作，因为它无法确定哪个字段是实体的主键。</p><h6 id="使用repository-方式"><a class="markdownIt-Anchor" href="#使用repository-方式"></a> <strong>使用Repository 方式</strong></h6><p>定义<code>PersonRepository</code>接口，<code>ReactiveCrudRepository</code>具有方法名解析的功能，即可以通过方法名解析自动实现该方法的功能，方法名需要遵循特定的命名规则。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PersonRepository</span> <span class="keyword">extends</span> <span class="title class_">ReactiveCrudRepository</span>&lt;Person, Long&gt; &#123;</span><br><span class="line">    Mono&lt;Person&gt; <span class="title function_">findByName</span><span class="params">(String name)</span>; <span class="comment">// 查询单个结果</span></span><br><span class="line">    Flux&lt;Person&gt; <span class="title function_">findByAge</span><span class="params">(<span class="type">int</span> age)</span>; <span class="comment">// 查询多个结果</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>CRUD 操作示例 <strong>(在服务层实现)</strong></p><blockquote><p>这里涉及的方法是<code>ReactiveCrudRepository</code>自带的接口实现。</p></blockquote><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">person.setName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">person.setAge(<span class="number">25</span>);</span><br><span class="line">Mono&lt;Person&gt; savedPerson = personRepository.save(person);</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">Mono&lt;Void&gt; deletePerson = personRepository.deleteById(<span class="number">1L</span>);</span><br><span class="line"><span class="comment">// 局部更新</span></span><br><span class="line">Mono&lt;Person&gt; updatedPerson = personRepository.findById(<span class="number">1L</span>)</span><br><span class="line">    .map(p -&gt; &#123;</span><br><span class="line">        p.setName(<span class="string">&quot;Jane Doe&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;)</span><br><span class="line">    .flatMap(personRepository::save);</span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line"><span class="comment">// 更新实际上是通过 save 方法实现的，如果对象存在则更新，否则插入</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">person.setName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">person.setAge(<span class="number">30</span>);</span><br><span class="line">Mono&lt;Person&gt; savedPerson = personRepository.save(person);</span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line"><span class="comment">// 查询单个结果</span></span><br><span class="line">Mono&lt;Person&gt; person = personRepository.findById(<span class="number">1L</span>);</span><br><span class="line"><span class="comment">// 查询多个结果</span></span><br><span class="line">Flux&lt;Person&gt; people = personRepository.findAll();</span><br></pre></td></tr></table></figure></div><h6 id="使用databaseclient-api"><a class="markdownIt-Anchor" href="#使用databaseclient-api"></a> <strong>使用DatabaseClient API</strong></h6><p>当使用Spring Data R2DBC的<code>DatabaseClient</code>进行数据库操作时，你会遇到一系列的链式调用方法，这些方法为构建和执行数据库命令提供了灵活的接口。下面是这些方法的简要说明：</p><p><code>.sql(String sql)</code></p><ul><li><strong>含义</strong>: 该方法用于指定要执行的SQL命令。</li><li><strong>用法</strong>: <code>.sql(&quot;SELECT * FROM my_table WHERE id = :id&quot;)</code>，其中字符串为要执行的SQL命令。</li></ul><p><code>.bind(String name, Object value)</code></p><ul><li><strong>含义</strong>: 用于绑定SQL命令中的参数。这是一个防止SQL注入的安全做法，比直接在SQL命令字符串中拼接参数更安全。</li><li><strong>用法</strong>: <code>.bind(&quot;id&quot;, 1)</code>，这会将SQL命令中的<code>:id</code>参数替换为<code>1</code>。</li></ul><p><code>.bind(index, value)</code></p><ul><li><strong>含义</strong>: 除了按名称绑定参数外，也可以按位置绑定参数。这在使用没有命名参数的数据库或驱动时特别有用。</li><li><strong>用法</strong>: <code>.bind(0, &quot;value&quot;)</code>，这会将SQL命令中的第一个参数（基于0的索引）绑定为指定的值。</li></ul><p><code>.bindNull(String name, Class&lt;?&gt; type)</code></p><ul><li><strong>含义</strong>: 用于绑定SQL命令中的参数为<code>NULL</code>值，同时指定该<code>NULL</code>值的类型。</li><li><strong>用法</strong>: <code>.bindNull(&quot;parameterName&quot;, String.class)</code>，这会将SQL命令中的<code>:parameterName</code>参数绑定为<code>NULL</code>，类型为<code>String</code>。</li></ul><p><code>.then()</code></p><ul><li><p><strong>含义</strong>: 在Reactor中，<code>.then()</code>方法用于忽略前面步骤的结果，并在上一个操作完成后继续执行。在<code>DatabaseClient</code>的上下文中，<code>.then()</code>通常用于执行完数据库操作（如插入、更新、删除）后，不需要处理任何返回结果，只需知道操作已成功完成。</p></li><li><p><strong>用法</strong>: <code>.then()</code>用于链式调用的最后，返回一个<code>Mono&lt;Void&gt;</code>，表示操作完成的信号。</p><blockquote><p>使用<code>.then()</code>方法后就不能使用<code>.fetch()</code>方法，因为一个不需要返回实际结果，一个需要返回结果。</p></blockquote></li></ul><p><code>.map(Function&lt;Row, T&gt; mappingFunction)</code></p><ul><li><p><strong>含义</strong>: 该方法用于将结果集中的每一行（<code>Row</code>）映射（或转换）为另一种类型（<code>T</code>）。这是通过提供一个函数来完成的，该函数接受一个<code>Row</code>对象并返回一个新类型的对象。</p></li><li><p><strong>用法</strong>: <code>.map(row -&gt; new MyObject(row.get(&quot;column_name&quot;, String.class)))</code>，其中<code>MyObject</code>是自定义类，<code>column_name</code>是结果集中的列名。<strong><code>.map</code>方法在查询操作中几乎是一定会使用到的方法。</strong></p><blockquote><p><code>.map()</code>在这里是对结果集中的每一项进行转换的操作，它是基于结果流<code>Flux</code>或单个结果<code>Mono</code>的Reactor操作符。当需要对查询结果进行转换时，<code>.map()</code>方法通常与<code>.all()</code>, <code>.one()</code>, 或<code>.first()</code>一起使用。</p></blockquote></li></ul><p><code>.one()</code></p><ul><li><p><strong>含义</strong>: 用于从反应式数据库操作中获取恰好一个结果的<code>Mono&lt;T&gt;</code>。如果查询结果为空，则返回<code>Mono.empty()</code>；如果查询结果有多于一条记录，通常会抛出异常。这适用于你期望查询返回单一结果的场景。</p></li><li><p><strong>用法</strong>: 在执行数据库查询操作时使用，适合于返回单条记录的查询。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Person&gt; person = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        row.get(<span class="string">&quot;id&quot;</span>, Long.class), </span><br><span class="line">        row.get(<span class="string">&quot;name&quot;</span>, String.class), </span><br><span class="line">        row.get(<span class="string">&quot;age&quot;</span>, Integer.class)))</span><br><span class="line">    .one();</span><br></pre></td></tr></table></figure></div></li></ul><p><code>.first()</code></p><ul><li><p><strong>含义</strong>: 与<code>.one()</code>类似，但当存在多条记录时，它会返回结果集中的第一条记录包装在<code>Mono&lt;T&gt;</code>中。如果查询结果为空，则返回<code>Mono.empty()</code>。这适用于你只关心结果集的第一条记录，而不在乎是否还有其他记录的场景。</p></li><li><p><strong>用法</strong>: 在执行数据库查询操作时使用，当你只需要查询结果中的第一条记录。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Person&gt; person = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person&quot;</span>)</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        row.get(<span class="string">&quot;id&quot;</span>, Long.class), </span><br><span class="line">        row.get(<span class="string">&quot;name&quot;</span>, String.class), </span><br><span class="line">        row.get(<span class="string">&quot;age&quot;</span>, Integer.class)))</span><br><span class="line">    .first();</span><br></pre></td></tr></table></figure></div></li></ul><p><code>.all()</code></p><ul><li><p><strong>含义</strong>: 用于获取操作结果中的所有记录，返回一个包含所有结果的<code>Flux&lt;T&gt;</code>。这适用于你需要处理查询返回的所有记录的场景。</p></li><li><p><strong>用法</strong>: 在执行数据库查询操作时使用，特别是当你期望获取多条记录作为响应。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Person&gt; people = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person&quot;</span>)</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        row.get(<span class="string">&quot;id&quot;</span>, Long.class), </span><br><span class="line">        row.get(<span class="string">&quot;name&quot;</span>, String.class), </span><br><span class="line">        row.get(<span class="string">&quot;age&quot;</span>, Integer.class)))</span><br><span class="line">    .all();</span><br></pre></td></tr></table></figure></div></li></ul><p><code>.fetch()</code></p><ul><li><p><strong>含义</strong>: 该方法用于执行前面定义的SQL命令，并开始处理返回的结果。</p></li><li><p><strong>用法</strong>: 通常跟在<code>.sql()</code>和参数绑定方法（如<code>.bind()</code>）之后使用。</p><blockquote><p><code>.fetch()</code>方法用于指定如何处理SQL执行的结果，它返回一个<code>FetchSpec</code>，允许你使用<code>.rowsUpdated()</code>来获取受影响的行数(只对于增加、更新、删除等影响到实际数据的操作)。</p><p><code>fetch</code>同样可以结合<code>one</code>、<code>first</code>、<code>all</code>使用，但是因为<code>fetch</code>返回的是<code>FetchSpec&lt;Map&lt;String, Object&gt;&gt;</code>类型，需要手动强制转换，对于需要查询返回大量字段的操作不是很推荐，通常查询只返回单个字段或少量字段的可以使用。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">Mono&lt;Person&gt; person = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .one()</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        (Long) row.get(<span class="string">&quot;id&quot;</span>), </span><br><span class="line">        (String) row.get(<span class="string">&quot;name&quot;</span>), </span><br><span class="line">        (Integer) row.get(<span class="string">&quot;age&quot;</span>)));</span><br><span class="line"></span><br><span class="line">Mono&lt;Person&gt; person = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .first()</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        (Long) row.get(<span class="string">&quot;id&quot;</span>), </span><br><span class="line">        (String) row.get(<span class="string">&quot;name&quot;</span>), </span><br><span class="line">        (Integer) row.get(<span class="string">&quot;age&quot;</span>)));</span><br><span class="line"></span><br><span class="line">Flux&lt;Person&gt; person = databaseClient</span><br><span class="line">    .sql(<span class="string">&quot;SELECT * FROM person&quot;</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .all()</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(</span><br><span class="line">        (Long) row.get(<span class="string">&quot;id&quot;</span>), </span><br><span class="line">        (String) row.get(<span class="string">&quot;name&quot;</span>), </span><br><span class="line">        (Integer) row.get(<span class="string">&quot;age&quot;</span>)));</span><br></pre></td></tr></table></figure></div><h3 id="比较两个版本"><a class="markdownIt-Anchor" href="#比较两个版本"></a> 比较两个版本</h3><ul><li><strong><code>fetch</code>版本</strong>：遵循了更常见的Spring Data R2DBC使用模式，即先执行<code>.fetch().all()</code>获取查询结果，然后通过<code>.map()</code>转换。</li><li><strong><code>map</code>版本</strong>：利用了Spring Data R2DBC提供的一个更直接的映射策略，允许在定义SQL之后立即应用映射函数。这个方法的优势在于代码更简洁，但可能在某些情况下减少了对查询结果处理流程的可见性。</li></ul></blockquote></li></ul><p><code>.rowsUpdated()</code></p><ul><li><p><strong>含义</strong>: 在执行更新、插入或删除操作后，<code>.rowsUpdated()</code>用于返回受这些操作影响的行数。</p></li><li><p><strong>用法</strong>: 用于确认操作影响了多少行数据。这个方法只会在增删改等影响实际数据的操作中使用。</p><blockquote><p><code>.fetch().rowsUpdated()</code>组合使用返回受影响的行数。</p></blockquote></li></ul><p>CRUD 操作示例 <strong>(在数据访问层实现)</strong></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">person.setName(<span class="string">&quot;John Doe&quot;</span>);</span><br><span class="line">person.setAge(<span class="number">25</span>);</span><br><span class="line">Mono&lt;Person&gt; savedPerson = databaseClient.sql(<span class="string">&quot;INSERT INTO person (name, age) VALUES (:name, :age)&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;name&quot;</span>, person.getName())</span><br><span class="line">    .bind(<span class="string">&quot;age&quot;</span>, person.getAge())</span><br><span class="line">    .fetch()</span><br><span class="line">    .rowsUpdated();</span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line">Mono&lt;Long&gt; deleteResult = databaseClient.sql(<span class="string">&quot;DELETE FROM person WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .rowsUpdated();</span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line">Mono&lt;Long&gt; updateResult = databaseClient.sql(<span class="string">&quot;UPDATE person SET name = :name WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;Jane Doe&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .fetch()</span><br><span class="line">    .rowsUpdated();</span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line"><span class="comment">// 查询单个结果</span></span><br><span class="line">Mono&lt;Person&gt; person = databaseClient.sql(<span class="string">&quot;SELECT * FROM person WHERE id = :id&quot;</span>)</span><br><span class="line">    .bind(<span class="string">&quot;id&quot;</span>, <span class="number">1</span>)</span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="comment">/* initialize properties from row */</span>))</span><br><span class="line">    .one();</span><br><span class="line"><span class="comment">// 查询多个结果</span></span><br><span class="line">Flux&lt;Person&gt; people = databaseClient.sql(<span class="string">&quot;SELECT * FROM person&quot;</span>)    </span><br><span class="line">    .map(row -&gt; <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="comment">/* initialize properties from row */</span>))</span><br><span class="line">    .all();</span><br></pre></td></tr></table></figure></div><p>批量增删改操作示例</p><blockquote><p>对于批量操作，更推荐的做法是使用请求体（Request Body）来传递数据，特别是使用<code>POST</code>或<code>PUT</code>方法时。这样可以无限制地传递大量数据，同时保持URL的简洁和安全性。</p></blockquote><p>普通版本</p><ul><li><p>批量增加操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Person&gt; persons = Flux.just(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="number">25</span>), <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Jane Doe&quot;</span>, <span class="number">30</span>));</span><br><span class="line">Mono&lt;Long&gt; insertResults = persons.flatMap(person -&gt;</span><br><span class="line">    databaseClient.sql(<span class="string">&quot;INSERT INTO person (name, age) VALUES (:name, :age)&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;name&quot;</span>, person.getName())</span><br><span class="line">        .bind(<span class="string">&quot;age&quot;</span>, person.getAge())</span><br><span class="line">        .fetch()</span><br><span class="line">        .rowsUpdated()</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum); <span class="comment">// 计数所有操作的总影响行数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">List&lt;Person&gt; persons = Arrays.asList(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="number">25</span>), <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Jane Doe&quot;</span>, <span class="number">30</span>));</span><br><span class="line">Mono&lt;Long&gt; insertResults = Flux.fromIterable(persons)</span><br><span class="line">    .flatMap(person -&gt;</span><br><span class="line">        databaseClient.sql(<span class="string">&quot;INSERT INTO person (name, age) VALUES (:name, :age)&quot;</span>)</span><br><span class="line">            .bind(<span class="string">&quot;name&quot;</span>, person.getName())</span><br><span class="line">            .bind(<span class="string">&quot;age&quot;</span>, person.getAge())</span><br><span class="line">            .fetch()</span><br><span class="line">            .rowsUpdated()</span><br><span class="line">    ).reduce(<span class="number">0L</span>, Long::sum);</span><br></pre></td></tr></table></figure></div><blockquote><p><code>count</code>和<code>reduce</code>都是统计总数的方法，不过<code>count</code>统计的是流中元素的数量，是操作的总数，而<code>reduce</code>统计的是实际操作成功的总数。</p></blockquote></li><li><p>批量删除操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Flux&lt;Long&gt; idsToDelete = Flux.just(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>); <span class="comment">// 假设这是要删除的ID列表</span></span><br><span class="line">Mono&lt;Long&gt; deleteResults = idsToDelete.collectList().flatMap(ids -&gt;</span><br><span class="line">    databaseClient.sql(<span class="string">&quot;DELETE FROM person WHERE id IN (:ids)&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">        .fetch()</span><br><span class="line">        .rowsUpdated()</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">List&lt;Long&gt; idsToDelete = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">Mono&lt;Long&gt; deleteResults = Flux.fromIterable(idsToDelete)</span><br><span class="line">    .collectList()</span><br><span class="line">    .flatMap(ids -&gt;</span><br><span class="line">        databaseClient.sql(<span class="string">&quot;DELETE FROM person WHERE id IN (:ids)&quot;</span>)</span><br><span class="line">            .bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">            .fetch()</span><br><span class="line">            .rowsUpdated()</span><br><span class="line">    );</span><br></pre></td></tr></table></figure></div></li><li><p>批量更新操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设要将所有指定ID的人的年龄更新为30</span></span><br><span class="line">Flux&lt;Long&gt; idsToUpdate = Flux.just(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">Mono&lt;Long&gt; updateResults = idsToUpdate.flatMap(ids -&gt;</span><br><span class="line">    databaseClient.sql(<span class="string">&quot;UPDATE person SET age = :age WHERE id = (:ids)&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;age&quot;</span>, <span class="number">30</span>)</span><br><span class="line">        .bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">        .fetch()</span><br><span class="line">        .rowsUpdated()</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line">List&lt;Long&gt; idsToUpdate = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">Mono&lt;Long&gt; updateResults = Flux.fromIterable(idsToUpdate)</span><br><span class="line">    .flatMap(ids -&gt;</span><br><span class="line">        databaseClient.sql(<span class="string">&quot;UPDATE person SET age = :age WHERE id = (:ids)&quot;</span>)</span><br><span class="line">    		.bind(<span class="string">&quot;age&quot;</span>, <span class="number">30</span>)</span><br><span class="line">        	.bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">        	.fetch()</span><br><span class="line">        	.rowsUpdated()</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum);</span><br></pre></td></tr></table></figure></div></li></ul><p><code>Flux.defer</code>版本</p><ul><li><p>批量增加操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Person&gt; persons = Arrays.asList(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="number">25</span>), <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Jane Doe&quot;</span>, <span class="number">30</span>));</span><br><span class="line">Mono&lt;Long&gt; insertResults = Flux.defer(() -&gt; </span><br><span class="line">    Flux.fromIterable(persons)</span><br><span class="line">        .flatMap(person -&gt;</span><br><span class="line">            databaseClient.sql(<span class="string">&quot;INSERT INTO person (name, age) VALUES (:name, :age)&quot;</span>)</span><br><span class="line">                .bind(<span class="string">&quot;name&quot;</span>, person.getName())</span><br><span class="line">                .bind(<span class="string">&quot;age&quot;</span>, person.getAge())</span><br><span class="line">                .fetch()</span><br><span class="line">                .rowsUpdated()</span><br><span class="line">        )</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum);</span><br></pre></td></tr></table></figure></div></li><li><p>批量删除操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; idsToDelete = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">Mono&lt;Long&gt; deleteResults = Flux.defer(() -&gt; </span><br><span class="line">    Flux.fromIterable(idsToDelete)</span><br><span class="line">        .collectList()</span><br><span class="line">        .flatMap(ids -&gt;</span><br><span class="line">            databaseClient.sql(<span class="string">&quot;DELETE FROM person WHERE id IN (:ids)&quot;</span>)</span><br><span class="line">                .bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">                .fetch()</span><br><span class="line">                .rowsUpdated()</span><br><span class="line">        )</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum);</span><br></pre></td></tr></table></figure></div></li><li><p>批量修改操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">List&lt;Long&gt; idsToUpdate = Arrays.asList(<span class="number">1L</span>, <span class="number">2L</span>, <span class="number">3L</span>);</span><br><span class="line">Mono&lt;Long&gt; updateResults = Flux.defer(() -&gt; </span><br><span class="line">	Flux.fromIterable(idsToUpdate)</span><br><span class="line">    .flatMap(ids -&gt;</span><br><span class="line">        databaseClient.sql(<span class="string">&quot;UPDATE person SET age = :age WHERE id = (:ids)&quot;</span>)</span><br><span class="line">    		.bind(<span class="string">&quot;age&quot;</span>, <span class="number">30</span>)</span><br><span class="line">        	.bind(<span class="string">&quot;ids&quot;</span>, ids)</span><br><span class="line">        	.fetch()</span><br><span class="line">        	.rowsUpdated()</span><br><span class="line">).reduce(<span class="number">0L</span>, Long::sum);</span><br></pre></td></tr></table></figure></div></li></ul><blockquote><p>使用<code>Flux.defer</code>适合于某些特定的场景，主要是当你想确保每次订阅时都执行最新的操作逻辑，特别是在处理动态数据或需要确保操作使用最新状态的场景下。<code>Flux.defer</code>通过延迟操作的创建直到订阅发生，可以确保数据的实时性和操作的最新性。然而，并不是所有场景都适合使用<code>Flux.defer</code>。下面是一些考虑因素：</p><h3 id="适合使用fluxdefer的场景"><a class="markdownIt-Anchor" href="#适合使用fluxdefer的场景"></a> 适合使用<code>Flux.defer</code>的场景</h3><ul><li><strong>动态数据源</strong>：当数据源是动态变化的，比如依赖于时间或外部系统状态，使用<code>Flux.defer</code>可以确保每次订阅都获取最新数据。</li><li><strong>避免不必要的计算</strong>：如果有一些计算成本较高的操作，你只想在实际需要数据时才执行，<code>Flux.defer</code>可以帮助避免不必要的计算。</li><li><strong>条件性操作</strong>：当操作需要基于每次订阅时的特定条件来执行，使用<code>Flux.defer</code>可以确保操作符合当前的条件。</li></ul><h3 id="不适合使用fluxdefer的场景"><a class="markdownIt-Anchor" href="#不适合使用fluxdefer的场景"></a> 不适合使用<code>Flux.defer</code>的场景</h3><ul><li><strong>静态数据或一次性计算</strong>：对于不会改变的数据或只需要计算一次的操作，使用<code>Flux.defer</code>可能没有必要，直接使用<code>Flux.just</code>或<code>Mono.just</code>等操作可能更合适。</li><li><strong>共享操作结果</strong>：如果你想让所有订阅者共享同一个操作结果，而不是为每个订阅者重新执行操作，那么<code>Flux.defer</code>不是一个好选择。在这种情况下，可以考虑使用<code>.cache()</code>操作符。</li><li><strong>需要即时执行的操作</strong>：由于<code>Flux.defer</code>会延迟操作直到订阅发生，如果你需要在定义流的同时立即执行某些操作（例如，预加载数据），<code>Flux.defer</code>可能不适合。</li></ul></blockquote><h5 id="关于响应式-defer-的理解"><a class="markdownIt-Anchor" href="#关于响应式-defer-的理解"></a> 关于响应式 <code>defer</code> 的理解</h5><ol><li><strong>对于动态或实时数据</strong>：如果操作涉及获取可能随时间变化的数据，或者其结果依赖于当前的系统状态（如数据库中的数据、系统时间或外部服务的状态），那么使用<code>defer</code>是合适的。这确保了每次订阅都能获取到最新的数据，避免了由于早期执行而可能导致的数据过时问题。</li><li><strong>避免抢注问题</strong>：在用户注册的场景中，使用<code>defer</code>可以确保在订阅（也就是实际执行注册逻辑）的时刻检查用户名是否已存在。这有助于减少因多个用户几乎同时注册相同用户名而导致的冲突。</li><li><strong>非一成不变的数据</strong>：对于不是一成不变的数据，特别是那些可能受到外部状态影响的操作，使用<code>defer</code>来延迟操作的创建和执行，直到订阅发生，是一个很好的实践。这样做可以确保操作的执行反映了最新的状态，提高了程序的健壮性和数据的准确性。</li><li><strong>有副作用的操作</strong>：如果操作具有副作用（如修改数据库、调用外部服务等），使用<code>Mono.defer</code>确保副作用操作在每次订阅时执行，而不是在声明阶段就执行，这有助于更好地控制副作用的发生时机。</li></ol><p><strong>通俗理解</strong></p><ul><li>如果结果可能随着时间或状态的变化而变化，或者操作具有副作用，那么使用<code>defer</code>。</li><li>对于静态的、确定不变的数据或结果，直接使用<code>Mono.just</code>或<code>Flux.fromIterable</code>等其他不涉及延迟执行的操作符即可。</li></ul><p>不过，如果完全采用响应式编程，大部分情况下，都不需要显式地使用<code>defer</code>。</p><p><code>defer</code>在响应式编程中通常在以下几种情况下需要显式使用：</p><ol><li><p><strong>确保操作延迟执行</strong>：当你需要确保某个操作（如数据库查询、外部服务调用等）确实在每次订阅时执行，而不是在声明流时就执行。这对于包含时间相关的操作或依赖于每次请求可能不同的上下文信息的操作尤其重要。</p></li><li><p><strong>使用动态或实时参数</strong>：当操作的参数在声明流的时间点可能还不确定，或者参数值可能随时间变化（例如，依赖于用户的实时输入或其他变化的系统状态）时，<code>defer</code>可以确保参数是在实际执行操作时才被评估和使用。</p></li><li><p><strong>避免副作用的预先执行</strong>：如果某个操作具有副作用（比如修改全局状态或外部资源），使用<code>defer</code>可以防止这些副作用在不适当的时间（如流声明时）就发生，确保副作用操作在订阅时才执行。</p></li><li><p><strong>封装非响应式操作</strong>：当需要将非响应式操作（比如传统的同步方法调用）转换为响应式流时，<code>defer</code>可以用来封装这些操作，确保它们在响应式上下文中以非阻塞的方式延迟执行。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactiveService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 假设这是一个非响应式的同步操作</span></span><br><span class="line">    String <span class="title function_">nonReactiveOperation</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 模拟一些耗时操作，比如数据库查询或远程服务调用</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>); <span class="comment">// 模拟耗时</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;非响应式操作的结果&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用Mono.defer封装非响应式操作</span></span><br><span class="line">    Mono&lt;String&gt; <span class="title function_">wrapNonReactiveOperationWithDefer</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.defer(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 调用非响应式的同步操作，并将其结果封装为Mono</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> nonReactiveOperation();</span><br><span class="line">            <span class="keyword">return</span> Mono.just(result);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ol><h4 id="整合-reactive-mongodb-reactive-redis"><a class="markdownIt-Anchor" href="#整合-reactive-mongodb-reactive-redis"></a> 整合 Reactive MongoDB、Reactive Redis</h4><h5 id="文档存储"><a class="markdownIt-Anchor" href="#文档存储"></a> 文档存储</h5><p>文档存储是一种非关系型数据库（NoSQL）存储方式，它以文档的形式存储和管理数据。文档存储数据库将数据存储为文档，这些文档可以是JSON、XML或其他类似的格式。文档内部可以包含嵌套的数据结构，如列表或字典，从而允许存储复杂的数据结构。文档存储数据库的例子包括 MongoDB、CouchDB 和 Amazon DynamoDB 等。</p><p>文档存储与传统的关系型数据库存储（如MySQL、PostgreSQL等）相比，主要有以下区别：</p><ol><li><strong>数据模型</strong>：关系型数据库基于表格模型，数据以行和列的形式存储，且每个表格通常需要预定义的模式（schema）。文档存储数据库则以更灵活的文档格式存储数据，每个文档可以有不同的结构，不需要预定义模式。</li><li><strong>灵活性</strong>：文档存储数据库因其无模式（schema-less）特性而提供更高的灵活性，便于存储结构化或半结构化数据，同时也更容易适应数据结构的变化。</li><li><strong>查询语言</strong>：关系型数据库使用标准的SQL作为查询语言，而文档存储数据库使用基于文档的查询语言，这些语言通常更适合于处理文档型数据。</li><li><strong>扩展性</strong>：文档存储数据库通常更容易水平扩展，支持分布式数据存储，而关系型数据库的扩展通常更复杂，尤其是在处理大规模数据时。</li><li><strong>一致性和事务处理</strong>：传统的关系型数据库通常提供强一致性和复杂的事务处理特性。相比之下，许多文档存储数据库采用最终一致性模型，并可能提供较为有限的事务处理能力，虽然一些文档存储数据库（如最新版本的MongoDB）已开始支持更复杂的事务处理。</li><li><strong>用例</strong>：文档存储数据库适合于需要存储大量非结构化或半结构化数据的应用场景，如内容管理系统、电商平台等。而关系型数据库则适合于需要复杂查询和事务处理的传统企业级应用。</li></ol><h5 id="键值对存储"><a class="markdownIt-Anchor" href="#键值对存储"></a> 键值对存储</h5><p>键值对存储是一种简单的数据存储模型，它通过键（key）来访问和存储数据值（value）。这种模型类似于字典或哈希表，其中每个键唯一对应一个值。键值对存储系统通常用于缓存、会话存储、简单的数据记录等场景。与文档存储和关系型数据库相比，键值对存储提供了高速的查找和存储能力，但在数据结构的复杂性和查询能力上相对有限。键值对存储数据库的典型例子就是 Redis。</p><p>以下是键值对存储方式的一些主要特点和与传统数据库存储的区别：</p><ol><li><strong>数据模型简单</strong>：键值对存储的数据模型极其简单，每个键对应一个值，值可以是字符串、数字或者更复杂的数据结构（取决于具体的键值对存储系统）。不同于关系型数据库的行和列或文档存储的JSON文档，键值对存储不关心值的内部结构。</li><li><strong>高性能</strong>：由于数据模型的简单，键值对存储能够提供非常高的读写性能。这使得键值对存储非常适合用作应用程序的缓存层，可以快速响应数据读取请求。</li><li><strong>易于扩展</strong>：键值对存储通常支持水平扩展，可以通过添加更多节点来增加数据库的容量和吞吐量，而不需要复杂的数据迁移或重构。</li><li><strong>灵活性</strong>：虽然键值对存储的数据模型相对简单，但其值的存储格式可以非常灵活。一些键值对存储系统允许存储复杂的数据结构作为值，如列表、集合或哈希表等。</li><li><strong>有限的查询能力</strong>：与关系型数据库或文档存储相比，键值对存储的查询能力较为有限。通常，只能通过键直接访问数据，缺乏对值的复杂查询能力，如基于值的内容进行搜索或过滤。</li><li><strong>适用场景</strong>：键值对存储特别适合于需要快速读写访问的场景，如缓存、会话存储（session storage）、实时计数器等。它不适合需要复杂查询或数据关联分析的应用。</li></ol><blockquote><p>关于 MongoDB 和 Redis 的详细介绍参考<a class="link" target="_blank" rel="noopener" href="https://www.runoob.com/mongodb/mongodb-tutorial.html">MongoDB 教程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 和 <a class="link" target="_blank" rel="noopener" href="https://www.runoob.com/redis/redis-tutorial.html">Redis 教程 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>。</p></blockquote><h5 id="连接配置-2"><a class="markdownIt-Anchor" href="#连接配置-2"></a> 连接配置</h5><p>配置 application.yaml 文件，参考如下</p><div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># ... r2dbc 的配置内容</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://localhost:27017/your_database</span> <span class="comment"># MongoDB连接URI</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">      <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">reactive:</span></span><br><span class="line">        <span class="attr">pool:</span></span><br><span class="line">          <span class="attr">max-active:</span> <span class="number">8</span> <span class="comment"># 根据需要调整连接池大小</span></span><br></pre></td></tr></table></figure></div><p>这里的<code>your_database</code>是自定义的数据库名称，它会在保存数据时自动创建，不需要手动创建。</p><p>特别的，对于 Redis，由于其本身的技术特性和数据模型，导致其无法通过简单的声明式配置实现，通常还需要专门的编程式配置，即配置类。</p><p>下面提供了两种配置类：</p><blockquote><p>注意：部分基础配置已经在前面的 application.yaml 中配置完成，下面的配置都是高度自定义的配置。</p></blockquote><p>使用<code>Jackson2JsonRedisSerializer</code>配置</p><p>当使用<code>Jackson2JsonRedisSerializer</code>时，你需要为每种类型提供一个序列化器实例。这意味着如果你有多种类型的数据需要存储，你可能需要为每种类型配置不同的<code>ReactiveRedisTemplate</code>实例。不过，通常情况下，一个应用中使用单一类型的情况较多。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonRedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; ReactiveRedisTemplate&lt;String, T&gt; <span class="title function_">reactiveRedisTemplateWithJackson</span><span class="params">(ReactiveRedisConnectionFactory connectionFactory, Class&lt;T&gt; type)</span> &#123;</span><br><span class="line">        Jackson2JsonRedisSerializer&lt;T&gt; valueSerializer = <span class="keyword">new</span> <span class="title class_">Jackson2JsonRedisSerializer</span>&lt;&gt;(type);</span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">keySerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        </span><br><span class="line">        RedisSerializationContext.RedisSerializationContextBuilder&lt;String, T&gt; builder =</span><br><span class="line">                RedisSerializationContext.newSerializationContext(keySerializer);</span><br><span class="line">        RedisSerializationContext&lt;String, T&gt; context = builder.value(valueSerializer).build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveRedisTemplate</span>&lt;&gt;(connectionFactory, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>使用<code>GenericJackson2JsonRedisSerializer</code>配置</p><p><code>GenericJackson2JsonRedisSerializer</code>的一个优点是它可以在序列化时包含类型信息，从而支持多种类型的数据而无需为每种类型提供单独的序列化器实例。这使得它在处理多种数据类型的场景下更为方便。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GenericJacksonRedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ReactiveRedisTemplate&lt;String, Object&gt; <span class="title function_">reactiveRedisTemplateWithGenericJackson</span><span class="params">(ReactiveRedisConnectionFactory connectionFactory)</span> &#123;</span><br><span class="line">        <span class="comment">// 创建一个定制化的ObjectMapper实例</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        mapper.registerModule(<span class="keyword">new</span> <span class="title class_">JavaTimeModule</span>()); <span class="comment">// 注册JavaTimeModule</span></span><br><span class="line">        mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); <span class="comment">// 确保Java 8日期/时间类型以ISO格式序列化</span></span><br><span class="line">        mapper.findAndRegisterModules(); <span class="comment">// 自动注册所有可用的模块（包括JavaTimeModule）</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用定制化的ObjectMapper实例创建GenericJackson2JsonRedisSerializer</span></span><br><span class="line">        <span class="type">GenericJackson2JsonRedisSerializer</span> <span class="variable">valueSerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GenericJackson2JsonRedisSerializer</span>(mapper);</span><br><span class="line">        <span class="comment">// 上面的配置是为了支持LocalDate、LocalTime、LocalDateTime的序列化</span></span><br><span class="line">        <span class="comment">// GenericJackson2JsonRedisSerializer valueSerializer = new GenericJackson2JsonRedisSerializer();</span></span><br><span class="line">        <span class="type">StringRedisSerializer</span> <span class="variable">keySerializer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringRedisSerializer</span>();</span><br><span class="line">        </span><br><span class="line">        RedisSerializationContext.RedisSerializationContextBuilder&lt;String, Object&gt; builder =</span><br><span class="line">                RedisSerializationContext.newSerializationContext(keySerializer);</span><br><span class="line">        RedisSerializationContext&lt;String, Object&gt; context = builder.value(valueSerializer).build();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ReactiveRedisTemplate</span>&lt;&gt;(connectionFactory, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>对比</p><ul><li>如果你的应用主要处理单一类型的数据或者你需要对序列化过程有更细致的控制，<code>Jackson2JsonRedisSerializer</code>可能是一个好的选择。</li><li>如果你需要在Redis中存储多种类型的数据，并希望简化序列化和反序列化的处理，那么<code>GenericJackson2JsonRedisSerializer</code>可能更适合你的需求。</li></ul><p>通常<code>GenericJackson2JsonRedisSerializer</code>通用性更强，但是由于其类型自动处理的功能导致在某些情况下性能不如<code>Jackson2JsonRedisSerializer</code>高，而且生成的 json 数据包含了类型信息，不如<code>Jackson2JsonRedisSerializer</code>简洁，不方便开发者进行调试。此外，初学者学习推荐先从<code>Jackson2JsonRedisSerializer</code>开始再到<code>GenericJackson2JsonRedisSerializer</code>。</p><blockquote><h2 id="不同的配置方式"><a class="markdownIt-Anchor" href="#不同的配置方式"></a> 不同的配置方式</h2><p>在Spring Boot应用中，通过<code>application.properties</code>或<code>application.yml</code>文件进行配置属于<strong>声明式配置</strong>。这种方式允许开发者以简洁明了的形式指定应用配置，而无需编写额外的代码。Spring Boot的自动配置特性会根据这些属性以及应用的依赖关系自动设置合理的默认配置。</p><h3 id="声明式配置"><a class="markdownIt-Anchor" href="#声明式配置"></a> 声明式配置</h3><p><strong>声明式配置</strong>通常用于配置数据库连接、应用参数、日志级别等。例如，配置MongoDB和PostgreSQL的连接信息：</p><div class="highlight-container" data-rel="Yaml"><figure class="iseeu highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MongoDB</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://username:password@localhost:27017/databaseName</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PostgreSQL</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:postgresql://localhost:5432/databaseName</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">password</span></span><br></pre></td></tr></table></figure></div><h3 id="编程式配置"><a class="markdownIt-Anchor" href="#编程式配置"></a> 编程式配置</h3><p><strong>编程式配置</strong>涉及创建配置类（通常带有<code>@Configuration</code>注解的类），在这些类中，你可以使用Java代码定义Bean和配置应用程序的行为。这种方式提供了更高的灵活性和控制力，适用于需要根据复杂逻辑或条件动态决定配置的场景。</p><p>例如，创建Redis的配置类：</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedisConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LettuceConnectionFactory <span class="title function_">redisConnectionFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LettuceConnectionFactory</span>(<span class="keyword">new</span> <span class="title class_">RedisStandaloneConfiguration</span>(<span class="string">&quot;localhost&quot;</span>, <span class="number">6379</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="其他配置方式"><a class="markdownIt-Anchor" href="#其他配置方式"></a> 其他配置方式</h3><p>除了声明式配置和编程式配置，Spring Boot还支持通过<strong>环境变量</strong>、<strong>命令行参数</strong>、<strong>外部配置文件</strong>等多种方式来覆盖或指定配置。这提供了极大的灵活性，使得同一个应用可以在不同环境下使用不同的配置。</p><h3 id="使用配置类配置mongodb和postgresql"><a class="markdownIt-Anchor" href="#使用配置类配置mongodb和postgresql"></a> 使用配置类配置MongoDB和PostgreSQL</h3><p>理论上，你也可以使用配置类去配置MongoDB和PostgreSQL，就像配置Redis那样。然而，考虑到Spring Boot提供了对这些数据库的广泛自动配置支持，通常没有必要手动创建这些配置类。通过声明式配置，你可以更加简洁地利用Spring Boot的自动配置特性，减少样板代码，同时也能够更容易地管理和修改配置。在大多数Spring Boot应用中，采用声明式配置来利用Spring Boot的自动配置功能通常更为简便和高效。这样做不仅减少了配置的复杂性，也使得配置更加集中和易于管理。只有在需要高度自定义配置或Spring Boot的自动配置不能满足需求时，才考虑使用编程式配置。</p></blockquote><h5 id="代码实现方式-2"><a class="markdownIt-Anchor" href="#代码实现方式-2"></a> 代码实现方式</h5><p>MongoDB 也有类似于 R2DBC 的 <code>ReactiveMongoRepository</code>(继承了<code>ReactiveCrudRepository</code>接口)，提供了类似的数据访问方式：自带的方法实现、方法名解析、自定义方法(<code>ReactiveMongoTemplate</code>实现)等。</p><p>Redis 则没有响应式接口支持，需要自定义实现，主要是通过<code>ReactiveRedisTemplate</code>实现数据库操作。</p><p><strong>实体类注解</strong></p><p>关于实体类，MongoDB 提供了一些相关的注解</p><ul><li><p><strong>@Document</strong>: 用于指定实体类对应的MongoDB集合（collection）。可以通过<code>collection</code>属性指定集合的名称，如果不指定，默认使用类的名称（首字母小写）。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document(collection = &quot;departments&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Department</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>@Id</strong>: 用于标记实体类中的属性作为文档的ID。MongoDB文档总是有一个<code>_id</code>字段作为唯一标识符，使用此注解可以映射类的属性到这个字段。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Id</span></span><br><span class="line"><span class="keyword">private</span> String id;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>@Field</strong>: 用于指定实体类属性映射到文档中的字段。可以通过它自定义字段的名称。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Field(&quot;dept_name&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String departmentName;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>@Indexed</strong>: 用于标记一个字段应该被索引。这对于提高查询性能非常有用，特别是对于经常作为查询条件的字段。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Indexed(unique = true)</span></span><br><span class="line"><span class="keyword">private</span> String departmentCode;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>@Transient</strong>: 标记为<code>@Transient</code>的字段不会被持久化到MongoDB中。这对于临时状态或计算得出的属性很有用。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> memberCount;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>@CompoundIndex</strong>: 用于类级别，指定复合索引。这可以用来在多个字段上创建索引，以优化特定类型的查询。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Document</span></span><br><span class="line"><span class="meta">@CompoundIndex(def = &quot;&#123;&#x27;departmentCode&#x27;: 1, &#x27;departmentName&#x27;: -1&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Department</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ul><p>Redis 关于实体类的注解没有那么多，主要是以下几个，部分注解是通用的。</p><ul><li><strong>@RedisHash</strong>: 用于类，标记该类的对象将被存储在Redis的哈希结构中。<code>@RedisHash</code>注解可以接受一个可选的参数，用于指定在Redis中存储时使用的哈希的名称。</li><li><strong>@Id</strong>: 用于标记实体的id字段，这个字段的值将被用作Redis哈希结构中的key。</li><li><strong>@Indexed</strong>: 可以用于字段上，表示该字段将被索引，适用于进行查询操作。</li><li><strong>@TimeToLive</strong>: 可以用于字段上，指定一个实体或其部分的过期时间（生存时间）。</li></ul><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RedisHash(&quot;people&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Indexed</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TimeToLive</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Long</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="number">86400L</span>; <span class="comment">// 生存时间设置为24小时（86400秒）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略构造函数、Getter和Setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><strong>注意：使用 Redis 缓存的数据都需要实现可序列化接口<code>Serializable</code>。</strong></p><p><strong>CRUD 操作示例</strong></p><p>由于 Reactive MongoDB 的<code>ReactiveMongoRepository</code>是继承<code>ReactiveCrudRepository</code>接口实现的，这里只介绍自定义方法实现，即通过<code>ReactiveMongoTemplate</code>实现。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加</span></span><br><span class="line"><span class="comment">// 单个对象</span></span><br><span class="line"><span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="number">30</span>);</span><br><span class="line">Mono&lt;Person&gt; insertMono = reactiveMongoTemplate.insert(person);</span><br><span class="line"><span class="comment">// 多个对象</span></span><br><span class="line">List&lt;Person&gt; persons = Arrays.asList(<span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;John Doe&quot;</span>, <span class="number">30</span>), <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Jane Doe&quot;</span>, <span class="number">25</span>));</span><br><span class="line">Flux&lt;Person&gt; insertFlux = reactiveMongoTemplate.insertAll(persons);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除</span></span><br><span class="line"><span class="comment">// 单个对象</span></span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;John Doe&quot;</span>));</span><br><span class="line">Mono&lt;DeleteResult&gt; deleteMono = reactiveMongoTemplate.remove(query, Person.class);</span><br><span class="line"><span class="comment">// 多个对象</span></span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;age&quot;</span>).lt(<span class="number">25</span>));</span><br><span class="line">Mono&lt;DeleteResult&gt; deleteMono = reactiveMongoTemplate.remove(query, Person.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新</span></span><br><span class="line"><span class="comment">// 单个对象</span></span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;John Doe&quot;</span>));</span><br><span class="line"><span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>().set(<span class="string">&quot;age&quot;</span>, <span class="number">31</span>);</span><br><span class="line">Mono&lt;UpdateResult&gt; updateMono = reactiveMongoTemplate.updateFirst(query, update, Person.class);</span><br><span class="line"><span class="comment">// 多个对象</span></span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;age&quot;</span>).lt(<span class="number">30</span>));</span><br><span class="line"><span class="type">Update</span> <span class="variable">update</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Update</span>().set(<span class="string">&quot;status&quot;</span>, <span class="string">&quot;active&quot;</span>);</span><br><span class="line">Mono&lt;UpdateResult&gt; updateMono = reactiveMongoTemplate.updateMulti(query, update, Person.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查询</span></span><br><span class="line"><span class="comment">// 单个对象</span></span><br><span class="line">Mono&lt;Person&gt; personMono = reactiveMongoTemplate.findById(<span class="string">&quot;someId&quot;</span>, Person.class);</span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;name&quot;</span>).is(<span class="string">&quot;John Doe&quot;</span>)); <span class="comment">// 或者使用查询对象 Query</span></span><br><span class="line">Mono&lt;Person&gt; personMono = reactiveMongoTemplate.findOne(query, Person.class);</span><br><span class="line"><span class="comment">// 多个对象</span></span><br><span class="line"><span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;age&quot;</span>).gt(<span class="number">20</span>));</span><br><span class="line">Flux&lt;Person&gt; personsFlux = reactiveMongoTemplate.find(query, Person.class);</span><br></pre></td></tr></table></figure></div><blockquote><p>上述示例中的<code>UpdateResult</code>和<code>DeleteResult</code>是来自于<code>com.mongodb.reactivestreams.client</code>包，它们提供了操作的结果信息，比如影响的文档数量等。</p></blockquote><p>Redis 也有类似的 CRUD 操作，但是需要考虑更多的模式和策略。</p><p>下面先给出 CRUD 操作的示例</p><p><strong>单对象 CRUD 操作</strong></p><ol><li><p>创建或更新（单个对象）</p><p>使用<code>ReactiveRedisTemplate</code>的<code>opsForValue().set()</code>方法可以存储单个对象。如果键已存在，它会被更新。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">savePerson</span><span class="params">(Person person)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;person:&quot;</span> + person.getId();</span><br><span class="line">    <span class="keyword">return</span> reactiveRedisTemplate.opsForValue().set(key, person);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p>查询（单个对象）</p><p>使用<code>opsForValue().get()</code>方法根据键查询单个对象。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Person&gt; <span class="title function_">findPerson</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;person:&quot;</span> + id;</span><br><span class="line">    <span class="keyword">return</span> reactiveRedisTemplate.opsForValue().get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p>删除（单个对象）</p><p>使用<code>delete()</code>方法根据键删除单个对象。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">deletePerson</span><span class="params">(String id)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> <span class="string">&quot;person:&quot;</span> + id;</span><br><span class="line">    <span class="keyword">return</span> reactiveRedisTemplate.opsForValue().delete(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ol><p><strong>多对象 CRUD 操作</strong></p><ol><li><p>创建或更新（多个对象）</p><p>Redis 并不直接支持一次性创建或更新多个对象的操作。你需要对每个对象进行遍历并分别调用设置方法。这可以通过<code>Flux</code>来实现。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Flux&lt;Boolean&gt; <span class="title function_">savePersons</span><span class="params">(List&lt;Person&gt; persons)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(persons)</span><br><span class="line">        .flatMap(person -&gt; savePerson(person)); <span class="comment">// savePerson 就是前面单对象操作中的实现方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p>查询（多个对象）</p><p>查询多个对象通常涉及到根据多个键查询。在Redis中，可以使用<code>Flux</code>来遍历键并查询。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Flux&lt;Person&gt; <span class="title function_">findPersons</span><span class="params">(List&lt;String&gt; ids)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(ids)</span><br><span class="line">        .flatMap(id -&gt; findPerson(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p>删除（多个对象）</p><p>删除多个对象也需要对每个键进行遍历并删除。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Flux&lt;Boolean&gt; <span class="title function_">deletePersons</span><span class="params">(List&lt;String&gt; ids)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Flux.fromIterable(ids)</span><br><span class="line">        .flatMap(id -&gt; deletePerson(id));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ol><p><strong>实现策略</strong></p><p>存储多对象数据</p><ol><li><strong>每个对象存储一份数据</strong>：这种方式适合于需要频繁访问或更新单个对象的场景。通过使用唯一键为每个对象存储一份数据，可以快速地访问和更新单个对象而不影响其他对象。</li><li><strong>存储对象集合</strong>：当需要一次性加载或处理多个对象时，可以将这些对象作为一个集合存储。这种方式适用于数据一致性要求不高或同时操作整个集合的场景。例如，可以将对象序列化为JSON数组存储在单个键下。</li></ol><p>Redis中的 CRUD 和缓存失效策略</p><ul><li><strong>创建和更新（C和U）</strong>：在Redis中创建和更新操作通常是通过设置键值对来完成的。如果数据发生变化，直接更新对应的键值对即可。对于缓存场景，如果是更新操作，通常会直接更新缓存中的数据，或者删除缓存中的旧数据让其在下次访问时重新加载。</li><li><strong>读取（R）</strong>：读取操作是Redis中最常见的用例之一，特别是作为缓存时。由于Redis的读取性能非常高，它非常适合用作频繁读取的数据的缓存。</li><li><strong>删除（D）</strong>：在数据变更或不再需要时，可以通过删除操作移除Redis中的数据。对于缓存，当底层数据发生变化导致缓存数据过时时，常见的做法是直接删除缓存中的数据，避免提供过时的信息。</li></ul><p>缓存失效策略</p><ul><li><strong>主动失效</strong>：应用程序在更新底层数据时主动删除或更新缓存中的数据。这种策略可以确保缓存数据的一致性，但需要应用程序显式地管理缓存的失效。</li><li><strong>被动失效</strong>：利用Redis的<code>EXPIRE</code>命令为缓存数据设置生存时间（TTL），让数据在指定时间后自动过期。这种策略适用于那些即使数据稍微过时也不会造成大问题的场景。</li></ul><blockquote><h2 id="更新缓存-or-清空缓存"><a class="markdownIt-Anchor" href="#更新缓存-or-清空缓存"></a> 更新缓存 or 清空缓存?</h2><h3 id="更新缓存"><a class="markdownIt-Anchor" href="#更新缓存"></a> 更新缓存</h3><p><strong>适用场景</strong>：</p><ul><li>数据频繁读取且更新成本相对较低的情况。</li><li>需要保证数据一致性，且能够容易地计算出更新后的值。</li><li>应用场景对数据实时性要求较高，必须确保缓存中的数据尽可能反映最新状态。</li></ul><p><strong>优点</strong>：</p><ul><li>减少对后端数据源的查询压力，提高数据访问速度。</li><li>保持缓存数据的实时性和一致性。</li></ul><p><strong>缺点</strong>：</p><ul><li>实现复杂度较高，尤其是当更新逻辑复杂或与原始数据生成逻辑不一致时。</li><li>在高并发场景下，更新缓存可能引入竞态条件，需要额外的同步机制。</li></ul><h3 id="清空缓存"><a class="markdownIt-Anchor" href="#清空缓存"></a> 清空缓存</h3><p><strong>适用场景</strong>：</p><ul><li>数据更新频率低，或者更新操作对性能影响较大的场景。</li><li>数据一致性要求不是非常严格，可以接受短时间内缓存数据与数据库数据的不一致。</li><li>更新操作涉及复杂逻辑，直接重新生成缓存内容比更新现有缓存更简单或更高效。</li></ul><p><strong>优点</strong>：</p><ul><li>实现简单，只需删除缓存项即可，无需处理复杂的更新逻辑。</li><li>避免了因缓存数据更新不当而导致的数据不一致问题。</li></ul><p><strong>缺点</strong>：</p><ul><li>频繁清空缓存可能导致对后端数据源的访问增加，影响性能。</li><li>用户可能会遇到缓存失效后的延迟增加，尤其是对于计算或获取成本较高的数据。</li></ul><h3 id="总结-2"><a class="markdownIt-Anchor" href="#总结-2"></a> 总结</h3><ul><li>如果能够容易且准确地更新缓存以反映最新数据，而且这样做对性能影响不大，则<strong>更新缓存</strong>可能是更好的选择。</li><li>如果更新缓存的逻辑复杂，或者保持数据最新性的成本较高，清空（删除）缓存然后在下次访问时重新生成可能是更简单、更有效的方法。</li></ul></blockquote><p><strong>封装到数据访问层</strong></p><p>MongoDB 可以将自定义的接口和主接口组合起来</p><p>首先创建自定义的 repository 接口，声明自定义方法</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CustomPersonRepository</span> &#123;</span><br><span class="line">    Flux&lt;Person&gt; <span class="title function_">findCustomQuery</span><span class="params">(String criteria)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>然后创建自定义接口的实现类，注入<code>ReactiveMongoTemplate</code>来执行实际的数据库操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomPersonRepositoryImpl</span> <span class="keyword">implements</span> <span class="title class_">CustomPersonRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveMongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomPersonRepositoryImpl</span><span class="params">(ReactiveMongoTemplate mongoTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mongoTemplate = mongoTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Person&gt; <span class="title function_">findCustomQuery</span><span class="params">(String criteria)</span> &#123;</span><br><span class="line">        <span class="type">Query</span> <span class="variable">query</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Query</span>(Criteria.where(<span class="string">&quot;someField&quot;</span>).is(criteria));</span><br><span class="line">        <span class="keyword">return</span> mongoTemplate.find(query, Person.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>最后组合自定义 repository 接口到主 repository 接口，让主 repository 接口扩展自定义的接口</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PersonRepository</span> <span class="keyword">extends</span> <span class="title class_">ReactiveMongoRepository</span>&lt;Person, String&gt;, CustomPersonRepository &#123;</span><br><span class="line">    <span class="comment">// 自带的CRUD方法和查询方法名解析方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>Redis 直接定义接口和实现类即可</p><p>创建接口</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReactivePersonRepository</span> &#123;</span><br><span class="line">    Mono&lt;Person&gt; <span class="title function_">save</span><span class="params">(Person person)</span>;</span><br><span class="line">    Mono&lt;Person&gt; <span class="title function_">findById</span><span class="params">(String id)</span>;</span><br><span class="line">    Flux&lt;Person&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">deleteById</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>创建实现类，注入<code>ReactiveRedisTemplate</code>和<code>ReactiveValueOperations</code>(实际上就是对<code>ReactiveRedisTemplate.opsForValue()</code>的引用，简化了代码)</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactivePersonRepositoryImpl</span> <span class="keyword">implements</span> <span class="title class_">ReactivePersonRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, Person&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveValueOperations&lt;String, Person&gt; reactiveValueOps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReactivePersonRepositoryImpl</span><span class="params">(ReactiveRedisTemplate&lt;String, Person&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.reactiveValueOps = redisTemplate.opsForValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Person&gt; <span class="title function_">save</span><span class="params">(Person person)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.set(person.getId(), person).thenReturn(person);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Person&gt; <span class="title function_">findById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Person&gt; <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.execute(connection -&gt; </span><br><span class="line">            connection.keyCommands().scan(ScanOptions.scanOptions().match(<span class="string">&quot;*&quot;</span>).build()))</span><br><span class="line">            .flatMap(cursor -&gt; Flux.fromIterable(cursor)</span><br><span class="line">            .flatMap(key -&gt; reactiveValueOps.get(<span class="keyword">new</span> <span class="title class_">String</span>(key)).cast(T.class)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.delete(id).then();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>更通用的泛型写法</p><p>接口</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ReactiveGenericRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 保存一个对象到Redis。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value 要保存的对象</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 对象的类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 保存后的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; Mono&lt;T&gt; <span class="title function_">save</span><span class="params">(String key, T value)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据键查找一个对象。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 对象的预期类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 找到的对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; Mono&lt;T&gt; <span class="title function_">findById</span><span class="params">(String key)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查找所有对象。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz 对象的类类型，用于类型转换</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; 对象的预期类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 找到的所有对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    &lt;T&gt; Flux&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Class&lt;T&gt; clazz)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据键删除一个对象。</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key Redis键</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 删除操作的结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Mono&lt;Boolean&gt; <span class="title function_">deleteById</span><span class="params">(String key)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>实现类</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReactiveGenericRepositoryImpl</span> <span class="keyword">implements</span> <span class="title class_">ReactiveGenericRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveRedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveValueOperations&lt;String, Object&gt; reactiveValueOps;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ReactiveGenericRepositoryImpl</span><span class="params">(ReactiveRedisTemplate&lt;String, Object&gt; redisTemplate)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.redisTemplate = redisTemplate;</span><br><span class="line">        <span class="built_in">this</span>.reactiveValueOps = redisTemplate.opsForValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Mono&lt;T&gt; <span class="title function_">save</span><span class="params">(String key, T value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.set(key, value).thenReturn(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Mono&lt;T&gt; <span class="title function_">findById</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; Flux&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> redisTemplate.scan(ScanOptions.scanOptions().match(<span class="string">&quot;*&quot;</span>).build())</span><br><span class="line">            .flatMap(key -&gt; redisTemplate.opsForValue().get(key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Boolean&gt; <span class="title function_">deleteById</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> reactiveValueOps.delete(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><blockquote><h3 id="关于泛型的使用"><a class="markdownIt-Anchor" href="#关于泛型的使用"></a> 关于泛型的使用</h3><p>泛型可以在类、接口或方法上使用，具体取决于设计的需求：</p><ol><li><p><strong>类或接口上的泛型</strong>：当你希望定义一个类或接口时就确定其操作的数据类型，可以在类或接口上声明泛型参数。这种方式适用于整个类或接口中所有方法操作的数据类型是一致的情况。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Repository</span>&lt;T&gt; &#123;</span><br><span class="line">    Mono&lt;T&gt; <span class="title function_">save</span><span class="params">(T entity)</span>;</span><br><span class="line">    Mono&lt;T&gt; <span class="title function_">findById</span><span class="params">(String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>方法上的泛型</strong>：当你希望在具体的方法调用时确定数据类型，可以在方法上声明泛型参数。这种方式提供了更高的灵活性，允许在同一个类或接口中支持不同类型的操作。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GenericRepository</span> &#123;</span><br><span class="line">    &lt;T&gt; Mono&lt;T&gt; <span class="title function_">save</span><span class="params">(String key, T value)</span>;</span><br><span class="line">    &lt;T&gt; Mono&lt;T&gt; <span class="title function_">findById</span><span class="params">(String key, Class&lt;T&gt; clazz)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ol></blockquote><h3 id="webflux-服务层"><a class="markdownIt-Anchor" href="#webflux-服务层"></a> Webflux 服务层</h3><h4 id="多数据库联合操作"><a class="markdownIt-Anchor" href="#多数据库联合操作"></a> 多数据库联合操作</h4><h5 id="策略"><a class="markdownIt-Anchor" href="#策略"></a> 策略</h5><p>在实际业务场景中，联合多种数据库操作需要考虑诸多的策略：</p><p><strong>1.查询策略</strong></p><ul><li><strong>缓存优先</strong>：对于读操作，通常采用缓存优先的策略。首先查询Redis缓存，如果缓存命中，则直接返回缓存中的数据；如果缓存未命中，则查询MongoDB或PostgreSQL，并将查询结果缓存到Redis中，以便后续请求能够直接从缓存中获取数据。</li></ul><p><strong>2.数据存储和一致性</strong></p><ul><li><p><strong>分离存储</strong>：MongoDB和PostgreSQL应该处理各自业务范围内的数据，避免存储重复数据。例如，MongoDB可以用于存储文档型或半结构化数据，而PostgreSQL用于存储关系数据和进行复杂查询。</p></li><li><p><strong>数据一致性</strong>：在进行增删改操作时，直接对MongoDB或PostgreSQL进行操作。操作完成后，根据业务需求和数据一致性要求决定是更新Redis缓存还是清空缓存。</p></li></ul><p><strong>3.缓存失效策略</strong></p><ul><li><p><strong>缓存更新</strong>：如果数据变更不频繁，或者实时性要求高，可以在数据变更后更新Redis缓存。这可以减少缓存不一致的窗口期，但需要额外的开销来维护缓存数据的更新。</p></li><li><p><strong>缓存清空</strong>：对于高变更频率的数据，或者当缓存更新逻辑较为复杂时，可以选择在数据变更后清空（删除）相关的Redis缓存。这简化了缓存管理，但可能导致更频繁的数据库查询。</p></li></ul><p><strong>4.事务和一致性模型</strong></p><ul><li><p><strong>事务管理</strong>：在涉及到多个数据操作的业务逻辑中，考虑使用事务（对于支持事务的数据库，如PostgreSQL）来保证操作的原子性和一致性。</p></li><li><p><strong>最终一致性</strong>：在分布式系统中，完全的一致性很难实现，可以采用最终一致性模型，通过合理的缓存策略和数据同步机制，确保数据在一定时间内达到一致状态。</p></li></ul><p><strong>5.数据备份和恢复</strong></p><ul><li><strong>备份策略</strong>：定期备份数据是保证数据安全的重要措施。MongoDB和PostgreSQL都提供了备份和恢复的机制，应该根据业务需求制定备份计划并定期执行。</li><li><strong>灾难恢复</strong>：设计灾难恢复计划，确保在数据丢失或系统故障的情况下能够快速恢复服务。</li></ul><p><strong>6.性能优化</strong></p><ul><li><strong>索引优化</strong>：对于MongoDB和PostgreSQL，合理使用索引可以显著提高查询效率。需要定期评估索引的使用情况和性能影响，并根据实际查询模式进行优化。</li><li><strong>缓存策略</strong>：对于Redis，合理设计缓存策略，包括选择合适的数据过期时间、使用合适的数据结构等，可以提高缓存效率和命中率。</li></ul><p><strong>7.安全性考虑</strong></p><ul><li><strong>访问控制</strong>：确保数据库的访问控制得当，只有授权的用户和服务才能访问敏感数据。</li><li><strong>数据加密</strong>：对敏感数据进行加密，包括在传输过程中的加密（如使用SSL/TLS）和存储时的加密。</li></ul><p><strong>8.监控和警报</strong></p><ul><li><strong>性能监控</strong>：监控数据库的性能指标，如响应时间、查询负载等，可以帮助及时发现和解决性能问题。</li><li><strong>系统警报</strong>：设置警报机制，当出现潜在的问题，如访问异常、资源使用率过高等时，能够及时通知到相关人员。</li></ul><p><strong>9.微服务架构下的数据管理</strong></p><ul><li><strong>服务间数据一致性</strong>：在微服务架构中，不同服务可能会操作不同的数据库实例或类型。设计合理的服务间通信和数据同步机制，以保证跨服务的数据一致性。</li><li><strong>API网关和服务聚合</strong>：考虑使用API网关来聚合来自不同微服务的数据请求和响应，提供统一的数据访问入口。</li></ul><blockquote><h3 id="命令查询责任分离-cqrs"><a class="markdownIt-Anchor" href="#命令查询责任分离-cqrs"></a> 命令查询责任分离 CQRS</h3><p>命令查询责任分离（Command Query Responsibility Segregation，CQRS）是一种软件架构模式，它将应用的读操作（查询）和写操作（命令）明确分离开来。CQRS的核心思想是对读和写使用不同的模型，以优化性能、可伸缩性和安全性。这种模式并不一定要求使用两个物理不同的数据库，但在某些实现中，确实会使用不同的数据存储来分别处理读和写操作，以此来充分利用每种存储的优势。</p><h3 id="cqrs的关键概念"><a class="markdownIt-Anchor" href="#cqrs的关键概念"></a> CQRS的关键概念</h3><ul><li><strong>命令（Command）</strong>：表示对系统的写操作（如创建、更新、删除），这些操作可以改变系统的状态但不返回任何值。</li><li><strong>查询（Query）</strong>：表示对系统的读操作，这些操作返回系统的当前状态，但不改变状态。</li></ul><h3 id="cqrs的优势"><a class="markdownIt-Anchor" href="#cqrs的优势"></a> CQRS的优势</h3><ul><li><strong>性能优化</strong>：通过分离读写操作，可以针对查询和命令操作分别优化数据模型和存储机制，从而提高应用的性能。</li><li><strong>可伸缩性</strong>：可以独立地扩展读操作和写操作的处理能力，适应不同的负载需求。</li><li><strong>安全性与复杂性管理</strong>：简化复杂的业务逻辑，因为读模型可以专门针对查询进行优化，而写模型则专注于业务规则和数据一致性。</li><li><strong>灵活的技术选择</strong>：可以针对读和写操作选择最适合的技术和数据库。</li></ul><h3 id="cqrs与数据一致性"><a class="markdownIt-Anchor" href="#cqrs与数据一致性"></a> CQRS与数据一致性</h3><p>在使用CQRS时，确实可能会涉及到不同的数据存储系统，这在某些情况下可能引入数据一致性的挑战。例如，当一个命令操作更新了写模型的数据后，读模型的数据可能需要一些时间才能反映这些更改，这导致了最终一致性的情况而不是即时一致性。</p><p>为了管理这种一致性问题，通常会采用以下策略之一：</p><ul><li><strong>即时同步</strong>：在命令操作后立即更新读模型。这种方式尽可能保持读写模型的同步，但可能会影响写操作的性能。</li><li><strong>异步更新</strong>：通过事件驱动的方式，当写模型更新后异步更新读模型。这种方式可以提高写操作的性能，但读模型可能会暂时与写模型不一致，实现最终一致性。</li></ul><p><strong>CQRS最适合那些读写负载差异大、对数据一致性要求较为宽松的场景。在需要强一致性或读写模式没有显著差异的应用中，CQRS可能带来过多的复杂性而不是收益。</strong></p><h4 id="cqrs适用场景读写负载差异大对数据一致性要求宽松"><a class="markdownIt-Anchor" href="#cqrs适用场景读写负载差异大对数据一致性要求宽松"></a> CQRS适用场景：读写负载差异大，对数据一致性要求宽松</h4><ul><li><strong>社交网络的Feed流</strong>：用户的动态更新（写操作）可能不是非常频繁，但是用户浏览Feed流（读操作）非常频繁。此外，用户通常可以接受Feed流不是实时更新的，即如果某个好友的动态延迟几秒钟出现在Feed中通常是可接受的。在这种情况下，CQRS可以用来优化Feed流的读取性能，通过将写操作和Feed流的生成/查询逻辑分离来实现。</li><li><strong>电商平台的商品推荐系统</strong>：商品的购买和评价（写操作）相对于商品推荐的阅读（读操作）来说较少。推荐系统可以基于用户的历史行为和偏好生成，且用户通常可以接受推荐信息不是实时更新的。使用CQRS可以将推荐生成（写操作）和推荐展示（读操作）分离，优化用户的阅读体验。</li></ul><h4 id="非cqrs适用场景强一致性需求或读写模式没有显著差异"><a class="markdownIt-Anchor" href="#非cqrs适用场景强一致性需求或读写模式没有显著差异"></a> 非CQRS适用场景：强一致性需求或读写模式没有显著差异</h4><ul><li><strong>银行系统</strong>：在处理金融交易（如转账）时，系统必须保证数据的强一致性，以确保账户余额的准确性。在这种场景下，读写操作对数据一致性的要求非常高，采用CQRS可能会引入不必要的复杂性和风险。</li><li><strong>实时协作工具</strong>：如在线文档编辑器，允许多个用户同时编辑同一个文档。这类应用需要实时同步不同用户的操作，以保持所有用户视图的一致性。由于读写操作紧密相关且对实时性要求很高，CQRS可能不是最佳选择。</li></ul><h4 id="针对-cqrs-逻辑读写分离而非物理读写分离的案例"><a class="markdownIt-Anchor" href="#针对-cqrs-逻辑读写分离而非物理读写分离的案例"></a> 针对 CQRS 逻辑读写分离而非物理读写分离的案例</h4><p>由于实践过程中，简化的设计通常是按物理数据库来划分读写职责，但这可能会造成“ CQRS 就是将两个数据库分成一个主要用于读取的数据库(读取的数据仍需要通过另一个数据库同步写入)和一个只用于写入数据库”的误解（这是在十分理想化的情况下）。</p><p>设计一个更复杂的场景，其中PostgreSQL和MongoDB都承担读写操作，但各自侧重于不同类型的读写负载。这样的设计可以展示CQRS并非简单地物理划分读写操作到不同的数据库，而是根据操作的性质和数据模型的优化需求来逻辑分配任务。</p><h3 id="场景设定"><a class="markdownIt-Anchor" href="#场景设定"></a> 场景设定</h3><p>假设我们正在开发一个电商平台，其中包含产品管理和用户行为分析两大功能。</p><h3 id="使用postgresql和mongodb的cqrs实现"><a class="markdownIt-Anchor" href="#使用postgresql和mongodb的cqrs实现"></a> 使用PostgreSQL和MongoDB的CQRS实现</h3><ul><li><strong>PostgreSQL</strong>：<ul><li><strong>写操作</strong>：负责产品的创建、更新和删除。这些操作需要事务支持和一致性保证，适合关系数据库的特点。</li><li><strong>复杂读操作</strong>：负责执行复杂的SQL查询，如生成报表、聚合查询等。这些操作利用了PostgreSQL强大的SQL支持和优化器。</li></ul></li><li><strong>MongoDB</strong>：<ul><li><strong>写操作</strong>：负责记录用户行为数据，如页面浏览、点击事件等。这些操作对写入速度有很高要求，并且数据结构可能经常变化，适合文档数据库的特点。</li><li><strong>简单读操作</strong>：负责提供快速的查询响应，如用户行为数据的即时查询。MongoDB的灵活性和索引优化可以提供高效的查询性能。</li></ul></li></ul><h3 id="数据同步和一致性"><a class="markdownIt-Anchor" href="#数据同步和一致性"></a> 数据同步和一致性</h3><p>在这个例子中，PostgreSQL和MongoDB都承担读写操作，但针对不同的业务场景。为了保持数据一致性：</p><ul><li><strong>数据同步</strong>：可以使用事件驱动机制同步必要的数据变更。例如，当一个新产品在PostgreSQL中被创建或更新后，相关的信息可以异步同步到MongoDB中的用户行为分析模型。</li><li><strong>CQRS视角</strong>：从CQRS的视角看，我们在逻辑上区分了命令（写操作）和查询（读操作），并根据不同操作的特点选择了最合适的数据存储。即便每种数据库都执行读写操作，但这些操作服务于不同的业务需求和数据模型。</li></ul><p>除了命令查询责任分离 CQRS 根据读写职责划分来设计多个数据库行为以外，另一种架构则是按照业务边界划分来设计多个数据库行为。</p><p>这种架构下，每一个数据库之间不需要考虑数据同步和一致性问题，因为它们负责的是从业务逻辑上分离的数据，任何一个数据库的业务操作都不会影响另一个数据库的业务操作，就像两个可以独立运行的模块。这种架构设计比较接近于微服务架构的理念：在微服务架构中，应用被分解成一系列较小、松耦合的服务，每个服务围绕着特定的业务功能构建，并可以独立部署、扩展和维护。每个服务通常管理自己的数据库（或数据存储），以保持业务边界的清晰和数据的封装性。</p></blockquote><h5 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h5><blockquote><p>使用PostgreSQL存储核心业务数据，MongoDB存储文档或日志类型的数据，而Redis作为缓存层来提高数据读取的性能。</p></blockquote><p>一个博客系统，其中PostgreSQL用于存储文章信息，MongoDB用于存储用户评论，Redis用于缓存热门文章。</p><p>有以下已经提前准备好的 repository 接口，假设里面的方法都已经实现</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 假设的PostgreSQL文章Repository</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ArticleRepository</span> &#123;</span><br><span class="line">    Mono&lt;Article&gt; <span class="title function_">saveArticle</span><span class="params">(Article article)</span>;</span><br><span class="line">    Mono&lt;Article&gt; <span class="title function_">findArticleById</span><span class="params">(String id)</span>;</span><br><span class="line">    Mono&lt;Void&gt; <span class="title function_">deleteArticleById</span><span class="params">(String id)</span>;</span><br><span class="line">    Flux&lt;Article&gt; <span class="title function_">findAllArticles</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设的MongoDB评论Repository</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CommentRepository</span> &#123;</span><br><span class="line">    Mono&lt;Comment&gt; <span class="title function_">saveComment</span><span class="params">(Comment comment)</span>;</span><br><span class="line">    Flux&lt;Comment&gt; <span class="title function_">findCommentsByArticleId</span><span class="params">(String articleId)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设的Redis缓存操作</span></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">CacheService</span> &#123;</span><br><span class="line">    &lt;T&gt; Mono&lt;T&gt; <span class="title function_">findInCache</span><span class="params">(String key, Class&lt;T&gt; type)</span>;</span><br><span class="line">    &lt;T&gt; Mono&lt;Boolean&gt; <span class="title function_">updateCache</span><span class="params">(String key, T data)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>然后基于这些方法编写服务层，协调不同数据库的操作</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlogService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ArticleRepository articleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CommentRepository commentRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CacheService cacheService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Article&gt; <span class="title function_">createOrUpdateArticle</span><span class="params">(Article article)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> articleRepository.saveArticle(article)</span><br><span class="line">                .flatMap(savedArticle -&gt; cacheService.updateCache(<span class="string">&quot;article_&quot;</span> + savedArticle.getId(), savedArticle)</span><br><span class="line">                        .thenReturn(savedArticle));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Article&gt; <span class="title function_">getArticleById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> cacheService.findInCache(<span class="string">&quot;article_&quot;</span> + id, Article.class)</span><br><span class="line">                .switchIfEmpty(articleRepository.findArticleById(id)</span><br><span class="line">                        .flatMap(article -&gt; cacheService.updateCache(<span class="string">&quot;article_&quot;</span> + article.getId(), article)</span><br><span class="line">                                .thenReturn(article)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;Comment&gt; <span class="title function_">getCommentsByArticleId</span><span class="params">(String articleId)</span> &#123;</span><br><span class="line">        <span class="comment">// 直接从MongoDB获取评论，因为评论不适合缓存</span></span><br><span class="line">        <span class="keyword">return</span> commentRepository.findCommentsByArticleId(articleId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">deleteArticleById</span><span class="params">(String id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> articleRepository.deleteArticleById(id)</span><br><span class="line">                .then(cacheService.updateCache(<span class="string">&quot;article_&quot;</span> + id, <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>逻辑说明</p><ul><li><strong>文章操作（PostgreSQL + Redis）</strong>：文章的创建、更新、查询和删除操作主要依赖PostgreSQL。Redis用作文章信息的缓存，以加速热门文章的读取性能。</li><li><strong>评论操作（MongoDB）</strong>：评论数据由于其量可能很大并且更新频繁，因此存储在MongoDB中，并且通常不被缓存。</li><li><strong>缓存逻辑（Redis）</strong>：在文章创建或更新后更新缓存，在文章查询时先尝试从缓存获取，缓存未命中则从数据库加载并更新缓存。</li></ul><h3 id="webflux-安全层"><a class="markdownIt-Anchor" href="#webflux-安全层"></a> Webflux 安全层</h3><h4 id="整合spring-security-jwt"><a class="markdownIt-Anchor" href="#整合spring-security-jwt"></a> 整合Spring Security、JWT</h4><p>在引入 Spring Security 之前，建议先实现 JWT 的生成和验证逻辑，这样方便后面整合 Spring Security 框架来进行认证和授权。</p><h5 id="jwt-工具类"><a class="markdownIt-Anchor" href="#jwt-工具类"></a> JWT 工具类</h5><p>创建一个 JWT 工具类来处理 JWT 的创建、解析和验证</p><blockquote><p>一个更完善的版本还应该包括Token的有效期、处理异常、以及更安全的密钥管理等方面的考虑</p></blockquote><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="comment">// 生产环境中应从配置文件或环境变量中安全地获取密钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Key</span> <span class="variable">key</span> <span class="operator">=</span> Keys.secretKeyFor(SignatureAlgorithm.HS256); <span class="comment">// 使用HS256算法生成密钥</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">long</span> <span class="variable">expiration</span> <span class="operator">=</span> <span class="number">3600000</span>; <span class="comment">// Token有效期，这里示例为1小时（单位毫秒）</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateToken</span><span class="params">(String username, List&lt;String&gt; roles)</span> &#123;</span><br><span class="line">        <span class="comment">// Date now = new Date();</span></span><br><span class="line">        <span class="comment">// Date expiryDate = new Date(now.getTime() + expiration); // 设置Token过期时间</span></span><br><span class="line">        <span class="comment">// 如果不希望使用Date，可以使用以下方法实现</span></span><br><span class="line">        <span class="type">Instant</span> <span class="variable">now</span> <span class="operator">=</span> Instant.now();</span><br><span class="line">        <span class="type">Instant</span> <span class="variable">expiryDate</span> <span class="operator">=</span> now.plus(<span class="number">1</span>, ChronoUnit.HOURS); <span class="comment">// 设置Token过期时间为1小时后</span></span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">            .setSubject(username)</span><br><span class="line">            .setIssuedAt(Date.from(now))</span><br><span class="line">            .setExpiration(Date.from(expiryDate))</span><br><span class="line">            .claim(<span class="string">&quot;roles&quot;</span>, roles) <span class="comment">// 在这里添加角色信息，方便Spring Security认证</span></span><br><span class="line">            .signWith(key) <span class="comment">// 使用生成的密钥签名</span></span><br><span class="line">            .compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Claims <span class="title function_">validateToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Jwts.parser()</span><br><span class="line">                .setSigningKey(key) <span class="comment">// 使用密钥验证</span></span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(token)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsernameFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> validateToken(token);</span><br><span class="line">        <span class="keyword">return</span> claims.getSubject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;String&gt; <span class="title function_">getRolesFromToken</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> validateToken(token);</span><br><span class="line">        <span class="keyword">return</span> claims.get(<span class="string">&quot;roles&quot;</span>, List.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isTokenExpired</span><span class="params">(String token)</span> &#123;</span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> validateToken(token);</span><br><span class="line">        <span class="comment">// return claims.getExpiration().before(new Date());</span></span><br><span class="line">        <span class="keyword">return</span> claims.getExpiration().toInstant().isBefore(Instant.now());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>使用<code>Keys.secretKeyFor</code>生成密钥</p><ul><li><strong>生产环境</strong>：在生产环境中使用<code>Keys.secretKeyFor(SignatureAlgorithm.HS256)</code>来生成密钥是推荐的做法，因为它能为所使用的签名算法生成足够强度的密钥。为了安全起见，密钥不应该硬编码在代码中，而是应该通过安全的方式（如环境变量、配置服务等）提供，并且保证其安全性（不被泄露）。</li><li><strong>测试环境</strong>：在测试环境中，使用<code>Keys.secretKeyFor(SignatureAlgorithm.HS256)</code>同样适用，它可以帮助确保测试环境尽可能地模拟生产环境的配置和安全性。然而，考虑到测试环境的便利性和调试需求，可能会选择使用更简单的密钥管理方式，但应确保测试用的密钥不会用于生产环境。</li></ul><p>下面提供一个简单的测试类用于测试该工具类的功能</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">JwtUtilTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">JwtUtil</span> <span class="variable">jwtUtil</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtUtil</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testGenerateAndValidateToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;testUser&quot;</span>;</span><br><span class="line">        List&lt;String&gt; roles = Arrays.asList(<span class="string">&quot;ROLE_USER&quot;</span>, <span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtUtil.generateToken(username, roles);</span><br><span class="line">        assertNotNull(token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate token and extract claims</span></span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> jwtUtil.validateToken(token);</span><br><span class="line">        assertNotNull(claims);</span><br><span class="line">        assertEquals(username, claims.getSubject());</span><br><span class="line">        assertTrue(claims.get(<span class="string">&quot;roles&quot;</span>) <span class="keyword">instanceof</span> List);</span><br><span class="line">        assertEquals(roles, claims.get(<span class="string">&quot;roles&quot;</span>, List.class));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if token is not expired</span></span><br><span class="line">        assertFalse(jwtUtil.isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testTokenExpiration</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="comment">// Assuming we have a very short expiry time for testing</span></span><br><span class="line">        jwtUtil.setExpiration(<span class="number">10</span>); <span class="comment">// Set token expiration to 10 milliseconds for the test</span></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;testUser&quot;</span>;</span><br><span class="line">        List&lt;String&gt; roles = Arrays.asList(<span class="string">&quot;ROLE_USER&quot;</span>, <span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtUtil.generateToken(username, roles);</span><br><span class="line">        Thread.sleep(<span class="number">20</span>); <span class="comment">// Wait longer than the token expiration time</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Verify the token is expired</span></span><br><span class="line">        assertTrue(jwtUtil.isTokenExpired(token));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">testToken</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;user123&quot;</span>;</span><br><span class="line">        List&lt;String&gt; roles = Arrays.asList(<span class="string">&quot;ROLE_USER&quot;</span>, <span class="string">&quot;ROLE_ADMIN&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Generate token with user information</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> jwtUtil.generateToken(username, roles);</span><br><span class="line">        System.out.println(<span class="string">&quot;Generated Token: &quot;</span> + token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Assume token is being sent to and received from a client in a real application</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Validate token and extract user information</span></span><br><span class="line">        <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> jwtUtil.validateToken(token);</span><br><span class="line">        <span class="type">String</span> <span class="variable">extractedUsername</span> <span class="operator">=</span> claims.getSubject();</span><br><span class="line">        List&lt;String&gt; extractedRoles = claims.get(<span class="string">&quot;roles&quot;</span>, List.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;Username from Token: &quot;</span> + extractedUsername);</span><br><span class="line">        System.out.println(<span class="string">&quot;Roles from Token: &quot;</span> + extractedRoles);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>在这个测试类中，<code>testGenerateAndValidateToken</code>测试用例生成一个Token，并验证Token是否正确包含了用户名和角色信息。<code>testTokenExpiration</code>测试用例则是为了测试Token过期逻辑是否正常。这里为了方便测试过期逻辑，在<code>JwtUtil</code>类中定义了<code>setExpiration</code>方法来动态设置Token的过期时间，这主要用于测试目的，实际生产环境中不应该使用此方法。<code>testToken</code>测试用例是用于展示一个简单的Token各个阶段的信息内容。</p><p><strong>JWT Token</strong></p><p>JWT Token可以包含多种标准的声明（Claim），以下是一些常见的标准声明：</p><ul><li><strong>iss (Issuer)</strong>：Token的发行者。</li><li><strong>sub (Subject)</strong>：Token的主题，通常用来存储用户的唯一标识。</li><li><strong>aud (Audience)</strong>：Token的接收方。</li><li><strong>exp (Expiration Time)</strong>：Token的过期时间，通常是一个时间戳，表示Token在此时间之后不再有效。</li><li><strong>nbf (Not Before)</strong>：Token的生效时间，表示在此时间之前，Token不可用。</li><li><strong>iat (Issued At)</strong>：Token的发行时间。</li><li><strong>jti (JWT ID)</strong>：Token的唯一标识符。</li></ul><p>除了这些标准声明外，还可以在 Token 中添加自定义声明来存储特定于应用的信息，如用户角色、权限等。使用<code>Claims</code>对象，可以通过<code>get</code>方法以键值对的形式访问这些自定义声明，例如</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">role</span> <span class="operator">=</span> claims.get(<span class="string">&quot;role&quot;</span>, String.class); <span class="comment">// 假设我们在Token中添加了一个名为&quot;role&quot;的自定义声明</span></span><br></pre></td></tr></table></figure></div><blockquote><h3 id="案例"><a class="markdownIt-Anchor" href="#案例"></a> 案例</h3><p>假设有一个简单的Web应用，用于文章的阅读和评论，用户需要登录才能评论。在用户登录时，系统会生成一个JWT Token，其中包含如下标准声明：</p><ul><li><strong>iss (Issuer)</strong>：<code>&quot;MyArticleApp&quot;</code>。这表明Token是由&quot;MyArticleApp&quot;应用发行的。</li><li><strong>sub (Subject)</strong>：<code>&quot;1234567890&quot;</code>。这是用户的唯一标识，通常可以是用户ID、用户名或其他唯一标识用户的信息。在这个例子中，假设它是用户ID。</li><li><strong>aud (Audience)</strong>：<code>&quot;MyArticleAppUsers&quot;</code>。这指示了Token的预期接收者，确保Token只被指定的受众使用。</li><li><strong>exp (Expiration Time)</strong>：<code>1627499999</code>。这是一个UNIX时间戳，表示Token的过期时间。假设这代表Token将在未来某个时间点过期。</li><li><strong>nbf (Not Before)</strong>：<code>1627480000</code>。这同样是一个UNIX时间戳，表示Token在这个时间之前不应被接受。</li><li><strong>iat (Issued At)</strong>：<code>1627486400</code>。这表示Token的发行时间。</li><li><strong>jti (JWT ID)</strong>：<code>&quot;a87ff679a2f3e71d9181a67b7542122c&quot;</code>。这是Token的唯一标识符，用于防止重放攻击。</li></ul><h3 id="如何使用这些信息安全地识别用户身份"><a class="markdownIt-Anchor" href="#如何使用这些信息安全地识别用户身份"></a> 如何使用这些信息安全地识别用户身份？</h3><ol><li><strong>验证Token的签名</strong>：首先，确保Token的签名是有效的，这通过使用发行Token时用到的相同密钥来验证。这一步是必需的，以确保Token未被篡改。</li><li><strong>检查Token的发行者（iss）和受众（aud）</strong>：确认Token的<code>iss</code>和<code>aud</code>声明与你的应用期望的值匹配。这有助于确保Token是为你的应用发行的，且仅供指定的受众使用。</li><li><strong>验证Token的有效期</strong>：检查当前时间是否在Token的<code>nbf</code>（Not Before）和<code>exp</code>（Expiration Time）声明指定的时间范围内。如果不在这个范围内，Token应被认为是无效的。</li><li><strong>获取和验证用户身份</strong>：一旦Token通过了上述验证，你可以信任Token中的<code>sub</code>（Subject）声明。在这个例子中，<code>sub</code>是用户ID<code>&quot;1234567890&quot;</code>。你可以使用这个ID从数据库或其他存储系统中检索用户的详细信息，并在需要时进行进一步的授权检查。</li></ol></blockquote><p>在基于Spring Security和Spring WebFlux的应用中使用JWT进行认证时，<code>JwtAuthenticationManager</code>、<code>JwtSecurityContextRepository</code>和<code>JwtAuthenticationFilter</code>可以协作以支持认证流程。这三个组件各自承担不同的职责，以下是它们如何协作的简化示例及解释：</p><h5 id="jwtauthenticationfilter"><a class="markdownIt-Anchor" href="#jwtauthenticationfilter"></a> JwtAuthenticationFilter</h5><p>这个过滤器负责拦截进入的HTTP请求，从请求中提取JWT Token，并尝试对其进行验证。</p><ul><li><p><strong>职责</strong>：从HTTP请求中提取JWT Token，并创建一个未经认证的<code>Authentication</code>对象（如<code>UsernamePasswordAuthenticationToken</code>），然后将其提交给<code>AuthenticationManager</code>进行认证。</p></li><li><p><strong>用途</strong>：负责拦截进入的请求，从中提取JWT Token，并尝试进行认证。它是连接前端请求和后端安全逻辑的桥梁。</p></li><li><p><strong>适用场景</strong>：几乎所有需要JWT认证的场景。</p></li><li><p><strong>实现</strong>：这个过滤器通常继承自<code>WebFilter</code>接口（对于WebFlux应用）。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtAuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(JwtAuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="type">ServerHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> exchange.getRequest();</span><br><span class="line">        <span class="comment">// 提取JWT Token的逻辑</span></span><br><span class="line">        <span class="comment">// 简单示例中，可以不实现具体逻辑，或根据需要添加</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>参考示例</strong></p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtAuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(JwtAuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="comment">// 提取请求中的Authorization头部</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">authHeader</span> <span class="operator">=</span> exchange.getRequest().getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span> (authHeader != <span class="literal">null</span> &amp;&amp; authHeader.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authHeader.substring(<span class="number">7</span>);</span><br><span class="line">            <span class="comment">// 创建未认证的Authentication Token</span></span><br><span class="line">            <span class="type">Authentication</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(authToken, authToken);</span><br><span class="line">            <span class="comment">// 使用JwtAuthenticationManager进行认证</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.authenticationManager.authenticate(authRequest)</span><br><span class="line">                .flatMap(auth -&gt; chain.filter(exchange).contextWrite(ReactiveSecurityContextHolder.withAuthentication(auth)))</span><br><span class="line">                .onErrorResume(e -&gt; chain.filter(exchange)); <span class="comment">// 处理认证失败</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 对于没有Bearer Token的请求直接放行</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>如果在后面实现了<code>JwtSecurityContextRepository</code>，则上面的代码可简化为以下代码</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title class_">WebFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtSecurityContextRepository jwtSecurityContextRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationFilter</span><span class="params">(JwtSecurityContextRepository jwtSecurityContextRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jwtSecurityContextRepository = jwtSecurityContextRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">filter</span><span class="params">(ServerWebExchange exchange, WebFilterChain chain)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> jwtSecurityContextRepository.load(exchange)</span><br><span class="line">                .flatMap(context -&gt; chain.filter(exchange).contextWrite(ReactiveSecurityContextHolder.withSecurityContext(Mono.just(context))))</span><br><span class="line">                .switchIfEmpty(chain.filter(exchange));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p><code>JwtAuthenticationFilter</code>在请求到达时提取JWT Token，并使用<code>JwtAuthenticationManager</code>进行认证。这个过程实际上在<code>JwtSecurityContextRepository</code>的<code>load</code>方法中已经体现。</p></li></ul><h5 id="jwtauthenticationmanager"><a class="markdownIt-Anchor" href="#jwtauthenticationmanager"></a> JwtAuthenticationManager</h5><p>这是一个自定义的<code>AuthenticationManager</code>，负责处理由<code>JwtAuthenticationFilter</code>提交的未经认证的<code>Authentication</code>对象。</p><ul><li><p><strong>职责</strong>：验证<code>Authentication</code>对象中的JWT Token的有效性，如果Token有效，则创建一个已认证的<code>Authentication</code>对象，并设置用户的权限。</p></li><li><p><strong>用途</strong>：对通过<code>JwtAuthenticationFilter</code>提取出的Token进行验证，确定用户的身份并授权。在WebFlux中，它通常是<code>ReactiveAuthenticationManager</code>的实现，在Spring MVC中，则是<code>AuthenticationManager</code>的实现。</p></li><li><p><strong>适用场景</strong>：需要验证用户Token的场景，实现自定义的认证逻辑。</p></li><li><p><strong>实现</strong>：可以通过实现<code>ReactiveAuthenticationManager</code>接口来自定义认证逻辑。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationManager</span> <span class="keyword">implements</span> <span class="title class_">ReactiveAuthenticationManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Authentication&gt; <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="comment">// 在这里实现JWT验证逻辑</span></span><br><span class="line">        <span class="comment">// 简单示例中，可以直接返回已认证的Authentication，或根据需要添加逻辑</span></span><br><span class="line">        <span class="keyword">return</span> Mono.just(authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>参考示例</strong></p><p>在<code>JwtAuthenticationManager</code>验证Token并创建已认证的<code>Authentication</code>对象时，需要从Token中解析用户的角色或权限，并将它们转换为<code>GrantedAuthority</code>对象，以便Spring Security进行授权判断。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationManager</span> <span class="keyword">implements</span> <span class="title class_">ReactiveAuthenticationManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtUtil jwtUtil;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthenticationManager</span><span class="params">(JwtUtil jwtUtil)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.jwtUtil = jwtUtil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Authentication&gt; <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">authToken</span> <span class="operator">=</span> authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> jwtUtil.getUsernameFromToken(authToken);</span><br><span class="line">            <span class="keyword">if</span> (!jwtUtil.isTokenExpired(authToken)) &#123;</span><br><span class="line">                List&lt;String&gt; roles = jwtUtil.getRolesFromToken(authToken);</span><br><span class="line">                List&lt;SimpleGrantedAuthority&gt; authorities =</span><br><span class="line">                        roles</span><br><span class="line">                                .stream()</span><br><span class="line">                                .map(role -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(<span class="string">&quot;ROLE_&quot;</span> + role.toUpperCase()))</span><br><span class="line">                                .collect(Collectors.toList());</span><br><span class="line">                <span class="type">Authentication</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, authToken, authorities);</span><br><span class="line">                <span class="keyword">return</span> Mono.just(auth);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ul><h5 id="jwtsecuritycontextrepository"><a class="markdownIt-Anchor" href="#jwtsecuritycontextrepository"></a> JwtSecurityContextRepository</h5><p>这个组件用于在请求处理过程中加载和保存<code>SecurityContext</code>。对于基于JWT的无状态认证，它通常不会保存<code>SecurityContext</code>，但会在每个请求中基于JWT Token加载<code>SecurityContext</code>。</p><ul><li><p><strong>职责</strong>：基于每个请求中的JWT Token动态构建<code>SecurityContext</code>。</p></li><li><p><strong>用途</strong>：负责在每个请求中重建<code>SecurityContext</code>，根据JWT Token中的信息设置用户的认证状态。由于JWT认证是无状态的，它通常不用于保存状态，而是用于在请求之间重建状态。</p></li><li><p><strong>适用场景</strong>：适用于所有基于JWT进行认证的场景，尤其是在需要将JWT Token信息转化为Spring Security认识的认证信息时。</p></li><li><p><strong>实现</strong>：实现<code>ServerSecurityContextRepository</code>接口，通常在<code>load</code>方法中处理Token的解析和验证。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtSecurityContextRepository</span> <span class="keyword">implements</span> <span class="title class_">ServerSecurityContextRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">save</span><span class="params">(ServerWebExchange exchange, SecurityContext context)</span> &#123;</span><br><span class="line">        <span class="comment">// JWT是无状态的，不需要实现保存</span></span><br><span class="line">        <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Save method not supported&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;SecurityContext&gt; <span class="title function_">load</span><span class="params">(ServerWebExchange exchange)</span> &#123;</span><br><span class="line">        <span class="comment">// 在这里实现JWT解析和安全上下文的加载</span></span><br><span class="line">        <span class="comment">// 简单示例中，可以直接返回空Mono，或根据需要添加逻辑</span></span><br><span class="line">        <span class="keyword">return</span> Mono.empty();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li><li><p><strong>参考示例</strong></p><p>在Spring Security中，<code>ServerSecurityContextRepository</code>用于在每个请求上加载或创建<code>SecurityContext</code>，这是处理安全上下文的一部分。默认行为是，在请求开始时尝试加载安全上下文，以便在处理请求时可以使用当前安全状态。也就是说默认<code>load</code>方法总是会在每次请求的时候被执行，因此对于不需要认证的路径（如使用<code>permitAll()</code>配置的路径），如果没有有效的认证Token，方法应该能够快速返回，而不影响请求的处理。否则就会造成“你需要先认证才能登录，而你又需要先登录才能认证”的局面。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtSecurityContextRepository</span> <span class="keyword">implements</span> <span class="title class_">ServerSecurityContextRepository</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactiveAuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtSecurityContextRepository</span><span class="params">(ReactiveAuthenticationManager authenticationManager)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">save</span><span class="params">(ServerWebExchange exchange, SecurityContext context)</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>(<span class="string">&quot;Save method is not supported&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;SecurityContext&gt; <span class="title function_">load</span><span class="params">(ServerWebExchange exchange)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> exchange.getRequest().getURI().getPath();</span><br><span class="line">        <span class="comment">// 对于不需要认证的接口，直接返回Mono.empty()</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;/login&quot;</span>.equals(path) || <span class="string">&quot;/register&quot;</span>.equals(path)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> extractToken(exchange.getRequest());</span><br><span class="line">        <span class="comment">// 如果Token为空，也直接返回Mono.empty()</span></span><br><span class="line">        <span class="keyword">if</span> (token == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">auth</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(token, token);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.jwtAuthenticationManager.authenticate(auth).map(SecurityContextImpl::<span class="keyword">new</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">extractToken</span><span class="params">(ServerHttpRequest request)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">bearerToken</span> <span class="operator">=</span> request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(bearerToken) &amp;&amp; bearerToken.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> bearerToken.substring(<span class="number">7</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></li></ul><p><strong>协作示例</strong></p><p>当一个请求到达应用时：</p><ol><li>**<code>JwtAuthenticationFilter</code>**拦截请求，从请求头中提取JWT Token，并构造一个未经认证的<code>Authentication</code>对象，然后提交给<code>JwtAuthenticationManager</code>。</li><li>**<code>JwtAuthenticationManager</code>**接收到未经认证的<code>Authentication</code>对象，验证JWT Token的有效性。如果验证通过，它将创建一个已认证的<code>Authentication</code>对象，包含用户的权限等信息。</li><li>在整个请求处理流程中，**<code>JwtSecurityContextRepository</code>**负责根据<code>JwtAuthenticationManager</code>验证后的<code>Authentication</code>对象构建<code>SecurityContext</code>，并使其在当前请求上下文中可用。</li><li>根据<code>SecurityContext</code>中的认证信息，Spring Security框架执行后续的授权判断。</li></ol><p>这三个组件的协作实现了一个完整的基于JWT的认证和授权流程，使得应用能够处理无状态的HTTP请求。</p><blockquote><p>以上三个核心组件虽然覆盖了JWT认证流程的主要部分：提取Token、验证Token、以及根据Token重建安全上下文。不过，根据具体的应用需求和安全要求，可能还会涉及其他重要的组件或配置。以下是一些可能涉及到的额外组件或方法：</p><h3 id="1-authenticationentrypoint"><a class="markdownIt-Anchor" href="#1-authenticationentrypoint"></a> 1. AuthenticationEntryPoint</h3><p>用于处理认证过程中的异常，如Token无效或过期时的情况。<code>AuthenticationEntryPoint</code>负责在认证失败时返回适当的响应，比如一个401 Unauthorized状态码。</p><p>简单示例</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title class_">ServerAuthenticationEntryPoint</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Mono&lt;Void&gt; <span class="title function_">commence</span><span class="params">(ServerWebExchange exchange, AuthenticationException e)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.fromRunnable(() -&gt; &#123;</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="comment">// 你可以添加更多的响应设置，如设置响应体</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h3 id="2-accessdeniedhandler"><a class="markdownIt-Anchor" href="#2-accessdeniedhandler"></a> 2. AccessDeniedHandler</h3><p>当用户尝试访问他们没有权限访问的资源时，<code>AccessDeniedHandler</code>负责处理这种授权失败的情况。它可以用于返回一个403 Forbidden响应或重定向到一个错误页面。</p><h3 id="3-corsconfigurationsource"><a class="markdownIt-Anchor" href="#3-corsconfigurationsource"></a> 3. CorsConfigurationSource</h3><p>在前后端分离的应用中，跨源资源共享（CORS）配置变得非常重要。<code>CorsConfigurationSource</code>用于定义CORS策略，允许或拒绝来自不同源的请求。</p><h3 id="4-tokenrefreshmechanism"><a class="markdownIt-Anchor" href="#4-tokenrefreshmechanism"></a> 4. TokenRefreshMechanism</h3><p>虽然不是Spring Security的标准部分，但在许多基于Token的认证系统中，实现Token刷新机制是一个常见需求。这涉及到提供一个机制，允许客户端在当前Token快要过期时，通过一个有效的刷新Token来获取一个新的访问Token。</p><h3 id="5-userdetails和userdetailsservice"><a class="markdownIt-Anchor" href="#5-userdetails和userdetailsservice"></a> 5. UserDetails和UserDetailsService</h3><p><code>UserDetailsService</code>用于在认证过程中加载用户特定的数据。它通常与<code>UserDetails</code>接口一起使用，后者表示一个用户的认证信息。在JWT认证过程中，一旦Token被验证，可以通过<code>UserDetailsService</code>加载用户的详细信息，并构建一个<code>UserDetails</code>对象，进一步用于构建<code>Authentication</code>对象。</p><h3 id="6-reactive-counterparts-for-webflux"><a class="markdownIt-Anchor" href="#6-reactive-counterparts-for-webflux"></a> 6. Reactive counterparts for WebFlux</h3><p>对于使用Spring WebFlux的应用，上述组件（如<code>AuthenticationEntryPoint</code>、<code>AccessDeniedHandler</code>等）有相应的反应式版本或等效方法，以支持响应式编程模型。</p></blockquote><p><strong>其他重要的方法</strong></p><p><strong>Token的生成和响应</strong>：在用户登录成功后，需要一个服务或控制器方法来生成JWT Token，并将其返回给客户端。这通常发生在用户认证成功后的登录接口中。<strong>这里的功能需要在三层架构中实现，下文中会提到三层架构的适配。</strong></p><h5 id="spring-security-配置"><a class="markdownIt-Anchor" href="#spring-security-配置"></a> Spring Security 配置</h5><p>接下来，配置 Spring Security 以集成 JWT 认证。这包括定义一个自定义的认证管理器和安全过滤器链，用于解析请求中的 JWT Token 并进行认证</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义JwtUtil Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtUtil <span class="title function_">jwtUtil</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtUtil</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义JwtAuthenticationManager Bean</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationManager <span class="title function_">jwtAuthenticationManager</span><span class="params">(JwtUtil jwtUtil)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationManager</span>(jwtUtil);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义JwtSecurityContextRepository Bean，依赖JwtAuthenticationManager</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtSecurityContextRepository <span class="title function_">jwtSecurityContextRepository</span><span class="params">(JwtAuthenticationManager jwtAuthenticationManager)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtSecurityContextRepository</span>(jwtAuthenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义JwtAuthenticationFilter Bean，依赖JwtSecurityContextRepository</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAuthenticationFilter <span class="title function_">jwtAuthenticationFilter</span><span class="params">(JwtSecurityContextRepository jwtSecurityContextRepository)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtAuthenticationFilter</span>(jwtSecurityContextRepository);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(ServerHttpSecurity http,</span></span><br><span class="line"><span class="params">                                                         JwtAuthenticationManager jwtAuthenticationManager,</span></span><br><span class="line"><span class="params">                                                         JwtSecurityContextRepository jwtSecurityContextRepository)</span> &#123;</span><br><span class="line">        http</span><br><span class="line">                .csrf(ServerHttpSecurity.CsrfSpec::disable) <span class="comment">// 禁用CSRF保护，对于REST API是常见的做法</span></span><br><span class="line">                .authenticationManager(jwtAuthenticationManager) <span class="comment">// 设置自定义的认证管理器</span></span><br><span class="line">                .securityContextRepository(jwtSecurityContextRepository) <span class="comment">// 设置自定义的安全上下文仓库</span></span><br><span class="line">                .authorizeExchange(exchanges -&gt; exchanges</span><br><span class="line">                        .pathMatchers(<span class="string">&quot;/api/public/**&quot;</span>).permitAll() <span class="comment">// 公开访问的路径</span></span><br><span class="line">                        .anyExchange().authenticated() <span class="comment">// 其他所有路径都需要认证</span></span><br><span class="line">                )</span><br><span class="line">                .addFilterAt(jwtAuthenticationFilter(jwtSecurityContextRepository), SecurityWebFiltersOrder.AUTHENTICATION); <span class="comment">// 添加自定义JWT认证过滤器</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="三层架构的适配"><a class="markdownIt-Anchor" href="#三层架构的适配"></a> 三层架构的适配</h4><p>设置好基于JWT的认证机制并且配置了Spring Security之后，下一步是确保三层架构（表示层、业务逻辑层、数据访问层）能够与这些安全配置无缝协作。以下是参考的适配流程</p><h5 id="大致流程"><a class="markdownIt-Anchor" href="#大致流程"></a> 大致流程</h5><p><strong>1.定义安全模型</strong></p><p>首先，定义应用中的安全模型，包括用户角色和权限模型。这可能涉及到在数据库中创建角色和权限表，并确定哪些API端点对应哪些角色或权限。</p><p><strong>2.调整用户模型和数据访问层</strong></p><ul><li>确保用户模型（通常是<code>User</code>实体）包含与安全相关的属性，如密码、角色列表等。</li><li>更新用户的数据访问层（例如，用户的Repository），以支持查找用户的安全凭证（用户名和密码）、角色和权限。</li></ul><p><strong>3.实现UserDetailsService</strong></p><ul><li>实现<code>UserDetailsService</code>接口，提供一种从数据库加载用户详情（包括权限）的方式。这是Spring Security调用来获取用户信息并进行认证的服务。</li><li>在<code>loadUserByUsername</code>方法中，根据用户名查找用户，构建并返回一个<code>UserDetails</code>对象，这个对象应包含用户名、密码和权限信息。</li></ul><p><strong>4.配置方法级别的安全性</strong></p><ul><li>使用<code>@PreAuthorize</code>、<code>@PostAuthorize</code>、<code>@Secured</code>等注解来指定方法级别的安全要求。例如，可以在服务层的方法上使用这些注解来限定只有特定角色的用户才能调用某个方法。</li></ul><p><strong>5.保护API端点</strong></p><ul><li>根据的安全模型调整<code>SecurityWebFilterChain</code>中的<code>.authorizeExchange()</code>部分，指定哪些API端点是公开的，哪些需要认证，以及它们所需的权限或角色。</li><li>例如，可以使用<code>.pathMatchers(&quot;/api/admin/**&quot;).hasRole(&quot;ADMIN&quot;)</code>来保护以<code>/api/admin/</code>开头的所有端点，使其只能由拥有<code>ADMIN</code>角色的用户访问。</li></ul><p><strong>6.处理认证和授权失败</strong></p><ul><li>自定义认证失败和授权失败的处理逻辑，比如返回特定的HTTP状态码或错误信息给客户端。这可以通过自定义<code>AuthenticationEntryPoint</code>和<code>AccessDeniedHandler</code>来实现。</li></ul><p><strong>7.测试</strong></p><ul><li>对整个安全配置进行测试，包括但不限于：<ul><li>测试未认证的请求是否被正确拒绝。</li><li>测试具有不同角色的用户是否只能访问他们有权限的API端点。</li><li>测试用户认证流程，包括使用JWT进行认证。</li></ul></li></ul><p>上面的流程仅供参考，实际简单场景可能不需要考虑那么多繁琐的步骤。</p><h5 id="具体实现"><a class="markdownIt-Anchor" href="#具体实现"></a> 具体实现</h5><h6 id="数据库"><a class="markdownIt-Anchor" href="#数据库"></a> 数据库</h6><p>首先创建好数据库中对应的数据表和初始测试数据，主键采用<code>serial</code>伪类型自动递增，参考如下</p><div class="highlight-container" data-rel="Postgresql"><figure class="iseeu highlight postgresql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 用户</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> users</span><br><span class="line">(</span><br><span class="line">    id       <span class="type">serial</span> <span class="keyword">primary key</span>,</span><br><span class="line">    username <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">unique</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">password</span> <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> users (username, <span class="keyword">password</span>) <span class="keyword">values</span> (<span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> users (username, <span class="keyword">password</span>) <span class="keyword">values</span> (<span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"><span class="comment">-- 角色</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> roles</span><br><span class="line">(</span><br><span class="line">    id   <span class="type">serial</span> <span class="keyword">primary key</span>,</span><br><span class="line">    <span class="type">name</span> <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> roles (<span class="type">name</span>) <span class="keyword">values</span> (<span class="string">&#x27;admin&#x27;</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> roles (<span class="type">name</span>) <span class="keyword">values</span> (<span class="string">&#x27;user&#x27;</span>);</span><br><span class="line"><span class="comment">-- 用户角色</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> user_role</span><br><span class="line">(</span><br><span class="line">    user_id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    role_id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">    <span class="keyword">primary key</span> (user_id, role_id),</span><br><span class="line">    <span class="keyword">constraint</span> fk_user_id <span class="keyword">foreign key</span> (user_id) <span class="keyword">references</span> users (id),</span><br><span class="line">    <span class="keyword">constraint</span> fk_role_id <span class="keyword">foreign key</span> (role_id) <span class="keyword">references</span> roles (id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role (user_id, role_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> user_role (user_id, role_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure></div><blockquote><p>不推荐直接将密码明文存储在数据库中，这里是为了方便测试，通常应该将明文加密后再存储到数据库中。</p></blockquote><h6 id="实体类"><a class="markdownIt-Anchor" href="#实体类"></a> 实体类</h6><p>然后创建好对应的实体类</p><p>users 数据表对应实体类 User</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table(&quot;users&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>roles 数据表对应实体类 Role</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Table(&quot;roles&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>user_role 数据表对应实体类 UserRole</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRole</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> Integer roleId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h6 id="数据访问层"><a class="markdownIt-Anchor" href="#数据访问层"></a> 数据访问层</h6><p>这里假设已经提供了<code>databaseClient</code></p><ul><li>登录的逻辑被拆分为两次查询，第一次查询是验证该用户是否存在，第二次查询是获取用户所有的角色列表。密码验证的逻辑在服务层实现。</li><li>注册的逻辑比较复杂，注册提供的数据有用户名、密码和角色名称列表。首先是根据用户名查询<code>users</code>表判断该用户名是否已经注册，如果该用户名未被注册，则新增数据并返回新增数据的<code>id</code>字段（在 Postgresql 中通过<code>returning</code>语法实现新增时返回新增数据的<code>id</code>字段），然后是根据角色名称列表查询<code>roles</code>表得到角色id列表，最后将唯一的用户id和角色id列表批量增加到<code>user_role</code>表中。</li></ul><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;User&gt; <span class="title function_">findByUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> databaseClient.sql(<span class="string">&quot;select * from users where username = :username&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;username&quot;</span>, username)</span><br><span class="line">        .map((row, rowMetadata) -&gt; <span class="keyword">new</span> <span class="title class_">User</span>(</span><br><span class="line">            row.get(<span class="string">&quot;id&quot;</span>, Integer.class), <span class="comment">// 这里的id是自增的，所以不需要传入</span></span><br><span class="line">            row.get(<span class="string">&quot;username&quot;</span>, String.class),</span><br><span class="line">            row.get(<span class="string">&quot;password&quot;</span>, String.class)))</span><br><span class="line">        .one();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;UserRoleDTO&gt; <span class="title function_">getUserRole</span><span class="params">(String username)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> databaseClient.sql(<span class="string">&quot;select username, name &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;from users u &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;join user_role ur on u.id = ur.user_id &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;join roles r on ur.role_id = r.id &quot;</span> +</span><br><span class="line">                              <span class="string">&quot;where username = :username&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;username&quot;</span>, username)</span><br><span class="line">        .map((row, rowMetadata) -&gt; Tuples.of(</span><br><span class="line">            row.get(<span class="string">&quot;username&quot;</span>, String.class),</span><br><span class="line">            row.get(<span class="string">&quot;name&quot;</span>, String.class)))</span><br><span class="line">        .all()</span><br><span class="line">        .collectMultimap(tuple -&gt; tuple.getT1(), tuple -&gt; tuple.getT2())</span><br><span class="line">        .flatMap(map -&gt; &#123;</span><br><span class="line">            <span class="comment">// 从map中取出username和对应的roles列表</span></span><br><span class="line">            <span class="keyword">return</span> Mono.justOrEmpty(map.entrySet().stream()</span><br><span class="line">                                    .map(entry -&gt; <span class="keyword">new</span> <span class="title class_">UserRoleDTO</span>(entry.getKey(), <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(entry.getValue())))</span><br><span class="line">                                    .findFirst());</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Integer&gt; <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">    <span class="comment">// 返回插入的id，这里的密码应该是加密后的</span></span><br><span class="line">    <span class="keyword">return</span> databaseClient.sql(<span class="string">&quot;insert into users (username, password) values (:username, :password) returning id&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;username&quot;</span>, user.getUsername())</span><br><span class="line">        .bind(<span class="string">&quot;password&quot;</span>, user.getPassword())</span><br><span class="line">        .map((row, rowMetadata) -&gt; row.get(<span class="string">&quot;id&quot;</span>, Integer.class))</span><br><span class="line">        .first();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;Long&gt; <span class="title function_">insertUserRole</span><span class="params">(Integer userId, UserRoleDTO userRoleDTO)</span> &#123;</span><br><span class="line">    <span class="comment">// 根据角色名查询对应的id，然后插入到user_role表中</span></span><br><span class="line">    <span class="keyword">return</span> databaseClient.sql(<span class="string">&quot;select id from roles where name in (:names)&quot;</span>)</span><br><span class="line">        .bind(<span class="string">&quot;names&quot;</span>, userRoleDTO.getRoles())</span><br><span class="line">        .fetch()</span><br><span class="line">        .all()</span><br><span class="line">        .flatMap(row -&gt;</span><br><span class="line">                 databaseClient.sql(<span class="string">&quot;insert into user_role (user_id, role_id) values (:user_id, :role_id)&quot;</span>)</span><br><span class="line">                 .bind(<span class="string">&quot;user_id&quot;</span>, userId)</span><br><span class="line">                 .bind(<span class="string">&quot;role_id&quot;</span>, (Integer) row.get(<span class="string">&quot;id&quot;</span>))</span><br><span class="line">                 .fetch()</span><br><span class="line">                 .rowsUpdated()</span><br><span class="line">                ).reduce(<span class="number">0L</span>, Long::sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>这里提供了一个<code>UserRoleDTO</code>，对应前面的 Token 生成逻辑，传入<code>username</code>和<code>roles</code>用于 Token 的生成</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserRoleDTO</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; roles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h6 id="服务层"><a class="markdownIt-Anchor" href="#服务层"></a> 服务层</h6><ul><li><p><strong><code>login</code></strong>：先根据<code>username</code>参数查询用户，然后比较<code>password</code>（实际的密码比较应该使用专门的类处理，下文会补充），如果通过了验证，则使用<code>UserDTO</code>的数据生成 Token，并将 Token 传输到控制层。</p></li><li><p><strong><code>register</code></strong>：先用<code>UserRoleDTO</code>的<code>username</code>查询用户是否已注册，如果没有注册过则将<code>username</code>和<code>password</code>封装成一个<code>User</code>用于新增用户，然后用新增用户返回的<code>userId</code>和<code>UserRoleDTO</code>一并传给新增用户角色方法，用户角色列表数据新增完成后生成 Token 并传输到控制层。</p></li></ul><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">login</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRepo.findByUsername(username)</span><br><span class="line">        .flatMap(user -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (user.getPassword().equals(password)) &#123;</span><br><span class="line">                <span class="keyword">return</span> userRepo.getUserRole(username)</span><br><span class="line">                    .flatMap(userRole -&gt; Mono.fromSupplier(() -&gt;</span><br><span class="line">                                                           jwtUtil.generateToken(username, userRole.getRoles()))</span><br><span class="line">                            );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty();</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">register</span><span class="params">(UserRoleDTO userRoleDTO, String password)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRepo.findByUsername(userRoleDTO.getUsername())</span><br><span class="line">        .flatMap(user -&gt; Mono.just(<span class="string">&quot;User already exists&quot;</span>))</span><br><span class="line">        .switchIfEmpty(Mono.defer(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// id为null，由数据库自动生成</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, userRoleDTO.getUsername(), password);</span><br><span class="line">            <span class="keyword">return</span> userRepo.insertUser(user)</span><br><span class="line">                .flatMap(userId -&gt; userRepo.insertUserRole(userId, userRoleDTO)</span><br><span class="line">                         .thenReturn(jwtUtil.generateToken(userRoleDTO.getUsername(), userRoleDTO.getRoles())));</span><br><span class="line">        &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h6 id="控制层"><a class="markdownIt-Anchor" href="#控制层"></a> 控制层</h6><p>handler 处理器中将 Token 存入响应头，或者也可以存入封装好的响应体中</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">login</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> request.bodyToMono(LoginRequest.class)</span><br><span class="line">        .flatMap(login -&gt;</span><br><span class="line">                 userService.login(login.getUsername(), login.getPassword())</span><br><span class="line">                )</span><br><span class="line">        .flatMap(token -&gt;</span><br><span class="line">                 ServerResponse.ok()</span><br><span class="line">                 .header(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + token) <span class="comment">// 将生成的Token放入响应头</span></span><br><span class="line">                 .bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">200</span>, token))</span><br><span class="line">                )</span><br><span class="line">        .switchIfEmpty(ServerResponse.status(HttpStatus.UNAUTHORIZED).build());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title function_">register</span><span class="params">(ServerRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> request.bodyToMono(RegisterRequest.class)</span><br><span class="line">        .flatMap(register -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> register.getUsername();</span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> register.getPassword();</span><br><span class="line">            List&lt;String&gt; roles = register.getRoles();</span><br><span class="line">            <span class="type">UserRoleDTO</span> <span class="variable">userRoleDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserRoleDTO</span>(username, roles);</span><br><span class="line">            <span class="keyword">return</span> userService.register(userRoleDTO, password)</span><br><span class="line">                .flatMap(token -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;User already exists&quot;</span>.equals(token)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> ServerResponse.status(HttpStatus.CONFLICT)</span><br><span class="line">                            .bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">409</span>, token));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> ServerResponse.ok()</span><br><span class="line">                        .header(HttpHeaders.AUTHORIZATION, <span class="string">&quot;Bearer &quot;</span> + token) <span class="comment">// 将生成的Token放入响应头</span></span><br><span class="line">                        .bodyValue(<span class="keyword">new</span> <span class="title class_">ApiResponse</span>&lt;&gt;(<span class="number">200</span>, token));</span><br><span class="line">                &#125;</span><br><span class="line">                        );</span><br><span class="line">        &#125;)</span><br><span class="line">        .switchIfEmpty(ServerResponse.status(HttpStatus.UNAUTHORIZED).build());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>在这里需要接受前端不同的请求数据，为了方便处理自定义了<code>LoginRequst</code>和<code>RegisterRequest</code>，内容如下</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LoginRequest.java</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginRequest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RegisterRequest.java</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterRequest</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; roles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>RouterConfig 路由配置中定义请求方式和 URL</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title function_">userRoutes</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RouterFunctions</span><br><span class="line">        .route(RequestPredicates.POST(<span class="string">&quot;/login&quot;</span>), userHandler::login)</span><br><span class="line">        .andRoute(RequestPredicates.POST(<span class="string">&quot;/register&quot;</span>), userHandler::register);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h6 id="安全层"><a class="markdownIt-Anchor" href="#安全层"></a> 安全层</h6><p>只需要添加对应路径的角色权限即可，例如<code>/api/admin/</code>前缀的所有路径需要<code>ROLE_ADMIN</code>权限。这个权限的加载已经在前面的<code>JwtAuthenticationManager</code>中实现。</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityWebFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(ServerHttpSecurity http)</span> &#123;</span><br><span class="line">    http</span><br><span class="line">        .csrf(ServerHttpSecurity.CsrfSpec::disable)</span><br><span class="line">        .formLogin(ServerHttpSecurity.FormLoginSpec::disable)</span><br><span class="line">        .httpBasic(ServerHttpSecurity.HttpBasicSpec::disable)</span><br><span class="line">        .authenticationManager(jwtAuthenticationManager())</span><br><span class="line">        .securityContextRepository(jwtSecurityContextRepository())</span><br><span class="line">        .authorizeExchange(exchanges -&gt; exchanges</span><br><span class="line">                           .pathMatchers(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>).permitAll()</span><br><span class="line">                           .pathMatchers(<span class="string">&quot;/api/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                           .anyExchange().authenticated()</span><br><span class="line">                          )</span><br><span class="line">        .addFilterAt(jwtAuthenticationFilter(), SecurityWebFiltersOrder.AUTHENTICATION);</span><br><span class="line">    <span class="keyword">return</span> http.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h4 id="passwordencoder-密码加密"><a class="markdownIt-Anchor" href="#passwordencoder-密码加密"></a> PasswordEncoder 密码加密</h4><p>前面直接比较明文密码（<code>user.getPassword().equals(password)</code>）并不是一个安全的做法。为了增强安全性，应该使用密码哈希值进行存储和验证。Spring Security提供了<code>PasswordEncoder</code>接口来帮助实现密码的加密和验证。</p><h5 id="引入passwordencoder"><a class="markdownIt-Anchor" href="#引入passwordencoder"></a> 引入<code>PasswordEncoder</code></h5><p>首先，需要在 Spring 配置中定义一个<code>PasswordEncoder</code>的Bean。自Spring Security 5起，推荐使用<code>BCryptPasswordEncoder</code>，它是一种基于bcrypt强哈希方法的密码编码器</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="更新用户注册逻辑"><a class="markdownIt-Anchor" href="#更新用户注册逻辑"></a> 更新用户注册逻辑</h5><p>在用户注册或创建密码时，使用<code>PasswordEncoder</code>对密码进行加密，并存储加密后的密码</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">register</span><span class="params">(UserRoleDTO userRoleDTO, String rawPassword)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRepo.findByUsername(userRoleDTO.getUsername())</span><br><span class="line">        .flatMap(user -&gt; Mono.just(<span class="string">&quot;User already exists&quot;</span>))</span><br><span class="line">        .switchIfEmpty(Mono.defer(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> passwordEncoder.encode(rawPassword); <span class="comment">// 使用encode方法加密密码</span></span><br><span class="line">            <span class="comment">// id为null，由数据库自动生成</span></span><br><span class="line">            <span class="comment">// 创建User对象，设置加密后的密码，然后保存User对象</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, userRoleDTO.getUsername(), password);</span><br><span class="line">            <span class="keyword">return</span> userRepo.insertUser(user)</span><br><span class="line">                .flatMap(userId -&gt; userRepo.insertUserRole(userId, userRoleDTO)</span><br><span class="line">                         .thenReturn(jwtUtil.generateToken(userRoleDTO.getUsername(), userRoleDTO.getRoles())));</span><br><span class="line">        &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><h5 id="更新登录验证逻辑"><a class="markdownIt-Anchor" href="#更新登录验证逻辑"></a> 更新登录验证逻辑</h5><p>在登录逻辑中，使用<code>PasswordEncoder</code>的<code>matches</code>方法来验证提交的密码与存储的加密密码是否匹配</p><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Mono&lt;String&gt; <span class="title function_">login</span><span class="params">(String username, String rawPassword)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> userRepo.findByUsername(username)</span><br><span class="line">        .flatMap(user -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (passwordEncoder.matches(rawPassword, user.getPassword())) &#123; <span class="comment">// 使用matches方法验证密码</span></span><br><span class="line">                <span class="keyword">return</span> userRepo.getUserRole(username)</span><br><span class="line">                    .flatMap(userRole -&gt; Mono.fromSupplier(() -&gt;</span><br><span class="line">                                                           jwtUtil.generateToken(username, userRole.getRoles()))</span><br><span class="line">                            );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> Mono.empty(); <span class="comment">// 密码不匹配时返回空</span></span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div><p>通过使用<code>PasswordEncoder</code>，可以增强系统的安全性，防止密码泄露时直接暴露用户的明文密码。同时，这也是符合安全最佳实践的做法。</p><h3 id="总结-3"><a class="markdownIt-Anchor" href="#总结-3"></a> 总结</h3><p>关于 Spring Webflux 还有很多其它可以实践的内容，例如整合<code>OAuth2</code>进行第三方服务鉴权认证、使用响应式 Web 客户端<code>WebClient</code>调用外部 HTTP 服务等。</p><p>以上就是基于 Spring Webflux 响应式框架后端项目开发过程中涉及到的主要内容。其实关于 Spring Webflux 的应用并没有传统的 Spring Web 那么广泛，而且使用 Spring Webflux 需要有一定的函数式编程与响应式编程的熟练度，对于习惯了传统 Spring Web 框架的开发者来说是具有一定的难度，但是它提供了一种不同于传统同步阻塞模型的异步非阻塞模型的视角来看待问题。</p></div><div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8"><div class="article-copyright-info-container"><ul><li><strong>标题:</strong> webflux-project</li><li><strong>作者:</strong> Entropy</li><li><strong>创建于 :</strong> 2024-02-09 16:25:56</li><li><strong>更新于 :</strong> 2024-02-09 16:25:56</li><li><strong>链接:</strong> https://www.entropy-tree.top/2024/02/09/webflux-project/</li><li><strong>版权声明: </strong>本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。</li></ul></div></div><ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden"><li class="tag-item mx-0.5"><a href="/tags/Spring-Webflux/">#Spring Webflux</a>&nbsp;</li></ul><div class="recommended-article px-2 sm:px-6 md:px-8"><div class="recommended-desktop"><div class="recommended-article-header text-xl md:text-3xl font-bold mt-10"><i aria-hidden="true"></i><span>推荐阅读</span></div><div class="recommended-article-group"><a class="recommended-article-item" href="/2023/02/22/golang-day16/" title="深入理解 RDBMS" rel="bookmark"><img src="/images/wallhaven-wqery6-light.webp" alt="深入理解 RDBMS" class="!max-w-none"> <span class="title">深入理解 RDBMS</span> </a><a class="recommended-article-item" href="/2023/02/22/golang-day15/" title="存储的本质 - 状态" rel="bookmark"><img src="/images/wallhaven-wqery6-light.webp" alt="存储的本质 - 状态" class="!max-w-none"> <span class="title">存储的本质 - 状态</span> </a><a class="recommended-article-item" href="/2023/02/22/golang-day17/" title="Redis" rel="bookmark"><img src="/images/wallhaven-wqery6-light.webp" alt="Redis" class="!max-w-none"> <span class="title">Redis</span></a></div></div><div class="recommended-mobile"><div class="recommended-article-header text-xl md:text-3xl font-bold mt-10"><i aria-hidden="true"></i><span>推荐阅读</span></div><div class="recommended-article-group"><a class="recommended-article-item" href="/2023/02/22/golang-day16/" title="深入理解 RDBMS" rel="bookmark"><img src="/images/wallhaven-wqery6-light.webp" alt="深入理解 RDBMS" class="!max-w-none"> <span class="title">深入理解 RDBMS</span> </a><a class="recommended-article-item" href="/2023/02/22/golang-day15/" title="存储的本质 - 状态" rel="bookmark"><img src="/images/wallhaven-wqery6-light.webp" alt="存储的本质 - 状态" class="!max-w-none"> <span class="title">存储的本质 - 状态</span></a></div></div></div><div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8"><div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="prev" rel="prev" href="/2024/02/20/monorepo-setup-guide/"><span class="left arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-left"></i> </span><span class="title flex justify-center items-center"><span class="post-nav-title-item">Monorepo 规范实践</span> <span class="post-nav-item">上一篇</span></span></a></div><div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2"><a class="next" rel="next" href="/2024/01/25/simple-nvidia-setup-for-linux/"><span class="title flex justify-center items-center"><span class="post-nav-title-item">简单配置 Linux 上的 NVIDIA</span> <span class="post-nav-item">下一篇</span> </span><span class="right arrow-icon flex justify-center items-center"><i class="fa-solid fa-chevron-right"></i></span></a></div></div><div class="comment-container px-2 sm:px-6 md:px-8 pb-8"><div class="comments-container mt-10 w-full"><div id="comment-anchor" class="w-full h-2.5"></div><div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">评论</div><div id="waline"></div><script type="module" data-swup-reload-script>import{init}from"/js/libs/waline.mjs";function loadWaline(){init({el:"#waline",serverURL:"https://comment.entropy-tree.top",lang:"zh-CN",dark:'body[class~="dark-mode"]',requiredMeta:["nick","mail"],emoji:[],recaptchaV3Key:"wasd"})}"undefined"!=typeof swup?loadWaline():window.addEventListener("DOMContentLoaded",loadWaline)</script></div></div></div><div class="toc-content-container"><div class="post-toc-wrap"><div class="post-toc"><div class="toc-title">此页目录</div><div class="page-title">webflux-project</div><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B-po-bo-dto-vo-do"><span class="nav-text">对象模型 PO BO DTO VO (DO)</span></a></li></ol><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E5%9C%BA%E6%99%AF%E6%A1%88%E4%BE%8B"><span class="nav-text">复杂场景案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E6%8F%8F%E8%BF%B0"><span class="nav-text">场景描述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%89%E5%8F%8A%E7%9A%84%E6%A8%A1%E5%9E%8B%E5%92%8C%E5%B1%82%E6%AC%A1"><span class="nav-text">涉及的模型和层次</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E8%BD%AC"><span class="nav-text">数据流转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%96%E9%94%AE%E5%85%B3%E8%81%94%E7%BA%A6%E6%9D%9F%E4%B8%8B-po-%E7%9A%84%E6%98%A0%E5%B0%84%E8%A1%8C%E4%B8%BA"><span class="nav-text">外键关联约束下 PO 的映射行为</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%84%E7%A7%8D-er-%E5%85%B3%E7%B3%BB%E4%B8%8B%E7%9A%84%E5%AF%B9%E8%B1%A1%E6%A8%A1%E5%9E%8B%E8%AE%BE%E8%AE%A1"><span class="nav-text">各种 ER 关系下的对象模型设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83"><span class="nav-text">基础环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webflux-%E6%8E%A7%E5%88%B6%E5%B1%82"><span class="nav-text">Webflux 控制层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E-flatmap"><span class="nav-text">关于 flatMap</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E6%98%AF%E4%BB%80%E4%B9%88"><span class="nav-text">具体是什么？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BA%94%E8%AF%A5%E5%9C%A8%E5%93%AA%E9%87%8C%E4%BD%BF%E7%94%A8%E5%AE%83"><span class="nav-text">应该在哪里使用它？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BD%BF%E7%94%A8%E5%AE%83"><span class="nav-text">什么情况下使用它？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webflux-%E6%95%B0%E6%8D%AE%E8%AE%BF%E9%97%AE%E5%B1%82"><span class="nav-text">Webflux 数据访问层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AA%E7%89%88%E6%9C%AC"><span class="nav-text">比较两个版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%82%E5%90%88%E4%BD%BF%E7%94%A8fluxdefer%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-text">适合使用Flux.defer的场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E9%80%82%E5%90%88%E4%BD%BF%E7%94%A8fluxdefer%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="nav-text">不适合使用Flux.defer的场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="nav-text">不同的配置方式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A3%B0%E6%98%8E%E5%BC%8F%E9%85%8D%E7%BD%AE"><span class="nav-text">声明式配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E7%A8%8B%E5%BC%8F%E9%85%8D%E7%BD%AE"><span class="nav-text">编程式配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E9%85%8D%E7%BD%AE%E6%96%B9%E5%BC%8F"><span class="nav-text">其他配置方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E9%85%8D%E7%BD%AE%E7%B1%BB%E9%85%8D%E7%BD%AEmongodb%E5%92%8Cpostgresql"><span class="nav-text">使用配置类配置MongoDB和PostgreSQL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98-or-%E6%B8%85%E7%A9%BA%E7%BC%93%E5%AD%98"><span class="nav-text">更新缓存 or 清空缓存?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9B%B4%E6%96%B0%E7%BC%93%E5%AD%98"><span class="nav-text">更新缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B8%85%E7%A9%BA%E7%BC%93%E5%AD%98"><span class="nav-text">清空缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-2"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B3%E4%BA%8E%E6%B3%9B%E5%9E%8B%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">关于泛型的使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webflux-%E6%9C%8D%E5%8A%A1%E5%B1%82"><span class="nav-text">Webflux 服务层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E6%9F%A5%E8%AF%A2%E8%B4%A3%E4%BB%BB%E5%88%86%E7%A6%BB-cqrs"><span class="nav-text">命令查询责任分离 CQRS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cqrs%E7%9A%84%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="nav-text">CQRS的关键概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cqrs%E7%9A%84%E4%BC%98%E5%8A%BF"><span class="nav-text">CQRS的优势</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cqrs%E4%B8%8E%E6%95%B0%E6%8D%AE%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">CQRS与数据一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9C%BA%E6%99%AF%E8%AE%BE%E5%AE%9A"><span class="nav-text">场景设定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8postgresql%E5%92%8Cmongodb%E7%9A%84cqrs%E5%AE%9E%E7%8E%B0"><span class="nav-text">使用PostgreSQL和MongoDB的CQRS实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%92%8C%E4%B8%80%E8%87%B4%E6%80%A7"><span class="nav-text">数据同步和一致性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webflux-%E5%AE%89%E5%85%A8%E5%B1%82"><span class="nav-text">Webflux 安全层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-text">案例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8%E8%BF%99%E4%BA%9B%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E5%9C%B0%E8%AF%86%E5%88%AB%E7%94%A8%E6%88%B7%E8%BA%AB%E4%BB%BD"><span class="nav-text">如何使用这些信息安全地识别用户身份？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-authenticationentrypoint"><span class="nav-text">1. AuthenticationEntryPoint</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-accessdeniedhandler"><span class="nav-text">2. AccessDeniedHandler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-corsconfigurationsource"><span class="nav-text">3. CorsConfigurationSource</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-tokenrefreshmechanism"><span class="nav-text">4. TokenRefreshMechanism</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-userdetails%E5%92%8Cuserdetailsservice"><span class="nav-text">5. UserDetails和UserDetailsService</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6-reactive-counterparts-for-webflux"><span class="nav-text">6. Reactive counterparts for WebFlux</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93-3"><span class="nav-text">总结</span></a></li></ol></li></div></div></div></div></div></div><div class="main-content-footer"><footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color"><div class="info-container py-3 text-center"><div class="text-center">&copy; <span>2022</span> - 2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration:0.5s;color:#f54545"></i>&nbsp;&nbsp;<a href="/">Entropy</a><p class="post-count space-x-0.5"><span>共 51 篇文章 </span><span>共 182.2k 字</span></p></div><script data-swup-reload-script src="https://cn.vercount.one/js"></script><div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right"><span id="busuanzi_container_site_uv" class="lg:!block"><span class="text-sm">访问人数</span> <span id="busuanzi_value_site_uv"></span> </span><span id="busuanzi_container_site_pv" class="lg:!block"><span class="text-sm">总访问量</span> <span id="busuanzi_value_site_pv"></span></span></div><div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left"><span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span> <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span></div><div>博客已运行 <span class="odometer" id="runtime_days"></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒</div><script data-swup-reload-script>try{function odometer_init(){document.querySelectorAll(".odometer").forEach(e=>{new Odometer({el:e,format:"( ddd).dd",duration:200})})}odometer_init()}catch(e){}</script></div></footer></div></div><div class="post-tools"><div class="post-tools-container"><ul class="article-tools-list"><li class="right-bottom-tools page-aside-toggle"><i class="fa-regular fa-outdent"></i></li><li class="go-comment"><i class="fa-regular fa-comments"></i></li></ul></div></div><div class="right-side-tools-container"><div class="side-tools-container"><ul class="hidden-tools-list"><li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-plus"></i></li><li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center"><i class="fa-regular fa-magnifying-glass-minus"></i></li><li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center"><i class="fa-regular fa-moon"></i></li><li class="right-bottom-tools rss flex justify-center items-center"><a class="flex justify-center items-center" href="/atom.xml" target="_blank"><i class="fa-regular fa-rss"></i></a></li><li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center"><i class="fa-regular fa-arrow-up"></i></li><li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center"><i class="fa-regular fa-arrow-down"></i></li></ul><ul class="visible-tools-list"><li class="right-bottom-tools toggle-tools-list flex justify-center items-center"><i class="fa-regular fa-cog fa-spin"></i></li></ul></div></div><div class="image-viewer-container"><img src=""></div><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-input-field-pre"><i class="fa-solid fa-keyboard"></i></span><div class="search-input-container"><input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa-solid fa-times"></i></span></div><div id="search-result"><div id="no-result"><i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i></div></div></div></div></main><script src="/js/libs/Swup.min.js"></script><script src="/js/libs/SwupSlideTheme.min.js"></script><script src="/js/libs/SwupScriptsPlugin.min.js"></script><script src="/js/libs/SwupProgressPlugin.min.js"></script><script src="/js/libs/SwupScrollPlugin.min.js"></script><script src="/js/libs/SwupPreloadPlugin.min.js"></script><script>const swup=new Swup({plugins:[new SwupScriptsPlugin({optin:!0}),new SwupProgressPlugin,new SwupScrollPlugin({offset:80}),new SwupSlideTheme({mainElement:".main-content-body"}),new SwupPreloadPlugin],containers:["#swup"]})</script><script src="/js/tools/imageViewer.js" type="module"></script><script src="/js/utils.js" type="module"></script><script src="/js/main.js" type="module"></script><script src="/js/layouts/navbarShrink.js" type="module"></script><script src="/js/tools/scrollTopBottom.js" type="module"></script><script src="/js/tools/lightDarkSwitch.js" type="module"></script><script src="/js/layouts/categoryList.js" type="module"></script><script src="/js/tools/localSearch.js" type="module"></script><script src="/js/tools/codeBlock.js" type="module"></script><script src="/js/layouts/lazyload.js" type="module"></script><script src="/js/tools/runtime.js"></script><script src="/js/libs/odometer.min.js"></script><link rel="stylesheet" href="/assets/odometer-theme-minimal.css"><script src="/js/libs/Typed.min.js"></script><script src="/js/plugins/typed.js" type="module"></script><div class="post-scripts" data-swup-reload-script><script src="/js/tools/tocToggle.js" type="module"></script><script src="/js/layouts/toc.js" type="module"></script><script src="/js/plugins/tabs.js" type="module"></script></div><div id="aplayer"></div><script src="/js/libs/APlayer.min.js"></script><script src="/js/plugins/aplayer.js"></script></body></html>