<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"s-chance.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":true,"version":"8.14.1","exturl":false,"sidebar":{"position":"left","display":"hide","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="本文来源于第五届字节跳动青训营活动，已收录到golang高质量编程与性能调优 | 青训营笔记 - 掘金 (juejin.cn)，主要记录了对golang高质量编程与性能调优的学习">
<meta property="og:type" content="article">
<meta property="og:title" content="Go 高质量编程与性能调优">
<meta property="og:url" content="https://s-chance.github.io/2023/01/28/golang-day3/index.html">
<meta property="og:site_name" content="Entropy Tree">
<meta property="og:description" content="本文来源于第五届字节跳动青训营活动，已收录到golang高质量编程与性能调优 | 青训营笔记 - 掘金 (juejin.cn)，主要记录了对golang高质量编程与性能调优的学习">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-01-28T15:23:13.000Z">
<meta property="article:modified_time" content="2023-03-31T23:55:52.498Z">
<meta property="article:author" content="Entropy">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="golang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://s-chance.github.io/2023/01/28/golang-day3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://s-chance.github.io/2023/01/28/golang-day3/","path":"2023/01/28/golang-day3/","title":"Go 高质量编程与性能调优"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Go 高质量编程与性能调优 | Entropy Tree</title>
  







<link rel="dns-prefetch" href="https://waline-hexo-nu.vercel.app/">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<link rel="alternate" href="/atom.xml" title="Entropy Tree" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Entropy Tree</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">the truth of life</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>友链</a></li><li class="menu-item menu-item-rss"><a href="/atom.xml" rel="section"><i class="fa fa-rss fa-fw"></i>rss</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B%E4%B8%8E%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98"><span class="nav-text"> 高质量编程与性能调优实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E9%AB%98%E8%B4%A8%E9%87%8F%E7%BC%96%E7%A8%8B"><span class="nav-text"> 1.高质量编程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#11-%E7%AE%80%E4%BB%8B"><span class="nav-text"> 1.1 简介</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#12-%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83"><span class="nav-text"> 1.2 编码规范</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#121-%E4%BB%A3%E7%A0%81%E6%A0%BC%E5%BC%8F"><span class="nav-text"> 1.2.1 代码格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#122-%E6%B3%A8%E9%87%8A"><span class="nav-text"> 1.2.2 注释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#123-%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="nav-text"> 1.2.3 命名规范</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#124-%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B"><span class="nav-text"> 1.2.4 控制流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#125-%E9%94%99%E8%AF%AF%E5%92%8C%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-text"> 1.2.5 错误和异常处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#13-%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE"><span class="nav-text"> 1.3 性能优化建议</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#131-benchmark"><span class="nav-text"> 1.3.1 Benchmark</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#132-slice"><span class="nav-text"> 1.3.2 Slice</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#133-map"><span class="nav-text"> 1.3.3 Map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#134-%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%84%E7%90%86"><span class="nav-text"> 1.3.4 字符串处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#135-%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-text"> 1.3.5 空结构体</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#136-atomic%E5%8C%85"><span class="nav-text"> 1.3.6 atomic包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93"><span class="nav-text"> 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E5%AE%9E%E6%88%98"><span class="nav-text"> 2.性能调优实战</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#21-%E7%AE%80%E4%BB%8B"><span class="nav-text"> 2.1 简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#22-%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7-pprof"><span class="nav-text"> 2.2 性能分析工具 pprof</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#221-%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B"><span class="nav-text"> 2.2.1 功能简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#222-%E6%8E%92%E6%9F%A5%E5%AE%9E%E6%88%98"><span class="nav-text"> 2.2.2 排查实战</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#223-pprof%E7%9A%84%E9%87%87%E6%A0%B7%E8%BF%87%E7%A8%8B%E5%92%8C%E5%8E%9F%E7%90%86"><span class="nav-text"> 2.2.3 pprof的采样过程和原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="nav-text"> 小结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#23-%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98%E6%A1%88%E4%BE%8B"><span class="nav-text"> 2.3 性能调优案例</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#231-%E4%B8%9A%E5%8A%A1%E6%9C%8D%E5%8A%A1%E4%BC%98%E5%8C%96"><span class="nav-text"> 2.3.1 业务服务优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#232-%E5%9F%BA%E7%A1%80%E5%BA%93%E4%BC%98%E5%8C%96"><span class="nav-text"> 2.3.2 基础库优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#233-go%E8%AF%AD%E8%A8%80%E4%BC%98%E5%8C%96"><span class="nav-text"> 2.3.3 Go语言优化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#24-%E6%80%BB%E7%BB%93"><span class="nav-text"> 2.4 总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text"> 参考资料</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Entropy"
      src="/./images/avatar.jpg">
  <p class="site-author-name" itemprop="name">Entropy</p>
  <div class="site-description" itemprop="description">一名普通开发者的第一个博客</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">37</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">34</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/s-chance" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;s-chance" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/entropy_tree" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;entropy_tree" rel="noopener me" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/19329372/entropy" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;19329372&#x2F;entropy" rel="noopener me" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
    <div class="sidebar-inner sidebar-blogroll">
      <div class="links-of-blogroll animated">
        <div class="links-of-blogroll-title"><i class="fa fa-globe fa-fw"></i>
          链接
        </div>
        <ul class="links-of-blogroll-list">
            <li class="links-of-blogroll-item">
              <a href="https://www.entropy-tree.top/" title="https:&#x2F;&#x2F;www.entropy-tree.top" rel="noopener" target="_blank">镜像站</a>
            </li>
        </ul>
      </div>
    </div>
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://s-chance.github.io/2023/01/28/golang-day3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/./images/avatar.jpg">
      <meta itemprop="name" content="Entropy">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Entropy Tree">
      <meta itemprop="description" content="一名普通开发者的第一个博客">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Go 高质量编程与性能调优 | Entropy Tree">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Go 高质量编程与性能调优
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-01-28 23:23:13" itemprop="dateCreated datePublished" datetime="2023-01-28T23:23:13+08:00">2023-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-04-01 07:55:52" itemprop="dateModified" datetime="2023-04-01T07:55:52+08:00">2023-04-01</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E9%9D%92%E8%AE%AD%E8%90%A5%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">青训营记录</span></a>
        </span>
    </span>

  
  
  <span class="post-meta-item">
    
    <span class="post-meta-item-icon">
      <i class="far fa-comment"></i>
    </span>
    <span class="post-meta-item-text">Waline：</span>
  
    <a title="waline" href="/2023/01/28/golang-day3/#waline" itemprop="discussionUrl">
      <span class="post-comments-count waline-comment-count" data-path="/2023/01/28/golang-day3/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>12k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>本文来源于第五届字节跳动青训营活动，已收录到<a target="_blank" rel="noopener" href="https://juejin.cn/post/7194132732492906551">golang高质量编程与性能调优 | 青训营笔记 - 掘金 (juejin.cn)</a>，主要记录了对golang高质量编程与性能调优的学习<span id="more"></span></p>
<h2 id="高质量编程与性能调优实战"><a class="markdownIt-Anchor" href="#高质量编程与性能调优实战"></a> 高质量编程与性能调优实战</h2>
<p>主要内容</p>
<ul>
<li>如何编写更简洁清晰的代码</li>
<li>常用Go语言程序的优化手段</li>
<li>熟悉Go程序性能分析工具</li>
<li>了解工程中性能优化的原则和流程</li>
</ul>
<h3 id="1高质量编程"><a class="markdownIt-Anchor" href="#1高质量编程"></a> 1.高质量编程</h3>
<h4 id="11-简介"><a class="markdownIt-Anchor" href="#11-简介"></a> 1.1 简介</h4>
<p>高质量代码：编写的代码能够达到正确可靠、简洁清晰的目标。</p>
<ul>
<li>
<p>正确性：考虑各种边界条件，能够处理错误的调用。</p>
</li>
<li>
<p>可靠性：异常情况或者错误处理的策略明确，依赖的服务出现异常能够及时处理。</p>
</li>
<li>
<p>简单：逻辑简单，后续调整功能或新增功能能够快速支持。</p>
</li>
<li>
<p>清晰：其他人在阅读代码时容易理解，重构或者修改功能不会出现无法预料的问题。</p>
</li>
</ul>
<p>编程的原则</p>
<p><strong>简单性</strong></p>
<p>消除“多余的复杂性”，以简单清晰的逻辑编写代码。复杂的逻辑难以重构和优化，无法明确预知其调整造成的影响范围，也难以在排查问题时定位。</p>
<p><strong>可读性</strong></p>
<p>从后期来看，大部分工作是对已有功能的完善和扩展，对应功能的代码会存在很长时间。维护是一个项目最漫长的周期，好的可读性可以降低维护的时间成本。</p>
<p><strong>生产力</strong></p>
<p>Go语言有特定的代码格式限制，甚至有专门的工具强制统一所有代码格式。遵循代码规范，能够避免常见的缺陷代码，降低后续联调、测试、验证、上线等各个节点出现问题的概率以及快速排查定位问题。</p>
<h3 id="12-编码规范"><a class="markdownIt-Anchor" href="#12-编码规范"></a> 1.2 编码规范</h3>
<h4 id="121-代码格式"><a class="markdownIt-Anchor" href="#121-代码格式"></a> 1.2.1 代码格式</h4>
<p>推荐使用gofmt自动格式化代码，gofmt是Go语言官方提供的工具，能够自动格式化GO语言代码为官方统一风格，常见的IDE都支持配置。</p>
<p>另外的，goimports会对依赖包进行管理，自动增删依赖包引用，按字母排序分类。</p>
<h4 id="122-注释"><a class="markdownIt-Anchor" href="#122-注释"></a> 1.2.2 注释</h4>
<p>注释有以下四种使用方式</p>
<ul>
<li>
<p>解释代码作用。</p>
<p>适合说明公共符号，比如对外提供的函数用注释描述它的功能和用途，除非函数的功能简单而明显时，才可省略注释。</p>
<p>对于显而易见的内容不需要注释。</p>
</li>
<li>
<p>解释代码如何实现</p>
<p>适合说明逻辑实现过程，解释复杂的不明显的逻辑。</p>
<p>不要解释显而易见的流程，避免增加冗余信息和造成误解。</p>
</li>
<li>
<p>解释代码实现的原因</p>
<p>适合解释代码的外部因素，为什么需要实现这个代码，提供上下文信息，说明这段代码在上下文中的意义。</p>
</li>
<li>
<p>解释代码出错的可能情况</p>
<p>适合解释代码的限制条件，一些潜在的限制条件或者无法处理的情况，例如性能隐患，输入的限制条件，可能出现的错误情况等。使阅读者在不需要了解代码实现细节的情况下弄清限制条件。</p>
</li>
</ul>
<p><strong>公共符号始终要注释</strong></p>
<ul>
<li>包中声明的每个公共符号：变量、常量函数以及结构都需要添加注释</li>
<li>任何既不明显又不简短的公共功能必须予以注释</li>
<li>无论长度或复杂程度如何，对库中的函数都必须进行注释</li>
<li>例外情况，不需要注释实现接口的方法。</li>
</ul>
<p>更多规范的注释可以参考golang的官方仓库源码<a target="_blank" rel="noopener" href="https://github.com/golang/go/tree/master/src">golang/go</a></p>
<p><strong>小结</strong></p>
<ul>
<li>代码本身应该是最好的注释</li>
<li>注释应该提供代码未表达出的上下文信息</li>
</ul>
<h4 id="123-命名规范"><a class="markdownIt-Anchor" href="#123-命名规范"></a> 1.2.3 命名规范</h4>
<p>命名是代码编写中最常见的规范。</p>
<p><strong>variable</strong></p>
<ul>
<li>
<p>简洁胜于冗长</p>
</li>
<li>
<p>缩略词全大写，但当其位于变量开头且不需要对外提供时，使用全小写</p>
<p>例如，使用SeverHTTP而不是ServerHttp。使用XMLHTTPRequest或者xmlHTTPRequest。</p>
</li>
<li>
<p>变量距离其被使用的地方越远，则需要携带更多的上下文信息。</p>
<p>全局变量在其名字中需要更多的上下文信息，使得在不同的地方可以轻易辨认出其含义</p>
</li>
<li>
<p>几乎不影响理解的变量名变动，选择最简介的名称即可。</p>
</li>
<li>
<p>具有特定含义的变量名变动，选择意义最贴切的名称即可。</p>
</li>
</ul>
<p><strong>function</strong></p>
<ul>
<li>
<p>函数名不携带包名的上下文信息，因为包名和函数名总是成对出现</p>
<p>例如，使用time.Now()而不是time.NowTime()。</p>
</li>
<li>
<p>函数名尽量简短</p>
</li>
<li>
<p>当名为foo的包某个函数返回类型为Foo时，可以省略类型信息避免歧义</p>
</li>
<li>
<p>当名为foo的包某个函数返回类型为T时（T不是Foo），可以在函数名中加入类型信息</p>
<p>例如，parseInt</p>
</li>
</ul>
<p><strong>package</strong></p>
<ul>
<li>只由小写字母组成，不能包含大写字母和下划线等字符</li>
<li>简短并包含一定的上下文信息。例如schema</li>
<li>不要与标准库同名。例如不要使用sync或者strings</li>
</ul>
<p>以标准库包名为例</p>
<ul>
<li>不使用常用的变量名作为包名。例如使用bufio而不是buf</li>
<li>使用单数而不是复数。例如使用encoding而不是encodings</li>
<li>谨慎地使用缩写。例如使用fmt在不破坏上下文的情况下比format更加简短</li>
</ul>
<p><strong>小结</strong></p>
<ul>
<li>核心目标是降低阅读理解代码的成本</li>
<li>重点考虑上下文信息，设计简洁清晰的名称</li>
</ul>
<h4 id="124-控制流程"><a class="markdownIt-Anchor" href="#124-控制流程"></a> 1.2.4 控制流程</h4>
<p>流程控制经常用到的就是if else这种条件控制语句。</p>
<p><strong>避免嵌套，保持正常流程清晰</strong></p>
<p>一个简单的if else，如果两个分支都包含return语句，则可以去除冗余的else，方便后续维护。else一般就是表示正常流程，如果需要在正常流程中新增判断逻辑，则去除else可以避免分支嵌套。</p>
<p><strong>尽量保持正常代码路径为最小缩进</strong></p>
<ul>
<li>
<p>优先处理错误情况或特殊情况，尽早返回或继续循环来减少嵌套。</p>
<p>例如，使用<code>err != nil</code>而不是<code>err == nil</code>就是为了优先处理错误情况。</p>
</li>
</ul>
<p><strong>小结</strong></p>
<ul>
<li>线性原理，处理逻辑尽量走直线，避免复杂的嵌套分支</li>
<li>正常流程代码沿着屏幕向下移动</li>
<li>提升代码的可维护性和可读性</li>
<li>故障问题大多出现在复杂的条件语句和循环语句中</li>
</ul>
<h4 id="125-错误和异常处理"><a class="markdownIt-Anchor" href="#125-错误和异常处理"></a> 1.2.5 错误和异常处理</h4>
<p><strong>简单错误</strong></p>
<ul>
<li>简单的错误指的是仅出现一次的错误，且在其他地方不需要捕获该错误</li>
<li>优先使用errors.New来创建匿名变量直接表示简单错误</li>
<li>如果需要格式化错误信息，使用fmt.Errorf</li>
</ul>
<p><strong>错误的Wrap和Unwarp</strong></p>
<ul>
<li>错误的Wrap实际上是提供了一个error嵌套另一个error的能力，从而形成一个error的跟踪链</li>
<li>在fmt.Errorf中使用%w占位符来将一个错误关联至错误跟踪链中</li>
</ul>
<p><strong>错误判定</strong></p>
<ul>
<li>判断一个错误是否为特定错误，<a target="_blank" rel="noopener" href="http://xn--errors-vt9i248w.Is">使用errors.Is</a></li>
<li>不同于使用==，使用该方法可以判断错误链上的所有错误中是否含有特定的错误</li>
<li>在错误链上获取特定种类的错误，<a target="_blank" rel="noopener" href="http://xn--errors-vt9i248w.As">使用errors.As</a>。与errors.Is不同的是As会取出调用链中指定类型的错误，并将错误赋值给定义好的变量，方便后续处理</li>
</ul>
<p><strong>panic</strong></p>
<p>panic比错误更加严重，它的出现表示程序无法正常工作。</p>
<ul>
<li>不建议在业务代码中使用panic</li>
<li>panic发生后会向上传播至调用栈顶，如果当前goroutine中所有deferred函数都不包含recover就会造成整个程序崩溃</li>
<li>若问题可以被屏蔽或解决，建议使用error代替panic</li>
<li>特殊地，当程序启动阶段发生不可逆的错误时，可以在init或main函数中使用panic</li>
</ul>
<p><strong>recover</strong></p>
<p>panic的产生并不只在程序运行阶段。如果是引入其他库时产生的bug而导致的panic就需要使用recover。</p>
<p>注意recover的生效条件</p>
<ul>
<li>recover只能在被defer的函数中使用</li>
<li>在嵌套中无法生效</li>
<li>只在当前goroutine生效</li>
<li>defer的语句是先进后出</li>
</ul>
<p>如果需要更多的上下文信息，可以在recover后用log记录当前调用的栈，方便分析定位。</p>
<p><strong>小结</strong></p>
<ul>
<li>error尽可能提供简明的上下文信息链，方便定位问题</li>
<li>panic用于真正异常的情况，无法规避</li>
<li>recover生效范围，在当前goroutine的deferred函数中生效</li>
</ul>
<h3 id="13-性能优化建议"><a class="markdownIt-Anchor" href="#13-性能优化建议"></a> 1.3 性能优化建议</h3>
<p><strong>简介</strong></p>
<ul>
<li>性能优化的前提是满足正确可靠、简洁清晰等质量因素</li>
<li>性能优化是综合评估，时间效率和空间效率可能在某些情况下不能兼得</li>
<li>针对Go语言特性来介绍Go相关的性能优化建议</li>
</ul>
<h4 id="131-benchmark"><a class="markdownIt-Anchor" href="#131-benchmark"></a> 1.3.1 Benchmark</h4>
<p><strong>如何使用</strong></p>
<ul>
<li>性能表现需要实际数据衡量</li>
<li>Go语言提供了支持基准性能测试的benchmark工具</li>
</ul>
<p>通过以下命令进行性能测试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go <span class="built_in">test</span> -bench=. -benchmem</span><br></pre></td></tr></table></figure>
<p><strong>结果说明</strong></p>
<ul>
<li>第一个参数如BenchmarkFib10-8对应被测试函数的名称，-8表示GOMAXPROCS的值为8</li>
<li>第二个参数如1855870表示一共执行1855870次，即b.N的值</li>
<li>第三个参数如602.5ns/op表示每次执行花费602.5ns</li>
<li>第四个参数如0B/op表示每次执行时申请的内存空间大小</li>
<li>第五个参数如0allocs/op表示每次执行时申请内存的次数</li>
</ul>
<h4 id="132-slice"><a class="markdownIt-Anchor" href="#132-slice"></a> 1.3.2 Slice</h4>
<p><strong>slice预分配内存</strong></p>
<ul>
<li>
<p>尽可能在使用make()初始化切片时提供容量信息</p>
</li>
<li>
<p>切片本质是一个数组片段的描述，包括数组指针、片段的长度、片段的容量（不改变内存分配情况下的最大长度）</p>
</li>
<li>
<p>切片操作并不复制切片指向的元素</p>
</li>
<li>
<p>而是创建一个新的切片复用原来切片的底层数组</p>
<p>以切片的append为例，append时有两种场景：</p>
<p>当append之后的长度小于等于容量，将会直接利用原底层数组剩余的空间。</p>
<p>当append之后的长度大于容量，则会分配一块更大的区域来容纳新的底层数组。</p>
</li>
</ul>
<p>因此，为了避免内存发生拷贝，如果能够明确最终的切片的大小，预先设置容量的值能够避免额外的内存分配，获得更好的性能。</p>
<p><strong>大内存未释放问题</strong></p>
<p>原切片由大量的元素构成，在原切片的基础上创建切片只使用了很小一段，但底层数组在内存中仍占据着大量空间，无法释放。</p>
<ul>
<li>在已有切片的基础上创建切片，不会创建新的底层数组</li>
<li>可以使用copy代替re-slice，因为通过copy会指向一个新的底层数组，原来的底层数组不再被引用之后，内存就会被回收。</li>
</ul>
<h4 id="133-map"><a class="markdownIt-Anchor" href="#133-map"></a> 1.3.3 Map</h4>
<p><strong>map预分配内存</strong></p>
<p>原理</p>
<ul>
<li>不断向map中添加元素的操作会触发map的扩容</li>
<li>提前分配好空间可以减少内存拷贝和Rehash的消耗</li>
<li>建议根据实际需求提前预估好需要的空间</li>
</ul>
<h4 id="134-字符串处理"><a class="markdownIt-Anchor" href="#134-字符串处理"></a> 1.3.4 字符串处理</h4>
<p><strong>使用strings.Builder</strong></p>
<ul>
<li>
<p>常见的字符串拼接方式就是使用+号直接拼接或者使用strings.Builder的方法拼接以及bytes.Buffer的方法拼接</p>
</li>
<li>
<p>使用+号拼接性能最差，strings.Builder和bytes.Buffer性能相近，strings.Builder更快。</p>
<p>当使用+拼接两个字符串时，生成一个新的字符串，那么就需要开辟一段新的空间，新空间的大小是原来两个字符串的大小之和。拼接第三个字符串时，再开辟一段新空间，新空间大小是三个字符串大小之和，以此类推。</p>
</li>
<li>
<p>分析</p>
<ul>
<li>字符串在Go语言中是不可变类型，占用内存大小是固定的</li>
<li>使用+每次都会重新分配内存</li>
<li>strings.Builder和bytes.Buffer底层都是[]byte数组</li>
<li>Builder和Buffer的内存扩容策略，不需要每次拼接重新分配内存</li>
</ul>
</li>
<li>
<p>Builder比Buffer快的原因</p>
<ul>
<li>bytes.Buffer转化为字符串时重新申请了一块空间</li>
<li>strings.Builder直接将底层的[]byte转换成了字符串类型返回</li>
</ul>
</li>
<li>
<p>在已知字符串长度的情况下，进一步提升Builder的拼接性能，使用预分配减少分配次数。优化后的Builder只需要一次内存分配，而优化后的Buffer有两次。</p>
</li>
</ul>
<h4 id="135-空结构体"><a class="markdownIt-Anchor" href="#135-空结构体"></a> 1.3.5 空结构体</h4>
<p><strong>使用空结构体节省内存</strong></p>
<ul>
<li>
<p>空结构体struct{}实例不占据任何内存空间</p>
</li>
<li>
<p>可做为各种场景下的占位符使用</p>
<ul>
<li>节省资源</li>
<li>空结构体本身具备很强的语义，不需要任何值就能作为占位符</li>
</ul>
</li>
<li>
<p>Set方法的实现，可以考虑用map来代替</p>
</li>
<li>
<p>对于这个场景，只需要用到map的键，不需要值</p>
</li>
<li>
<p>即使是将map的值设置为bool类型，也会多占据1个字节空</p>
<p>一个开源实现<a target="_blank" rel="noopener" href="https://github.com/deckarep/golang-set/blob/main/threadunsafe.go">golang-set/threadunsafe.go</a>。</p>
</li>
</ul>
<h4 id="136-atomic包"><a class="markdownIt-Anchor" href="#136-atomic包"></a> 1.3.6 atomic包</h4>
<p>多线程编程场景下性能优化，保证线程安全。</p>
<p><strong>如何使用atomic包</strong></p>
<ul>
<li>锁的实现是通过操作系统来实现，属于系统调用</li>
<li>atomic操作是通过硬件实现，效率比锁高</li>
<li>sync.Mutex应该用来保护一段逻辑，不仅仅用于保护一个变量</li>
<li>对于非数值操作，可以使用atomic.Value，能承载一个interface{}</li>
</ul>
<h4 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h4>
<ul>
<li>避免常见的性能陷阱可以保证大部分程序的性能</li>
<li>普通应用代码，不要一味地追求程序的性能</li>
<li>越高级的性能优化手段越容易出现问题</li>
<li>在满足正确可靠、简洁清晰的质量要求的前提下提高程序性能</li>
</ul>
<h3 id="2性能调优实战"><a class="markdownIt-Anchor" href="#2性能调优实战"></a> 2.性能调优实战</h3>
<h3 id="21-简介"><a class="markdownIt-Anchor" href="#21-简介"></a> 2.1 简介</h3>
<p><strong>性能调优原则</strong></p>
<ul>
<li>要依靠数据而不是猜测</li>
<li>要定位最大瓶颈而不是细枝末节</li>
<li>不要过早优化</li>
<li>不要过度优化</li>
</ul>
<h3 id="22-性能分析工具-pprof"><a class="markdownIt-Anchor" href="#22-性能分析工具-pprof"></a> 2.2 性能分析工具 pprof</h3>
<p><strong>说明</strong></p>
<p>如果想知道应用在什么地方耗费了多少CPU、Memory。对于go程序有一个很方便的工具——pprof</p>
<h4 id="221-功能简介"><a class="markdownIt-Anchor" href="#221-功能简介"></a> 2.2.1 功能简介</h4>
<p>pprof是用于可视化和分析性能分析数据的工具</p>
<ul>
<li>分析-Profile：网页、可视化终端</li>
<li>工具-Tool：runtime/pprof、net/http/pprof</li>
<li>采样-Sample：CPU、堆内存-Heap、协程-Goroutine、锁-Mutex、阻塞-Block、线程创建-ThreadCreate</li>
<li>展示-View：Top、调用图-Graph、火焰图-FlameGraph、Peek、源码-Source、反汇编-Disassemble</li>
</ul>
<h4 id="222-排查实战"><a class="markdownIt-Anchor" href="#222-排查实战"></a> 2.2.2 排查实战</h4>
<p><strong>搭建pprof实践项目</strong></p>
<ul>
<li>
<p>项目地址<a target="_blank" rel="noopener" href="https://github.com/wolfogre/go-pprof-practice">wolfogre/go-pprof-practice: go pprof practice.</a></p>
</li>
<li>
<p>该项目提前埋入了炸弹代码，能产生可观测的性能问题。windows可用任务管理器查看内存占用情况，启动项目前确保内存足够。</p>
</li>
<li>
<p>项目中引入了net/http/pprof包，在启动项目后可以通过浏览器访问pprof工具</p>
<p>main函数部分代码说明</p>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line">runtime.GOMAXPROCS(<span class="number">1</span>)              <span class="comment">//限制CPU使用数</span></span><br><span class="line">runtime.SetMutexProfileFraction(<span class="number">1</span>) <span class="comment">//开启锁调用跟踪</span></span><br><span class="line">runtime.SetBlockProfileRate(<span class="number">1</span>)     <span class="comment">//开启阻塞调用跟踪</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 启动 http server</span></span><br><span class="line">    <span class="keyword">if</span> err := http.ListenAndServe(<span class="string">&quot;:6060&quot;</span>, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line">    os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>浏览器查看指标</strong></p>
<p>在项目启动成功后，访问http://localhost:6060/debug/pprof，可以看到pprof的计数页面。</p>
<p>页面上展示了可用的程序运行采样数据，分别是</p>
<ul>
<li>allocs:内存分配情况</li>
<li>blocks:阻塞操作情况</li>
<li>cmdline:程序启动命令及其参数</li>
<li>goroutine:当前所有协程的堆栈信息</li>
<li>heap:堆上内存使用情况</li>
<li>mutex:锁竞争操作情况</li>
<li>profile:CPU占用情况</li>
<li>threadcreate:当前所有常见的系统线程的堆栈信息</li>
<li>trace:程序运行跟踪情况</li>
</ul>
<p>cmdline可以显式运行进程的命令，找到问题来源的程序。threadcreate比较复杂，不透明。trace需要配合另外的工具解析，这里暂不深入。</p>
<p>炸弹主要在CPU、堆内存、goroutine、锁竞争和阻塞操作上，可以通过pprof工具分析</p>
<p><strong>CPU</strong></p>
<p>使用操作系统自带的工具查看CPU占用，发现该项目程序的异常占用。</p>
<p>pprof的采样结果是将一段时间内的信息汇总输出到文件中，所以需要获取这个profile文件。可以直接使用暴露的接口链接下载文件后使用，也可以直接用pprof工具连接这个接口下载需要的数据。</p>
<p>使用go tool pprof + 采样链接的命令来启动采样，例如</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go tool pprof <span class="string">&quot;http://localhost:6060/debug/pprof/profile?seconds=10&quot;</span></span><br></pre></td></tr></table></figure>
<p>链接就是刚刚炸弹程序暴露出来的接口，链接结尾的profile代表采样的对象是CPU使用。如果在浏览器里直接打开链接会启动一个60秒的采样并在采样结束后下载文件到本地。这里加上seconds=10的参数，指定采样时间为10秒。文件下载保存的路径会在pprof终端展示。</p>
<p>pprof终端命令</p>
<ul>
<li>
<p>top命令用于查看占用资源最多的函数。top有以下参数指标</p>
<ul>
<li>
<p>flat:当前函数本身的执行耗时</p>
</li>
<li>
<p>flat%:flat占CPU总时间的比例</p>
</li>
<li>
<p>sum%:上面每一行flat%的总和</p>
</li>
<li>
<p>cum:指当前函数本身加上其调用函数的总耗时</p>
</li>
<li>
<p>cum%:cum占CPU总时间的比例</p>
</li>
</ul>
<p>默认展示资源占用最高的10个函数，如果只需要查看占用最高的N个函数，在top命令后加上一个数字N即可。</p>
<p>flat=cum的函数说明该函数没有调用其他函数</p>
<p>flat=0的函数说明该函数只有其他函数的调用</p>
<hr />
</li>
<li>
<p>list命令会根据给出的正则表达式查找代码，并按行展示出每一行的占用</p>
<p>例如，在pprof终端输入list Eat，就能查看Eat函数每行的占用情况。这样就能定位到具体的代码。</p>
<hr />
</li>
<li>
<p>web命令可以生成一张调用关系图，默认通过浏览器打开。该命令需要提前安装Graphviz并配置环境变量才能使用。官网下载<a target="_blank" rel="noopener" href="https://graphviz.org/download/">Download | Graphviz</a></p>
<p>图中除了每个节点的资源占用以外，还会将它们的调用关系描述出来。资源占用最高的函数会比较明显地展示出来。</p>
</li>
</ul>
<p>退出pprof终端，输入q回车即可。将炸弹程序直接注释。</p>
<p><strong>Heap-堆内存</strong></p>
<p>注释问题代码后，重新启动项目。用系统工具（windows是任务管理器）查看CPU占用，可以发现进程的占用已经降下来了。但还有内存占用问题，接下来排查内存问题。</p>
<p>上面排查CPU问题时使用的是pprof终端，这里使用另一种展示方式，通过<code>-http=:8080</code>参数，开启pprof自带的web UI，以网页的形式来呈现性能指标。注意链接结尾是heap</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go tool pprof -http=:8080 <span class="string">&quot;http://localhost:6060/debug/pprof/heap&quot;</span></span><br></pre></td></tr></table></figure>
<p>通过上面的命令启动pprof工具后，在采样完成后会自动打开浏览器，展示出web视图，同时展示的资源使用从CPU时间变成了内存占用。</p>
<p>通过页面顶端的View菜单可以切换不同的视图，初始默认是Graph视图。Top视图就类似于终端top命令的展示效果，Source视图就类似于终端list命令的展示效果。通过这些视图可以快速定位问题，注释掉问题代码，拆除第二个炸弹。</p>
<p>重新运行项目，查看内存占用，发现内存占用也大幅下降。但实际上前面解决的内存问题只是堆内存采样的四种指标之一的inuse_space。四种指标如下</p>
<ul>
<li>alloc_objects:程序累计申请的对象数</li>
<li>alloc_space:程序累计申请的内存大小</li>
<li>inuse_objects:程序当前持有的对象数</li>
<li>inuse_space:程序当前占用的内存大小</li>
</ul>
<p>默认展示视图就是inuse_space视图，只展示当前持有的内存，但对于已经释放的内存，inuse采样不会进行展示。通过页面顶端的Sample菜单切换到alloc_space指标，分析alloc的内存问题。定位到问题代码，注释掉。至此，内存部分炸弹已经被全部清理。</p>
<p><strong>goroutine协程</strong></p>
<p>Golang是一门自带垃圾回收的语言，一般情况下内存泄露是没那么容易发生的。但是有一种例外，goroutine是很容易泄露的，进而导致内存泄露。接下来运行项目，分析goroutine使用情况。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go tool pprof -http=:8080 <span class="string">&quot;http://localhost:6060/debug/pprof/goroutine&quot;</span></span><br></pre></td></tr></table></figure>
<p>goroutine使用默认视图不方便分析，可以切换到Flame Graph火焰图更加直观。</p>
<p>火焰图的展示</p>
<ul>
<li>由上到下表示调用顺序，展示了各个函数调用之间的层级关系</li>
<li>每一行代表一个函数，条形越长代表占用的资源越多</li>
<li>火焰图是动态的，支持点击块进行分析</li>
</ul>
<p>火焰图是非常常用的性能分析工具，在程序逻辑复杂的情况下很有用。</p>
<p>切换到Source视图，在该视图下搜索火焰图中占用最高的函数名称。定位到问题代码，注释掉。重新启动访问pprof可以发现goroutine已下降到正常水平。</p>
<p><strong>mutex-锁</strong></p>
<p>启动pprof工具</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go tool pprof -http=:8080 <span class="string">&quot;http://localhost:6060/debug/pprof/mutex&quot;</span></span><br></pre></td></tr></table></figure>
<p>观察web视图，分析锁操作，切换到Source视图定位到具体代码，注释掉。</p>
<p><strong>block-阻塞</strong></p>
<p>在程序中，除了锁的竞争会导致阻塞以外，还有很多逻辑(例如读取一个channel)也会导致阻塞。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">go tool pprof -http=:8080 <span class="string">&quot;http://localhost:6060/debug/pprof/block&quot;</span></span><br></pre></td></tr></table></figure>
<p>同理在Graph视图中定位到问题函数后，切换到Source视图定位到问题代码，注释掉。</p>
<p>但实际上，该示例项目在之前的计数页面上存在两个阻塞，上面只解决了其中一个阻塞。只展示了一个阻塞，是因为另一个阻塞操作的节点总用时小于总时长的千分之五而被省略掉。这是pprof的过滤策略，能够更加有效地突出重点问题信息，而省略相对没有问题的信息。如果没有过滤策略的话，对于一个复杂的程序，大量无关紧要的内容都会展示出来，不利于定位问题。</p>
<p>第二个阻塞操作，尽管不会在pprof工具中展示出来，但也会被pprof记录下来，可以通过暴露出来的接口地址http://localhost:6060/debug/pprof中的block链接直接访问。通过访问可以得知这个阻塞操作是符合预期的正常操作。</p>
<p><strong>小结</strong></p>
<ul>
<li>五种使用pprof采集的常用性能指标: CPU、堆内存、Goroutine、 锁竞争和阻塞;</li>
<li>两种展示方式:交互式终端和网页;</li>
<li>四种视图: Top、 Graph、 源码和火焰图。</li>
<li>pprof除了http的获取方式之外，也可以直接在运行时调用runtime/pprof包将指标数据输出到本地文件。</li>
<li>视图中还有一个更底层的「反汇编」视图。感兴趣的话可自行尝试。</li>
</ul>
<h4 id="223-pprof的采样过程和原理"><a class="markdownIt-Anchor" href="#223-pprof的采样过程和原理"></a> 2.2.3 pprof的采样过程和原理</h4>
<p><strong>CPU</strong></p>
<ul>
<li>采样对象：所有函数调用栈和它们的占用时间</li>
<li>采样率：100次/秒，固定值</li>
<li>采样时间：从手动启动到手动结束</li>
</ul>
<p>这个定时机制在unix或类unix系统上是依赖信号机制实现的。每次暂停都会接收到一个信号，通过系统计时器来保证这个信息是固定频率发送的。</p>
<p>开始采样——&gt;设定信号处理函数——&gt;开启定时器</p>
<p>停止采样——&gt;取消信号处理函数——&gt;关闭定时器</p>
<p>一共有三个相关角色：进程本身、操作系统和写缓冲。启动采样时，进程向OS注册一个定时器</p>
<ul>
<li>
<p>操作系统每10ms向进程发送一次SIGPROF信号</p>
</li>
<li>
<p>进程每次接收到SIGPROF信号后就会对当前的调用堆栈进行记录</p>
</li>
<li>
<p>与此同时，进程会启动一个写缓冲的goroutine，每隔100ms从进程中读取已经记录的堆栈信息，并写入到输出流。</p>
</li>
</ul>
<p>当采样停止时，进程向OS取消定时器，不再接收信号，写缓冲读取不到新的堆栈时，结束输出。</p>
<p><strong>Heap-堆内存</strong></p>
<p>pprof的内存采样是有局限性的，内存采样在实现上依赖了内存分配器的记录，所以只能记录在堆上分配且参与GC的内存，一些其他的内存分配，例如调用结束就会回收的栈内存、一些更底层使用cgo调用分配的内存，是不会被内存采样记录的。</p>
<ul>
<li>采样程序通过内存分配器记录在堆上分配和释放的内存，记录分配和释放的大小和数量</li>
<li>采样率：每分配512KB记录一次，可在运行开头修改，设置为1则表示每次分配都会记录</li>
<li>采样时间：从程序运行开始到获取采样结果时</li>
<li>采样指标：alloc_space, alloc_objects, inuse_space, inuse_objects。</li>
<li>计算方式：inuse = alloc - free</li>
</ul>
<p><strong>Goroutine-协程和ThreadCreate-线程创建</strong></p>
<p>goroutine和threadcreate这两个采样指标在概念上和实现上都比较相似。</p>
<ul>
<li>
<p>Goroutine</p>
<p>记录所有用户发起且在运行中的goroutine（即入口非runtime开头的）以及runtime.main函数中的调用栈信息</p>
<p>Stop The World——&gt;遍历allg切片——&gt;输出创建g的堆栈——&gt;Start The World</p>
</li>
<li>
<p>ThreadCreate</p>
<p>记录程序创建的所有系统线程的信息</p>
<p>Stop The World——&gt;遍历allm切片——&gt;输出创建m的堆栈——&gt;Start The World</p>
</li>
<li>
<p>它们在实现上非常相似，都是在Stop The World之后遍历所有goroutine/所有线程的列表(上面的m就是 GMP模型中的m,在golang中和线程一一对应）并输出堆栈，最后Start The World继续运行。这个采样是立刻触发的全量记录，可以通过比较两个时间点的差值来得到某一时间段的指标。</p>
</li>
</ul>
<p><strong>Block-阻塞和Mutex-锁</strong></p>
<p>阻塞和锁竞争这两种采样指标在流程和原理上也非常相似，这两个采样记录的都是对应操作发生的调用栈、次数和耗时，不过这两个指标的采样率含义并不相同。</p>
<ul>
<li>阻塞操作
<ul>
<li>采样阻塞操作的次数和耗时</li>
<li>采样率：阻塞耗时超过阈值时间的阻塞操作才会被记录，设置运行参数为1表示每次操作都会记录。</li>
</ul>
</li>
<li>锁竞争
<ul>
<li>采样争抢锁的次数和耗时</li>
<li>采样率：只记录固定比例的锁操作，设置运行参数为1表示每次加锁都会记录。</li>
</ul>
</li>
<li>它们在实现上也是基本相同的，都是一个「主动上报」的过程
<ul>
<li>在阻塞操作或锁操作发生时，会计算出消耗的时间，连同调用栈一起主动上报给采样器，采样器会根据采样率可能会丢弃一些记录。 例如时间未达阈值或者比例未命中。</li>
<li>在采样时，采样器会遍历已经记录的信息，统计出具体操作的次数、调用栈和总耗时。和堆内存一样， 可以对比两个时间点的差值计算出这段时间内的操作指标。</li>
</ul>
</li>
</ul>
<h4 id="小结-2"><a class="markdownIt-Anchor" href="#小结-2"></a> 小结</h4>
<ul>
<li>掌握常用pprof工具功能</li>
<li>灵活运用pprof工具分析解决性能问题</li>
<li>了解pprof的采样过程和工作原理</li>
</ul>
<h3 id="23-性能调优案例"><a class="markdownIt-Anchor" href="#23-性能调优案例"></a> 2.3 性能调优案例</h3>
<p><strong>简介</strong></p>
<p>介绍实际业务服务性能优化的案例。对逻辑相对复杂的程序进行性能调优。</p>
<ul>
<li>
<p>业务服务优化</p>
<p>业务服务一般指直接提供功能的服务，比如用户评论系统</p>
</li>
<li>
<p>基础库优化</p>
<p>基础库一般指提供通用功能的程序，主要是针对业务服务提供功能，比如监控组件，用于收集业务服务的运行指标</p>
</li>
<li>
<p>Go语言优化</p>
<p>对Go语言本身进行的优化项</p>
</li>
</ul>
<h4 id="231-业务服务优化"><a class="markdownIt-Anchor" href="#231-业务服务优化"></a> 2.3.1 业务服务优化</h4>
<p><strong>基本概念</strong></p>
<ul>
<li>服务：能单独部署，承载一定功能的程序</li>
<li>依赖：Service A的功能实现依赖Service B的响应结果，称为Service A依赖Service B</li>
<li>调用链路：能支持一个接口请求的相关服务集合及其相互之间的依赖关系</li>
<li>基础库：公共的工具包、中间件</li>
</ul>
<p><strong>流程</strong></p>
<ul>
<li>建立服务性能评估手段。</li>
<li>分析性能数据，定位性能瓶颈。用pprof采样性能数据、分析服务。</li>
<li>重点优化项改造。重构代码、使用更高效的组件等。</li>
<li>优化效果验证。通过压测对比和正确性验证之后，上线服务进行实际收益评估。</li>
</ul>
<p><strong>建立服务性能评估手段</strong></p>
<ul>
<li>服务性能评估方式
<ul>
<li>单独的benchmark无法满足复杂逻辑分析</li>
<li>不同负载情况下性能表现有所差异</li>
</ul>
</li>
<li>请求流量构造
<ul>
<li>不同请求参数覆盖逻辑不同</li>
<li>线上真实流量情况</li>
</ul>
</li>
<li>压测范围
<ul>
<li>单机压测</li>
<li>集群压测</li>
</ul>
</li>
<li>性能数据采集
<ul>
<li>单机性能数据</li>
<li>集群性能数据</li>
</ul>
</li>
</ul>
<p>最后表现为一个服务的性能指标分析报告</p>
<p><strong>分析性能数据，定位性能瓶颈</strong></p>
<p>常见性能问题</p>
<ul>
<li>
<p>使用库不规范</p>
<ul>
<li>基础组件不规范，一般是代码编写逻辑问题，比如提供了缓存机制，但是代码中没有开启。</li>
<li>日志使用不规范，一般是线上服务环境导致某一调用链路数据量剧增，日志量随之剧增，影响性能。</li>
</ul>
</li>
<li>
<p>高并发场景优化不足</p>
<p>例如同步请求造成的性能瓶颈，影响到了业务逻辑处理，后续可改造成异步请求提升性能。</p>
</li>
</ul>
<p><strong>重点优化项改造</strong></p>
<ul>
<li>
<p>性能优化的前提是保证正确性，在变动较大的性能优化上线之前，还需要进行正确性验证。由于线上的场景和流程太多，所以一般会借助自动化手段来保证优化后程序的正确性。</p>
</li>
<li>
<p>响应数据diff</p>
<ul>
<li>
<p>线上请求数据录制回放</p>
<p>不仅包含请求参数录制，还有线上的返回内容录制</p>
</li>
<li>
<p>新旧逻辑接口数据diff</p>
<p>重放时对比线上的返回内容和优化后服务的返回内容进行正确性验证</p>
</li>
</ul>
</li>
</ul>
<p><strong>优化效果验证</strong></p>
<ul>
<li>重复压测验证</li>
<li>上线评估优化效果
<ul>
<li>关注服务监控</li>
<li>逐步放量</li>
<li>收集性能数据</li>
</ul>
</li>
</ul>
<p>压测并不能保证和线上表现完全一致，有时还要通过线上的表现再进行分析改进，是个长期的过程。</p>
<p><strong>进一步优化，服务整体链路分析</strong></p>
<ul>
<li>规范上游服务调用接口，明确场景需求</li>
<li>分析链路，通过业务流程优化提升服务性能</li>
</ul>
<h4 id="232-基础库优化"><a class="markdownIt-Anchor" href="#232-基础库优化"></a> 2.3.2 基础库优化</h4>
<p><strong>AB实验SDK的优化</strong></p>
<blockquote>
<p>A/B测试（也称为<strong>分割测试</strong>或<strong>桶测试</strong>）是一种将网页或应用程序的两个版本相互比较以确定哪个版本的性能更好的方法。AB测试本质上是一个实验，其中页面的两个或多个变体随机显示给用户，统计分析确定哪个变体对于给定的转换目标（指标如CTR）效果更好。</p>
</blockquote>
<ul>
<li>分析基础库核心逻辑和性能瓶颈
<ul>
<li>设计完善改造方案</li>
<li>数据按需获取</li>
<li>数据序列化协议优化</li>
</ul>
</li>
<li>内部压测验证</li>
<li>推广业务服务落地验证</li>
</ul>
<h4 id="233-go语言优化"><a class="markdownIt-Anchor" href="#233-go语言优化"></a> 2.3.3 Go语言优化</h4>
<p><strong>编译器和运行时优化</strong></p>
<ul>
<li>优化内存分配策略</li>
<li>优化代码编译流程，生成更高效的程序</li>
<li>内部压测验证</li>
<li>推广业务服务落地验证</li>
</ul>
<p>优点</p>
<ul>
<li>接入简单，只需要调整编译配置</li>
<li>通用性强</li>
</ul>
<h3 id="24-总结"><a class="markdownIt-Anchor" href="#24-总结"></a> 2.4 总结</h3>
<ul>
<li>性能调优原则
<ul>
<li>要依靠数据而不是猜测</li>
</ul>
</li>
<li>性能分析工具pprof
<ul>
<li>熟练使用pprof工具排查性能问题并了解其基本原理</li>
</ul>
</li>
<li>性能调优
<ul>
<li>保证正确性</li>
<li>定位主要瓶颈</li>
</ul>
</li>
</ul>
<h2 id="参考资料"><a class="markdownIt-Anchor" href="#参考资料"></a> 参考资料</h2>
<p><a target="_blank" rel="noopener" href="https://go.dev/doc/tutorial/add-a-test">Add a test - The Go Programming Language</a></p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/testing#hdr-Benchmarks">testing package - testing - Go Packages</a></p>
<p><a target="_blank" rel="noopener" href="https://geektutu.com/post/hpg-slice.html">切片(slice)性能及陷阱 | Go 语言高性能编程 | 极客兔兔 </a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1496302">什么是A/B test？有哪些流程？有什么用？ - 腾讯云开发者社区-腾讯云</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>Entropy
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="https://s-chance.github.io/2023/01/28/golang-day3/" title="Go 高质量编程与性能调优">https://s-chance.github.io/2023/01/28/golang-day3/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag"><i class="fa fa-tag"></i> 学习笔记</a>
              <a href="/tags/golang/" rel="tag"><i class="fa fa-tag"></i> golang</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/01/26/golang-day2/" rel="prev" title="Go 工程进阶">
                  <i class="fa fa-chevron-left"></i> Go 工程进阶
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/01/30/golang-day4/" rel="next" title="Go 语言内存管理详解">
                  Go 语言内存管理详解 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments" id="waline"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 2022 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Entropy</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
      <span>站点总字数：</span>
    <span title="站点总字数">212k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span>站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">3:13</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css" integrity="sha256-gMRN4/6qeELzO1wbFa8qQLU8kfuF2dnAPiUoI0ATjx8=" crossorigin="anonymous">


<script class="next-config" data-name="waline" type="application/json">{"lang":"zh-cn","enable":true,"serverURL":"https://waline-hexo-nu.vercel.app/","cssUrl":"https://unpkg.com/@waline/client@v2/dist/waline.css","commentCount":true,"pageview":false,"placeholder":"请评论","avatar":"mm","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":["nick"],"el":"#waline","comment":true,"libUrl":"//unpkg.com/@waline/client@v2/dist/waline.js","path":"/2023/01/28/golang-day3/"}</script>
<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css">
<script>
document.addEventListener('page:loaded', () => {
  NexT.utils.loadComments(CONFIG.waline.el).then(() =>
    NexT.utils.getScript(CONFIG.waline.libUrl, { condition: window.Waline })
  ).then(() => 
    Waline.init(Object.assign({}, CONFIG.waline,{ el: document.querySelector(CONFIG.waline.el) }))
  );
});
</script>

</body>
</html>
